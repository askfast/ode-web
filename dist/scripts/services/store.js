define(["services/services"],function(e){e.factory("Store",["$window","$parse",function(e,t){return function(n,r){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;return c=function(e){try{return h(e)}catch(t){return null}},i=function(e){return new Lawnchair({name:n},e)},v=function(t,n){var r;n=n.toString(),angular.isObject(t)&&t!==f[n]?(f[n]=f[n]||{},angular.extend(f[n],t)):f[n]=t,r={key:n,value:g(f[n])};try{i(function(){this.save(r)})}catch(s){(s.name==="QUOTA_EXCEEDED_ERR"||s.name==="NS_ERROR_DOM_QUOTA_REACHED")&&e.localStorage.clear()}},y=function(e){return a.length=0,_.each(e,function(e){a.push(e)}),a},b=function(e,t){e&&angular.isObject(e)&&f[t]&&f[t]!==e?angular.extend(f[t],e):f[t]=e},w=function(e,t){return t&&(angular.isObject(t.value)&&angular.isObject(e)?angular.extend(e,m(t.value)):e=m(t.value),b(e,t.key)),e},u=function(e){return i(function(){this.all(function(t){_.each(t,function(e){b(e.value,e.key)}),e&&e(f)})}),f},o=function(e){return y(u(function(t){y(t),e&&e(a)}))},d=function(e){delete f[e],i(function(){this.remove(e)})},l=function(e){var t;return f[e]?f[e]:(t={},h.assign(t,e),t)},f={},a=[],p=r&&r.isArray,h=t(r&&r.entryKey?r.entryKey:"id"),g=r&&r.transformSave?r.transformSave:angular.identity,m=r&&r.transformLoad?r.transformLoad:angular.identity,s={collection:f,save:function(e,t,n){var r;t||(t=f,e=null),e&&v(t,e||c(t)),n&&(r=angular.isArray(t)?_.chain(t).map(c).map(String).value():_.keys(t),_.chain(f).keys().difference(r).each(d),_.chain(f).filter(function(e){return!c(e)}).keys().each(d))},batch:function(e,t,n){var r;return r=_.chain(e).map(function(e){return l(e)}).value(),t&&angular.isArray(t)?(t.length=0,_.each(r,function(e){t.push(e)})):t=r,i(function(){this.get(e,function(e){var r;if(e){r=e.length-1;while(r>=0)t[r]=w(t[r],e[r]),r--}n&&n(t)})}),t},has:function(e,t){i(function(){this.exists(e,function(e){t(e)})})},get:function(e,t){var n;return n=l(e),i(function(){this.get(e,function(e){e&&(n=w(n,e)),n.hasOwnProperty("0")&&(n=_.map(n,function(e){return e}),n.pop()),t&&t(n)})}),n},nuke:function(){i(function(){this.nuke()})},all:p?o:u,remove:d,destroy:function(){var e;for(e in f)delete f[e];i(function(){this.nuke()})}},s}}])});