angular.module("ui.scroll",[]).directive("uiScrollViewport",["$log",function(){return{controller:["$scope","$element",function(e,t){return t}]}}]).directive("uiScroll",["$log","$injector","$rootScope","$timeout",function(e,t,n,r){return{require:["?^uiScrollViewport"],transclude:"element",priority:1e3,terminal:!0,compile:function(i,s,o){return function(i,s,u,a){var f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt;P=e.debug||e.log,H=u.uiScroll.match(/^\s*(\w+)\s+in\s+(\w+)\s*$/);if(!H)throw new Error("Expected uiScroll in form of '_item_ in _datasource_' but got '"+u.uiScroll+"'");_=H[1],w=H[2],O=function(e){return angular.isObject(e)&&e.get&&angular.isFunction(e.get)},b=i[w];if(!O(b)){b=t.get(w);if(!O(b))throw new Error(""+w+" is not a valid datasource")}return m=Math.max(3,+u.bufferSize||10),v=function(){return Z.outerHeight()*Math.max(.1,+u.padding||.1)},z=function(e){var t;return(t=e[0].scrollHeight)!=null?t:e[0].document.documentElement.scrollHeight},f=null,o($=i.$new(),function(e){var t,n,r,i,o,u;i=e[0].localName;if(i==="dl")throw new Error("ui-scroll directive does not support <"+e[0].localName+"> as a repeating tag: "+e[0].outerHTML);return i!=="li"&&i!=="tr"&&(i="div"),u=a[0]||angular.element(window),u.css({"overflow-y":"auto",display:"block"}),r=function(e){var t,n,r;switch(e){case"tr":return r=angular.element("<table><tr><td><div></div></td></tr></table>"),t=r.find("div"),n=r.find("tr"),n.paddingHeight=function(){return t.height.apply(t,arguments)},n;default:return n=angular.element("<"+e+"></"+e+">"),n.paddingHeight=n.height,n}},n=function(e,t,n){return t[{top:"before",bottom:"after"}[n]](e),{paddingHeight:function(){return e.paddingHeight.apply(e,arguments)},insert:function(t){return e[{top:"after",bottom:"before"}[n]](t)}}},o=n(r(i),s,"top"),t=n(r(i),s,"bottom"),$.$destroy(),f={viewport:u,topPadding:o.paddingHeight,bottomPadding:t.paddingHeight,append:t.insert,prepend:o.insert,bottomDataPos:function(){return z(u)-t.paddingHeight()},topDataPos:function(){return o.paddingHeight()}}}),Z=f.viewport,et=Z.scope()||n,angular.isDefined(u.topVisible)&&(Q=function(e){return et[u.topVisible]=e}),angular.isDefined(u.topVisibleElement)&&(K=function(e){return et[u.topVisibleElement]=e}),angular.isDefined(u.topVisibleScope)&&(Y=function(e){return et[u.topVisibleScope]=e}),J=function(e){Q&&Q(e.scope[_]),K&&K(e.element),Y&&Y(e.scope);if(b.topVisible)return b.topVisible(e)},angular.isDefined(u.isLoading)?D=function(e){et[u.isLoading]=e;if(b.loading)return b.loading(e)}:D=function(e){if(b.loading)return b.loading(e)},R=0,k=1,B=1,d=[],j=[],x=!1,h=!1,M=!1,I=function(e,t){var n,r;for(n=r=e;e<=t?r<t:r>t;n=e<=t?++r:--r)d[n].scope.$destroy(),d[n].element.remove();return d.splice(e,t-e)},F=function(){return R++,k=1,B=1,I(0,d.length),f.topPadding(0),f.bottomPadding(0),j=[],x=!1,h=!1,l(R,!1)},p=function(){return Z.scrollTop()+Z.outerHeight()},G=function(){return Z.scrollTop()},W=function(){return!x&&f.bottomDataPos()<p()+v()},g=function(){var e,t,n,r,i,s,o,u,a,l;e=0,o=0;for(t=a=l=d.length-1;l<=0?a<=0:a>=0;t=l<=0?++a:--a){n=d[t],i=n.element.offset().top,s=u!==i,u=i,s&&(r=n.element.outerHeight(!0));if(f.bottomDataPos()-e-r>p()+v())s&&(e+=r),o++,x=!1;else{if(s)break;o++}}if(o>0)return f.bottomPadding(f.bottomPadding()+e),I(d.length-o,d.length),B-=o,P("clipped off bottom "+o+" bottom padding "+f.bottomPadding())},X=function(){return!h&&f.topDataPos()>G()-v()},y=function(){var e,t,n,r,i,s,o,u,a;o=0,i=0;for(u=0,a=d.length;u<a;u++){e=d[u],n=e.element.offset().top,r=s!==n,s=n,r&&(t=e.element.outerHeight(!0));if(f.topDataPos()+o+t<G()-v())r&&(o+=t),i++,h=!1;else{if(r)break;i++}}if(i>0)return f.topPadding(f.topPadding()+o),I(0,i),k+=i,P("clipped off top "+i+" top padding "+f.topPadding())},S=function(e,t,n){M||(M=!0,D(!0));if(j.push(t)===1)return N(e,n)},L=function(e){return e.displayTemp=e.css("display"),e.css("display","none")},V=function(e){if(e.hasOwnProperty("displayTemp"))return e.css("display",e.displayTemp)},A=function(e,t){var n,r,s;return n=i.$new(),n[_]=t,r=e>k,n.$index=e,r&&n.$index--,s={scope:n},o(n,function(t){return s.element=t,r?e===B?(L(t),f.append(t),d.push(s)):(d[e-k].element.after(t),d.splice(e-k+1,0,s)):(L(t),f.prepend(t),d.unshift(s))}),{appended:r,wrapper:s}},c=function(e,t){var n;return e?f.bottomPadding(Math.max(0,f.bottomPadding()-t.element.outerHeight(!0))):(n=f.topPadding()-t.element.outerHeight(!0),n>=0?f.topPadding(n):Z.scrollTop(Z.scrollTop()+t.element.outerHeight(!0)))},E=function(e,t,n){var r,i,s,o,u,a,l,c,h;P("top {actual="+f.topDataPos()+" visible from="+G()+" bottom {visible through="+p()+" actual="+f.bottomDataPos()+"}"),W()?S(e,!0,t):X()&&S(e,!1,t),n&&n(e);if(j.length===0){a=0,h=[];for(l=0,c=d.length;l<c;l++){r=d[l],s=r.element.offset().top,o=u!==s,u=s,o&&(i=r.element.outerHeight(!0));if(!(o&&f.topDataPos()+a+i<G())){o&&J(r);break}h.push(a+=i)}return h}},l=function(e,t,n,i){return n&&n.length?r(function(){var r,o,u,a,f,l,h,p;a=[];for(f=0,h=n.length;f<h;f++)o=n[f],s=o.wrapper.element,V(s),r=s.offset().top,u!==r&&(a.push(o),u=r);for(l=0,p=a.length;l<p;l++)o=a[l],c(o.appended,o.wrapper);return E(e,t,i)}):E(e,t,i)},C=function(e,t,n){return l(e,t,n,function(){return j.shift(),j.length===0?(M=!1,D(!1)):N(e,t)})},N=function(e,t){var n;return n=j[0],n?d.length&&!W()?C(e,t):b.get(B,m,function(n){var r,i,s,o;if(e&&e!==R)return;i=[],n.length<m&&(x=!0,f.bottomPadding(0));if(n.length>0){y();for(s=0,o=n.length;s<o;s++)r=n[s],i.push(A(++B,r))}return C(e,t,i)}):d.length&&!X()?C(e,t):b.get(k-m,m,function(n){var r,i,s,o;if(e&&e!==R)return;i=[],n.length<m&&(h=!0,f.topPadding(0));if(n.length>0){d.length&&g();for(r=s=o=n.length-1;o<=0?s<=0:s>=0;r=o<=0?++s:--s)i.unshift(A(--k,n[r]))}return C(e,t,i)})},q=function(){if(!n.$$phase&&!M)return l(null,!1),i.$apply()},Z.bind("resize",q),U=function(){if(!n.$$phase&&!M)return l(null,!0),i.$apply()},Z.bind("scroll",U),tt=function(e){var t,n;t=Z[0].scrollTop,n=Z[0].scrollHeight-Z[0].clientHeight;if(t===0&&!h||t===n&&!x)return e.preventDefault()},Z.bind("mousewheel",tt),i.$watch(b.revision,function(){return F()}),b.scope?T=b.scope.$new():T=i.$new(),i.$on("$destroy",function(){return T.$destroy(),Z.unbind("resize",q),Z.unbind("scroll",U),Z.unbind("mousewheel",tt)}),T.$on("update.items",function(e,t,n){var r,i,s,o,u;if(angular.isFunction(t)){i=function(e){return t(e.scope)};for(s=0,o=d.length;s<o;s++)r=d[s],i(r)}else 0<=(u=t-k-1)&&u<d.length&&(d[t-k-1].scope[_]=n);return null}),T.$on("delete.items",function(e,t){var n,r,i,s,o,u,a,f,c,h,p,v;if(angular.isFunction(t)){i=[];for(u=0,c=d.length;u<c;u++)r=d[u],i.unshift(r);o=function(e){if(t(e.scope))return I(i.length-1-n,i.length-n),B--};for(n=a=0,h=i.length;a<h;n=++a)s=i[n],o(s)}else 0<=(v=t-k-1)&&v<d.length&&(I(t-k-1,t-k),B--);for(n=f=0,p=d.length;f<p;n=++f)r=d[n],r.scope.$index=k+n;return l(null,!1)}),T.$on("insert.item",function(e,t,n){var r,i,s,o,u;i=[];if(angular.isFunction(t))throw new Error("not implemented - Insert with locator function");0<=(u=t-k-1)&&u<d.length&&(i.push(A(t,n)),B++);for(r=s=0,o=d.length;s<o;r=++s)n=d[r],n.scope.$index=k+r;return l(null,!1,i)})}}}}]);