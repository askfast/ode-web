describe("uiScroll",function(){angular.module("ui.scroll.test",[]).factory("myEmptyDatasource",["$log","$timeout","$rootScope",function(){return{get:function(e,t,n){n([])}}}]).factory("myOnePageDatasource",["$log","$timeout","$rootScope",function(){return{get:function(e,t,n){e===1?n(["one","two","three"]):n([])}}}]).factory("myMultipageDatasource",["$log","$timeout","$rootScope",function(){return{get:function(e,t,n){var r=[];for(var i=e;i<e+t;i++)i>0&&i<=20&&r.push("item"+i);n(r)}}}]).factory("AnotherDatasource",["$log","$timeout","$rootScope",function(){return{get:function(e,t,n){var r=[];for(var i=e;i<e+t;i++)i>-3&&i<1&&r.push("item"+i);n(r)}}}]).factory("myEdgeDatasource",["$log","$timeout","$rootScope",function(){return{get:function(e,t,n){var r=[];for(var i=e;i<e+t;i++)i>-6&&i<=6&&r.push("item"+i);n(r)}}}]).factory("myDatasourceToPreventScrollBubbling",["$log","$timeout","$rootScope",function(){return{get:function(e,t,n){var r=[];for(var i=e;i<e+t;i++){if(i<-6||i>20)break;r.push("item"+i)}n(r)}}}]),beforeEach(module("ui.scroll")),beforeEach(module("ui.scroll.test"));var e=function(e,t,n,r){inject(function(i,s,o,u){var a=angular.element(e),f=i.$new(),l=angular.element("<div/>");angular.element(document).find("body").append(l),l.append(a),s(a)(f),f.$apply(),(!r||!r.noFlush)&&u.flush(),t(o,l),l.remove(),f.$destroy(),n&&n(o,f)})};describe("basic setup",function(){var t='<div ui-scroll="item in myEmptyDatasource">{{$index}}: {{item}}</div>';it("should bind to window scroll and resize events and unbind upon scope destroy",function(){spyOn($.fn,"bind").andCallThrough(),spyOn($.fn,"unbind").andCallThrough(),e(t,function(e){expect($.fn.bind.calls.length).toBe(3),expect($.fn.bind.calls[0].args[0]).toBe("resize"),expect($.fn.bind.calls[0].object[0]).toBe(e),expect($.fn.bind.calls[1].args[0]).toBe("scroll"),expect($.fn.bind.calls[1].object[0]).toBe(e),expect($.fn.bind.calls[2].args[0]).toBe("mousewheel"),expect($.fn.bind.calls[2].object[0]).toBe(e),expect($._data(e,"events")).toBeDefined()},function(e){expect($.fn.unbind.calls.length).toBe(3),expect($.fn.unbind.calls[0].args[0]).toBe("resize"),expect($.fn.unbind.calls[0].object[0]).toBe(e),expect($.fn.unbind.calls[1].args[0]).toBe("scroll"),expect($.fn.unbind.calls[1].object[0]).toBe(e),expect($.fn.unbind.calls[2].args[0]).toBe("mousewheel"),expect($.fn.unbind.calls[2].object[0]).toBe(e)},{noFlush:!0})}),it("should create 2 divs of 0 height",function(){e(t,function(e,t){expect(t.children().length).toBe(2);var n=t.children()[0];expect(n.tagName.toLowerCase()).toBe("div"),expect(angular.element(n).css("height")).toBe("0px");var r=t.children()[1];expect(r.tagName.toLowerCase()).toBe("div"),expect(angular.element(r).css("height")).toBe("0px")},null,{noFlush:!0})}),it("should call get on the datasource 1 time ",function(){var n;inject(function(e){n=spyOn(e,"get").andCallThrough()}),e(t,function(){expect(n.calls.length).toBe(2),expect(n.calls[0].args[0]).toBe(1),expect(n.calls[1].args[0]).toBe(-9)},null,{noFlush:!0})})}),describe("datasource with only 3 elements",function(){var t='<div ui-scroll="item in myOnePageDatasource">{{$index}}: {{item}}</div>';it("should create 3 divs with data (+ 2 padding divs)",function(){e(t,function(e,t){expect(t.children().length).toBe(5);var n=t.children()[1];expect(n.tagName.toLowerCase()).toBe("div"),expect(n.innerHTML).toBe("1: one");var r=t.children()[2];expect(r.tagName.toLowerCase()).toBe("div"),expect(r.innerHTML).toBe("2: two");var i=t.children()[3];expect(i.tagName.toLowerCase()).toBe("div"),expect(i.innerHTML).toBe("3: three")})}),it("should call get on the datasource 2 times ",function(){var n;inject(function(r){n=spyOn(r,"get").andCallThrough(),e(t,function(){expect(n.calls.length).toBe(2),expect(n.calls[0].args[0]).toBe(1),expect(n.calls[1].args[0]).toBe(-9)})})})}),describe("datasource with only 3 elements (negative index)",function(){var t='<div ui-scroll="item in AnotherDatasource">{{$index}}: {{item}}</div>';it("should create 3 divs with data (+ 2 padding divs)",function(){e(t,function(e,t){expect(t.children().length).toBe(5);var n=t.children()[1];expect(n.tagName.toLowerCase()).toBe("div"),expect(n.innerHTML).toBe("-2: item-2");var r=t.children()[2];expect(r.tagName.toLowerCase()).toBe("div"),expect(r.innerHTML).toBe("-1: item-1");var i=t.children()[3];expect(i.tagName.toLowerCase()).toBe("div"),expect(i.innerHTML).toBe("0: item0")})}),it("should call get on the datasource 2 times ",function(){var n;inject(function(r){n=spyOn(r,"get").andCallThrough(),e(t,function(){expect(n.calls.length).toBe(2),expect(n.calls[0].args[0]).toBe(1),expect(n.calls[1].args[0]).toBe(-9)})})})}),describe("datasource with 20 elements and buffer size 3 - constrained viewport",function(){var t='<div ui-scroll-viewport style="height:200px"><div style="height:40px" ui-scroll="item in myMultipageDatasource" buffer-size="3">{{$index}}: {{item}}</div></div>';it("should create 6 divs with data (+ 2 padding divs)",function(){e(t,function(e,t){var n=t.children();expect(n.children().length).toBe(8),expect(n.scrollTop()).toBe(0),expect(n.children().css("height")).toBe("0px"),expect(angular.element(n.children()[7]).css("height")).toBe("0px");for(var r=1;r<7;r++){var i=n.children()[r];expect(i.tagName.toLowerCase()).toBe("div"),expect(i.innerHTML).toBe(r+": item"+r)}})}),it("should call get on the datasource 3 times ",function(){var n;inject(function(e){n=spyOn(e,"get").andCallThrough()}),e(t,function(){expect(n.calls.length).toBe(3),expect(n.calls[0].args[0]).toBe(1),expect(n.calls[1].args[0]).toBe(4),expect(n.calls[2].args[0]).toBe(-2)})}),it("should create 3 more divs (9 divs total) with data (+ 2 padding divs)",function(){e(t,function(e,t){var n=t.children();n.scrollTop(100),n.trigger("scroll"),inject(function(e){e.flush(),expect(n.children().length).toBe(11),expect(n.scrollTop()).toBe(40),expect(n.children().css("height")).toBe("0px"),expect(angular.element(n.children()[10]).css("height")).toBe("0px");for(var t=1;t<10;t++){var r=n.children()[t];expect(r.tagName.toLowerCase()).toBe("div"),expect(r.innerHTML).toBe(t+": item"+t)}})})}),it("should call get on the datasource 1 extra time (4 total) ",function(){var n;inject(function(e){n=spyOn(e,"get").andCallThrough()}),e(t,function(e,t){var r=t.children();r.scrollTop(100),r.trigger("scroll"),expect(n.calls.length).toBe(4),expect(n.calls[0].args[0]).toBe(1),expect(n.calls[1].args[0]).toBe(4),expect(n.calls[2].args[0]).toBe(-2),expect(n.calls[3].args[0]).toBe(7)})}),it("should clip 3 divs from the top and add 3 more divs to the bottom (9 divs total) (+ 2 padding divs)",function(){e(t,function(e,t){var n;inject(function(e){n=e.flush});var r=t.children();r.scrollTop(100),r.trigger("scroll"),n(),r.scrollTop(400),r.trigger("scroll"),n(),expect(r.children().length).toBe(11),expect(r.scrollTop()).toBe(160),expect(r.children().css("height")).toBe("120px"),expect(angular.element(r.children()[10]).css("height")).toBe("0px");for(var i=1;i<10;i++){var s=r.children()[i];expect(s.tagName.toLowerCase()).toBe("div"),expect(s.innerHTML).toBe(i+3+": item"+(i+3))}})}),it("should call get on the datasource 1 more time (4 total) ",function(){var n;inject(function(e){n=e.flush});var r;inject(function(e){r=spyOn(e,"get").andCallThrough()}),e(t,function(e,t){var i=t.children();i.scrollTop(100),i.trigger("scroll"),n(),i.scrollTop(400),i.trigger("scroll"),n(),expect(r.calls.length).toBe(5),expect(r.calls[0].args[0]).toBe(1),expect(r.calls[1].args[0]).toBe(4),expect(r.calls[2].args[0]).toBe(-2),expect(r.calls[3].args[0]).toBe(7),expect(r.calls[4].args[0]).toBe(10)})}),it("should re-add 3 divs at the top and clip 3 divs from the bottom (9 divs total) (+ 2 padding divs)",function(){var n;inject(function(e){n=e.flush}),e(t,function(e,t){var r=t.children();r.scrollTop(100),r.trigger("scroll"),n(),r.scrollTop(400),r.trigger("scroll"),n(),r.scrollTop(0),r.trigger("scroll"),n(),expect(r.children().length).toBe(8),expect(r.scrollTop()).toBe(0),expect(r.children().css("height")).toBe("0px"),expect(angular.element(r.children()[7]).css("height")).toBe("240px");for(var i=1;i<7;i++){var s=r.children()[i];expect(s.tagName.toLowerCase()).toBe("div"),expect(s.innerHTML).toBe(i+": item"+i)}})}),it("should call get on the datasource 1 more time (4 total) ",function(){var n;inject(function(e){n=spyOn(e,"get").andCallThrough()});var r;inject(function(e){r=e.flush}),e(t,function(e,t){var i=t.children();i.scrollTop(100),i.trigger("scroll"),r(),i.scrollTop(400),i.trigger("scroll"),r(),i.scrollTop(0),i.trigger("scroll"),r(),expect(n.calls.length).toBe(7),expect(n.calls[0].args[0]).toBe(1),expect(n.calls[1].args[0]).toBe(4),expect(n.calls[2].args[0]).toBe(-2),expect(n.calls[3].args[0]).toBe(7),expect(n.calls[4].args[0]).toBe(10),expect(n.calls[5].args[0]).toBe(1),expect(n.calls[6].args[0]).toBe(-2)})})}),describe("datasource with 12 elements and buffer size 3 (fold/edge cases)",function(){var t=12,n=3,r=20,i=function(e){return'<div ui-scroll-viewport style="height:'+e+'px"><div style="height:'+r+'px" ui-scroll="item in myEdgeDatasource" buffer-size="'+n+'">{{$index}}: {{item}}</div></div>'};it("[full frame] should call get on the datasource 4 (12/3) times + 2 additional times (with empty result)",function(){var s,o=t*r;inject(function(e){s=spyOn(e,"get").andCallThrough()}),e(i(o),function(){expect(s.calls.length).toBe(parseInt(t/n,10)+2),expect(s.calls[0].args[0]).toBe(1),expect(s.calls[1].args[0]).toBe(4),expect(s.calls[2].args[0]).toBe(7),expect(s.calls[3].args[0]).toBe(-2),expect(s.calls[4].args[0]).toBe(-5),expect(s.calls[5].args[0]).toBe(-8)})}),it("[fold frame] should call get on the datasource 3 times",function(){var t,s=n*r;inject(function(e){t=spyOn(e,"get").andCallThrough()}),e(i(s),function(){expect(t.calls.length).toBe(3),expect(t.calls[0].args[0]).toBe(1),expect(t.calls[1].args[0]).toBe(4),expect(t.calls[2].args[0]).toBe(-2)})}),it("[fold frame, scroll down] should call get on the datasource 1 extra time",function(){var t,s,o=n*r;inject(function(e){t=spyOn(e,"get").andCallThrough()}),inject(function(e){s=e.flush}),e(i(o),function(e,n){var i=n.children();i.scrollTop(o+r),i.trigger("scroll"),s(),i.scrollTop(o+r*2),i.trigger("scroll"),expect(s).toThrow(),expect(t.calls.length).toBe(4),expect(t.calls[0].args[0]).toBe(1),expect(t.calls[1].args[0]).toBe(4),expect(t.calls[2].args[0]).toBe(-2),expect(t.calls[3].args[0]).toBe(5)})}),it("[fold frame, scroll up] should call get on the datasource 2 extra times",function(){var t,s,o=n*r;inject(function(e){t=spyOn(e,"get").andCallThrough()}),inject(function(e){s=e.flush}),e(i(o),function(e,n){var r=n.children();r.scrollTop(0),r.trigger("scroll"),s(),r.scrollTop(0),r.trigger("scroll"),expect(s).toThrow(),r.scrollTop(0),r.trigger("scroll"),expect(s).toThrow(),expect(t.calls.length).toBe(5),expect(t.calls[0].args[0]).toBe(1),expect(t.calls[1].args[0]).toBe(4),expect(t.calls[2].args[0]).toBe(-2),expect(t.calls[3].args[0]).toBe(-5),expect(t.calls[4].args[0]).toBe(-8)})})}),describe("prevent unwanted scroll bubbling",function(){var t='<div ui-scroll-viewport style="width: 400px; height: 300px; display: block; background-color: white;"><ul><li ui-scroll="item in myDatasourceToPreventScrollBubbling" buffer-size="3">{{$index}}: {{item}}</li></ul></div>',n=0,r=function(e){e=e.originalEvent||e,e.defaultPrevented||n++},i=function(){var e=document.createEvent("MouseEvents");return e.initEvent("mousewheel",!0,!0),e.wheelDelta=120,e};it("should prevent wheel-event bubbling until bof is reached",function(){var s,o;inject(function(e){s=spyOn(e,"get").andCallThrough()}),inject(function(e){o=e.flush}),e(t,function(e,t){var s=t.children(),u=s[0];angular.element(document.body).bind("mousewheel",r),u.dispatchEvent(i()),expect(n).toBe(1),s.scrollTop(0),s.trigger("scroll"),u.dispatchEvent(i()),expect(n).toBe(1),o(),u.dispatchEvent(i()),expect(n).toBe(2),s.scrollTop(0),s.trigger("scroll"),u.dispatchEvent(i()),expect(n).toBe(3),expect(o).toThrow(),u.dispatchEvent(i()),expect(n).toBe(4)},function(){angular.element(document.body).unbind("mousewheel",r)})})})});