(function(){function pathToTree(e){for(var t,n=e.shift(),r=[n.id,n.opts,[]],i=r;e.length;)n=e.shift(),t=[n.id,n.opts,[]],i[2].push(t),i=t;return r}function mergeTree(e,t){for(var n=[{tree1:e,tree2:t}],r=!1;n.length>0;){var i=n.pop(),s=i.tree1,o=i.tree2;(s[1].status||o[1].status)&&(s[1].status="available"===s[1].status||"available"===o[1].status?"available":"missing");for(var u=0;o[2].length>u;u++)if(s[2][0]){for(var a=!1,f=0;s[2].length>f;f++)s[2][f][0]===o[2][u][0]&&(n.push({tree1:s[2][f],tree2:o[2][u]}),a=!0);a||(r="new_branch",s[2].push(o[2][u]),s[2].sort())}else r="new_leaf",s[2][0]=o[2][u]}return{conflicts:r,tree:e}}function doMerge(e,t,n){var r,i=[],s=!1,o=!1;return e.length?(e.forEach(function(e){if(e.pos===t.pos&&e.ids[0]===t.ids[0])r=mergeTree(e.ids,t.ids),i.push({pos:e.pos,ids:r.tree}),s=s||r.conflicts,o=!0;else if(n!==!0){var u=e.pos<t.pos?e:t,f=e.pos<t.pos?t:e,l=f.pos-u.pos,c=[],h=[];for(h.push({ids:u.ids,diff:l,parent:null,parentIdx:null});h.length>0;){var p=h.pop();0!==p.diff?p.ids&&p.ids[2].forEach(function(e,t){h.push({ids:e,diff:p.diff-1,parent:p.ids,parentIdx:t})}):p.ids[0]===f.ids[0]&&c.push(p)}var d=c[0];d?(r=mergeTree(d.ids,f.ids),d.parent[2][d.parentIdx]=r.tree,i.push({pos:u.pos,ids:u.ids}),s=s||r.conflicts,o=!0):i.push(e)}else i.push(e)}),o||i.push(t),i.sort(function(e,t){return e.pos-t.pos}),{tree:i,conflicts:s||"internal_node"}):{tree:[t],conflicts:"new_leaf"}}function stem(e,t){var n=rootToLeaf(e).map(function(e){var n=e.ids.slice(-t);return{pos:e.pos+(e.ids.length-n.length),ids:pathToTree(n)}});return n.reduce(function(e,t){return doMerge(e,t,!0).tree},[n.shift()])}function replicate(e,t,n,r){function i(e,t,r){if(h.notifyRequestComplete(),n.onChange)for(var i=0;r>i;i++)n.onChange.apply(this,[E]);g-=r,E.docs_written+=r,c()}function s(){if(!p.length)return h.notifyRequestComplete();var e=p.length;t.bulkDocs({docs:p},{new_edits:!1},function(t,n){i(t,n,e)}),p=[]}function o(t,n){e.get(t,{revs:!0,rev:n,attachments:!0},function(e,t){h.notifyRequestComplete(),p.push(t),h.enqueue(s)})}function u(e,t){if(h.notifyRequestComplete(),e)return b&&r.cancel(),call(n.complete,e,null),void 0;if(0===Object.keys(t).length)return g--,c(),void 0;var i=function(e){h.enqueue(o,[s,e])};for(var s in t)t[s].missing.forEach(i)}function a(e){t.revsDiff(e,u)}function f(e){y=e.seq,v.push(e),E.docs_read++,g++;var t={};t[e.id]=e.changes.map(function(e){return e.rev}),h.enqueue(a,[t])}function l(){m=!0,c()}function c(){m&&0===g&&(E.end_time=new Date,writeCheckpoint(t,d,y,function(e){call(n.complete,e,E)}))}var h=new RequestManager,p=[],d=genReplicationId(e,t,n),v=[],m=!1,g=0,y=0,b=n.continuous||!1,w=n.doc_ids,E={ok:!0,start_time:new Date,docs_read:0,docs_written:0};fetchCheckpoint(t,d,function(t,i){if(t)return call(n.complete,t);if(y=i,!r.cancelled){var s={continuous:b,since:y,style:"all_docs",onChange:f,complete:l,doc_ids:w};n.filter&&(s.filter=n.filter),n.query_params&&(s.query_params=n.query_params);var o=e.changes(s);n.continuous&&(r.cancel=o.cancel)}})}function toPouch(e,t){return"string"==typeof e?new Pouch(e,t):(t(null,e),void 0)}function parseUri(e){for(var t=parseUri.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),r={},i=14;i--;)r[t.key[i]]=n[i]||"";return r[t.q.name]={},r[t.key[12]].replace(t.q.parser,function(e,n,i){n&&(r[t.q.name][n]=i)}),r}function encodeDocId(e){return/^_design/.test(e)?e:encodeURIComponent(e)}function getHost(e){if(/http(s?):/.test(e)){var t=parseUri(e);t.remote=!0,(t.user||t.password)&&(t.auth={username:t.user,password:t.password});var n=t.path.replace(/(^\/|\/$)/g,"").split("/");return t.db=n.pop(),t.path=n.join("/"),t}return{host:"",path:"/",db:e,auth:!1}}function genDBUrl(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+e.db+"/"+t}return"/"+e.db+"/"+t}function genUrl(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+t}return"/"+t}function quote(e){return"'"+e+"'"}(function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,n){var r=e,i=[];if(n=n||r.length,t)for(var s=0;t>s;s++)i[s]=r[0|Math.random()*n];else{var o;i[8]=i[13]=i[18]=i[23]="-",i[14]="4";for(var s=0;36>s;s++)i[s]||(o=0|16*Math.random(),i[s]=r[19==s?8|3&o:o])}return i.join("")}})();var Crypto={};(function(){Crypto.MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,r,i,s,o;return i=2147483648&e,s=2147483648&t,n=1073741824&e,r=1073741824&t,o=(1073741823&e)+(1073741823&t),n&r?2147483648^o^i^s:n|r?1073741824&o?3221225472^o^i^s:1073741824^o^i^s:o^i^s}function r(e,t,n){return e&t|~e&n}function i(e,t,n){return e&n|t&~n}function s(e,t,n){return e^t^n}function o(e,t,n){return t^(e|~n)}function u(e,i,s,o,u,a,f){return e=n(e,n(n(r(i,s,o),u),f)),n(t(e,a),i)}function a(e,r,s,o,u,a,f){return e=n(e,n(n(i(r,s,o),u),f)),n(t(e,a),r)}function f(e,r,i,o,u,a,f){return e=n(e,n(n(s(r,i,o),u),f)),n(t(e,a),r)}function l(e,r,i,s,u,a,f){return e=n(e,n(n(o(r,i,s),u),f)),n(t(e,a),r)}function c(e){for(var t,n=e.length,r=n+8,i=(r-r%64)/64,s=16*(i+1),o=Array(s-1),u=0,a=0;n>a;)t=(a-a%4)/4,u=8*(a%4),o[t]=o[t]|e.charCodeAt(a)<<u,a++;return t=(a-a%4)/4,u=8*(a%4),o[t]=o[t]|128<<u,o[s-2]=n<<3,o[s-1]=n>>>29,o}function h(e){var t,n,r="",i="";for(n=0;3>=n;n++)t=255&e>>>8*n,i="0"+t.toString(16),r+=i.substr(i.length-2,2);return r}var p,d,v,m,g,y,b,w,E,S=[],x=7,T=12,N=17,C=22,k=5,L=9,A=14,O=20,M=4,_=11,D=16,P=23,H=6,B=10,j=15,F=21;for(S=c(e),y=1732584193,b=4023233417,w=2562383102,E=271733878,p=0;S.length>p;p+=16)d=y,v=b,m=w,g=E,y=u(y,b,w,E,S[p+0],x,3614090360),E=u(E,y,b,w,S[p+1],T,3905402710),w=u(w,E,y,b,S[p+2],N,606105819),b=u(b,w,E,y,S[p+3],C,3250441966),y=u(y,b,w,E,S[p+4],x,4118548399),E=u(E,y,b,w,S[p+5],T,1200080426),w=u(w,E,y,b,S[p+6],N,2821735955),b=u(b,w,E,y,S[p+7],C,4249261313),y=u(y,b,w,E,S[p+8],x,1770035416),E=u(E,y,b,w,S[p+9],T,2336552879),w=u(w,E,y,b,S[p+10],N,4294925233),b=u(b,w,E,y,S[p+11],C,2304563134),y=u(y,b,w,E,S[p+12],x,1804603682),E=u(E,y,b,w,S[p+13],T,4254626195),w=u(w,E,y,b,S[p+14],N,2792965006),b=u(b,w,E,y,S[p+15],C,1236535329),y=a(y,b,w,E,S[p+1],k,4129170786),E=a(E,y,b,w,S[p+6],L,3225465664),w=a(w,E,y,b,S[p+11],A,643717713),b=a(b,w,E,y,S[p+0],O,3921069994),y=a(y,b,w,E,S[p+5],k,3593408605),E=a(E,y,b,w,S[p+10],L,38016083),w=a(w,E,y,b,S[p+15],A,3634488961),b=a(b,w,E,y,S[p+4],O,3889429448),y=a(y,b,w,E,S[p+9],k,568446438),E=a(E,y,b,w,S[p+14],L,3275163606),w=a(w,E,y,b,S[p+3],A,4107603335),b=a(b,w,E,y,S[p+8],O,1163531501),y=a(y,b,w,E,S[p+13],k,2850285829),E=a(E,y,b,w,S[p+2],L,4243563512),w=a(w,E,y,b,S[p+7],A,1735328473),b=a(b,w,E,y,S[p+12],O,2368359562),y=f(y,b,w,E,S[p+5],M,4294588738),E=f(E,y,b,w,S[p+8],_,2272392833),w=f(w,E,y,b,S[p+11],D,1839030562),b=f(b,w,E,y,S[p+14],P,4259657740),y=f(y,b,w,E,S[p+1],M,2763975236),E=f(E,y,b,w,S[p+4],_,1272893353),w=f(w,E,y,b,S[p+7],D,4139469664),b=f(b,w,E,y,S[p+10],P,3200236656),y=f(y,b,w,E,S[p+13],M,681279174),E=f(E,y,b,w,S[p+0],_,3936430074),w=f(w,E,y,b,S[p+3],D,3572445317),b=f(b,w,E,y,S[p+6],P,76029189),y=f(y,b,w,E,S[p+9],M,3654602809),E=f(E,y,b,w,S[p+12],_,3873151461),w=f(w,E,y,b,S[p+15],D,530742520),b=f(b,w,E,y,S[p+2],P,3299628645),y=l(y,b,w,E,S[p+0],H,4096336452),E=l(E,y,b,w,S[p+7],B,1126891415),w=l(w,E,y,b,S[p+14],j,2878612391),b=l(b,w,E,y,S[p+5],F,4237533241),y=l(y,b,w,E,S[p+12],H,1700485571),E=l(E,y,b,w,S[p+3],B,2399980690),w=l(w,E,y,b,S[p+10],j,4293915773),b=l(b,w,E,y,S[p+1],F,2240044497),y=l(y,b,w,E,S[p+8],H,1873313359),E=l(E,y,b,w,S[p+15],B,4264355552),w=l(w,E,y,b,S[p+6],j,2734768916),b=l(b,w,E,y,S[p+13],F,1309151649),y=l(y,b,w,E,S[p+4],H,4149444226),E=l(E,y,b,w,S[p+11],B,3174756917),w=l(w,E,y,b,S[p+2],j,718787259),b=l(b,w,E,y,S[p+9],F,3951481745),y=n(y,d),b=n(b,v),w=n(w,m),E=n(E,g);var I=h(y)+h(b)+h(w)+h(E);return I.toLowerCase()}})(),function(){if(!Object.defineProperty||!function(){try{return Object.defineProperty({},"x",{}),!0}catch(e){return!1}}()){var e=Object.defineProperty;Object.defineProperty=function(t,n,r){if(e)try{return e(t,n,r)}catch(i){}if(t!==Object(t))throw new TypeError("Object.defineProperty called on non-object");return Object.prototype.__defineGetter__&&"get"in r&&Object.prototype.__defineGetter__.call(t,n,r.get),Object.prototype.__defineSetter__&&"set"in r&&Object.prototype.__defineSetter__.call(t,n,r.set),"value"in r&&(t[n]=r.value),t}}}(),Object.keys||(Object.keys=function(e){if(e!==Object(e))throw new TypeError("Object.keys called on non-object");var t,n=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&n.push(t);return n}),Array.prototype.forEach||(Array.prototype.forEach=function(e){if(void 0===this||null===this)throw new TypeError;var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;var r,i=arguments[1];for(r=0;n>r;r++)r in t&&e.call(i,t[r],r,t)}),Array.prototype.map||(Array.prototype.map=function(e){if(void 0===this||null===this)throw new TypeError;var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;var r=[];r.length=n;var i,s=arguments[1];for(i=0;n>i;i++)i in t&&(r[i]=e.call(s,t[i],i,t));return r});for(var class2type={},types=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"],i=0;types.length>i;i++){var typename=types[i];class2type["[object "+typename+"]"]=typename.toLowerCase()}var core_toString=class2type.toString,core_hasOwn=class2type.hasOwnProperty,type=function(e){return null===e?e+"":"object"==typeof e||"function"==typeof e?class2type[core_toString.call(e)]||"object":typeof e},isWindow=function(e){return null!==e&&e===e.window},isPlainObject=function(e){if(!e||"object"!==type(e)||e.nodeType||isWindow(e))return!1;try{if(e.constructor&&!core_hasOwn.call(e,"constructor")&&!core_hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}var n;for(n in e);return void 0===n||core_hasOwn.call(e,n)},isFunction=function(e){return"function"===type(e)},isArray=Array.isArray||function(e){return"array"===type(e)},extend=function(){var e,t,n,r,i,s,o=arguments[0]||{},u=1,a=arguments.length,f=!1;for("boolean"==typeof o&&(f=o,o=arguments[1]||{},u=2),"object"==typeof o||isFunction(o)||(o={}),a===u&&(o=this,--u);a>u;u++)if(null!=(e=arguments[u]))for(t in e)n=o[t],r=e[t],o!==r&&(f&&r&&(isPlainObject(r)||(i=isArray(r)))?(i?(i=!1,s=n&&isArray(n)?n:[]):s=n&&isPlainObject(n)?n:{},o[t]=extend(f,s,r)):void 0!==r&&(o[t]=r));return o};"undefined"!=typeof module&&module.exports&&(module.exports=extend);var ajax=function(t,n){function r(e,t,n){if(n){var r=new Date;r.setTime(r.getTime()+864e5*n);var i="; expires="+r.toGMTString()}else var i="";document.cookie=e+"="+t+i+"; path=/"}"function"==typeof t&&(n=t,t={});var i=function(e){var t=Array.prototype.slice.call(arguments,1);typeof e==typeof Function&&e.apply(this,t)},s={method:"GET",headers:{},json:!0,processData:!0,timeout:1e4};t=extend(!0,s,t);var o=function(e,n,r){if(t.binary||t.json||!t.processData||"string"==typeof e){if(!t.binary&&t.json&&"string"==typeof e)try{e=JSON.parse(e)}catch(s){return i(r,s),void 0}}else e=JSON.stringify(e);i(r,null,e,n)},u=function(e,t){var n,r={status:e.status};try{n=JSON.parse(e.responseText),r=extend(!0,{},r,n)}catch(s){}i(t,r)};if("undefined"!=typeof window&&window.XMLHttpRequest){var a,f=!1,l=new XMLHttpRequest;l.open(t.method,t.url),l.withCredentials=!0,t.json&&(t.headers.Accept="application/json",t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.body&&t.processData&&"string"!=typeof t.body&&(t.body=JSON.stringify(t.body))),t.binary&&(l.responseType="arraybuffer");for(var c in t.headers)if("Cookie"===c){var h=t.headers[c].split("=");r(h[0],h[1],10)}else l.setRequestHeader(c,t.headers[c]);"body"in t||(t.body=null);var p=function(){f=!0,l.abort(),i(u,l,n)};return l.onreadystatechange=function(){if(4===l.readyState&&!f)if(clearTimeout(a),l.status>=200&&300>l.status){var e;e=t.binary?new Blob([l.response||""],{type:l.getResponseHeader("Content-Type")}):l.responseText,i(o,e,l,n)}else i(u,l,n)},t.timeout>0&&(a=setTimeout(p,t.timeout)),l.send(t.body),{abort:p}}return t.json&&(t.binary||(t.headers.Accept="application/json"),t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json"),t.binary&&(t.encoding=null,t.json=!1),t.processData||(t.json=!1),request(t,function(e,r,s){if(e)return e.status=r?r.statusCode:400,i(u,e,n);var a=r.headers["content-type"],f=s||"";if(t.binary||!t.json&&t.processData||"object"==typeof f||!(/json/.test(a)||/^[\s]*\{/.test(f)&&/\}[\s]*$/.test(f))||(f=JSON.parse(f)),r.statusCode>=200&&300>r.statusCode)i(o,f,r,n);else{if(t.binary)var f=JSON.parse(""+f);f.status=r.statusCode,i(n,f)}})};"undefined"!=typeof module&&module.exports&&(module.exports=ajax);var Pouch=function Pouch(e,t,n){if(!(this instanceof Pouch))return new Pouch(e,t,n);("function"==typeof t||t===void 0)&&(n=t,t={}),"object"==typeof e&&(t=e,e=void 0),n===void 0&&(n=function(){});var r=Pouch.parseAdapter(t.name||e);if(t.originalName=e,t.name=t.name||r.name,t.adapter=t.adapter||r.adapter,!Pouch.adapters[t.adapter])throw"Adapter is missing";if(!Pouch.adapters[t.adapter].valid())throw"Invalid Adapter";var i=new PouchAdapter(t,function(e,t){if(e)return n&&n(e),void 0;for(var r in Pouch.plugins){var i=Pouch.plugins[r](t);for(var s in i)s in t||(t[s]=i[s])}t.taskqueue.ready(!0),t.taskqueue.execute(t),n(null,t)});for(var s in i)this[s]=i[s];for(var o in Pouch.plugins){var u=Pouch.plugins[o](this);for(var a in u)a in this||(this[a]=u[a])}};if(Pouch.DEBUG=!1,Pouch.openReqList={},Pouch.adapters={},Pouch.plugins={},Pouch.prefix="_pouch_",Pouch.parseAdapter=function(e){var t,n=e.match(/([a-z\-]*):\/\/(.*)/);if(n){if(e=/http(s?)/.test(n[1])?n[1]+"://"+n[2]:n[2],t=n[1],!Pouch.adapters[t].valid())throw"Invalid adapter";return{name:e,adapter:n[1]}}for(var r=["idb","leveldb","websql"],i=0;r.length>i;++i)if(r[i]in Pouch.adapters){t=Pouch.adapters[r[i]];var s="use_prefix"in t?t.use_prefix:!0;return{name:s?Pouch.prefix+e:e,adapter:r[i]}}throw"No valid adapter found"},Pouch.destroy=function(e,t){var n=Pouch.parseAdapter(e),r=function(r){if(r)return t(r),void 0;for(var i in Pouch.plugins)Pouch.plugins[i]._delete(e);Pouch.DEBUG&&console.log(e+": Delete Database"),Pouch.adapters[n.adapter].destroy(n.name,t)};Pouch.removeFromAllDbs(n,r)},Pouch.removeFromAllDbs=function(e,t){if(!Pouch.enableAllDbs)return t(),void 0;var n=e.adapter;return"http"===n||"https"===n?(t(),void 0):(new Pouch(Pouch.allDBName(e.adapter),function(n,r){if(n)return console.error(n),t(),void 0;var i=Pouch.dbName(e.adapter,e.name);r.get(i,function(e,n){e?t():r.remove(n,function(e){e&&console.error(e),t()})})}),void 0)},Pouch.adapter=function(e,t){t.valid()&&(Pouch.adapters[e]=t)},Pouch.plugin=function(e,t){Pouch.plugins[e]=t},Pouch.enableAllDbs=!1,Pouch.ALL_DBS="_allDbs",Pouch.dbName=function(e,t){return[e,"-",t].join("")},Pouch.realDBName=function(e,t){return[e,"://",t].join("")},Pouch.allDBName=function(e){return[e,"://",Pouch.prefix+Pouch.ALL_DBS].join("")},Pouch.open=function(e,t){if(!Pouch.enableAllDbs)return t(),void 0;var n=e.adapter;return"http"===n||"https"===n?(t(),void 0):(new Pouch(Pouch.allDBName(n),function(r,i){if(r)return console.error(r),t(),void 0;var s=Pouch.dbName(n,e.name);i.get(s,function(n){n&&404===n.status?i.put({_id:s,dbname:e.originalName},function(e){e&&console.error(e),t()}):t()})}),void 0)},Pouch.allDbs=function(e){var t=function(n,r){if(0===n.length){var i=[];return r.forEach(function(e){var t=i.some(function(t){return t.id===e.id});t||i.push(e)}),e(null,i.map(function(e){return e.doc.dbname})),void 0}var s=n.shift();return"http"===s||"https"===s?(t(n,r),void 0):(new Pouch(Pouch.allDBName(s),function(i,s){return i?(e(i),void 0):(s.allDocs({include_docs:!0},function(i,s){return i?(e(i),void 0):(r.unshift.apply(r,s.rows),t(n,r),void 0)}),void 0)}),void 0)},n=Object.keys(Pouch.adapters);t(n,[])},Pouch.uuids=function(e,t){"object"!=typeof t&&(t={});for(var n=t.length,r=t.radix,i=[];e>i.push(Math.uuid(n,r)););return i},Pouch.uuid=function(e){return Pouch.uuids(1,e)[0]},Pouch.Errors={MISSING_BULK_DOCS:{status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"},MISSING_DOC:{status:404,error:"not_found",reason:"missing"},REV_CONFLICT:{status:409,error:"conflict",reason:"Document update conflict"},INVALID_ID:{status:400,error:"invalid_id",reason:"_id field must contain a string"},MISSING_ID:{status:412,error:"missing_id",reason:"_id is required for puts"},RESERVED_ID:{status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."},NOT_OPEN:{status:412,error:"precondition_failed",reason:"Database not open so cannot close"},UNKNOWN_ERROR:{status:500,error:"unknown_error",reason:"Database encountered an unknown error"},BAD_ARG:{status:500,error:"badarg",reason:"Some query argument is invalid"},INVALID_REQUEST:{status:400,error:"invalid_request",reason:"Request was invalid"},QUERY_PARSE_ERROR:{status:400,error:"query_parse_error",reason:"Some query parameter is invalid"},DOC_VALIDATION:{status:500,error:"doc_validation",reason:"Bad special document member"},BAD_REQUEST:{status:400,error:"bad_request",reason:"Something wrong with the request"},NOT_AN_OBJECT:{status:400,error:"bad_request",reason:"Document must be a JSON object"}},Pouch.error=function(e,t){return extend({},e,{reason:t})},"undefined"!=typeof module&&module.exports){global.Pouch=Pouch,global.PouchDB=Pouch,Pouch.merge=require("./pouch.merge.js").merge,Pouch.collate=require("./pouch.collate.js").collate,Pouch.replicate=require("./pouch.replicate.js").replicate,Pouch.utils=require("./pouch.utils.js"),extend=Pouch.utils.extend,module.exports=Pouch;var PouchAdapter=require("./pouch.adapter.js"),adapters=["leveldb","http"];adapters.map(function(e){var t="./adapters/pouch."+e+".js";require(t)}),require("./plugins/pouchdb.mapreduce.js"),require("./deps/uuid.js")}else window.Pouch=Pouch,window.PouchDB=Pouch;"undefined"!=typeof module&&module.exports&&(module.exports=Pouch);var stringCollate=function(e,t){return e===t?0:e>t?1:-1},objectCollate=function(e,t){for(var n=Object.keys(e),r=Object.keys(t),i=Math.min(n.length,r.length),s=0;i>s;s++){var o=Pouch.collate(n[s],r[s]);if(0!==o)return o;if(o=Pouch.collate(e[n[s]],t[r[s]]),0!==o)return o}return n.length===r.length?0:n.length>r.length?1:-1},arrayCollate=function(e,t){for(var n=Math.min(e.length,t.length),r=0;n>r;r++){var i=Pouch.collate(e[r],t[r]);if(0!==i)return i}return e.length===t.length?0:e.length>t.length?1:-1},collationIndex=function(e){var t=["boolean","number","string","object"];return-1!==t.indexOf(typeof e)?null===e?1:t.indexOf(typeof e)+2:Array.isArray(e)?4.5:void 0};if(Pouch.collate=function(e,t){var n=collationIndex(e),r=collationIndex(t);return 0!==n-r?n-r:null===e?0:"number"==typeof e?e-t:"boolean"==typeof e?t>e?-1:1:"string"==typeof e?stringCollate(e,t):Array.isArray(e)?arrayCollate(e,t):"object"==typeof e?objectCollate(e,t):void 0},"undefined"!=typeof module&&module.exports){module.exports=Pouch;var utils=require("./pouch.utils.js");for(var k in utils)global[k]=utils[k]}Pouch.merge=function(e,t,n){e=extend(!0,[],e),t=extend(!0,{},t);var r=doMerge(e,t);return{tree:stem(r.tree,n),conflicts:r.conflicts}},Pouch.merge.winningRev=function(e){var t=[];return Pouch.merge.traverseRevTree(e.rev_tree,function(e,n,r,i,s){e&&t.push({pos:n,id:r,deleted:!!s.deleted})}),t.sort(function(e,t){return e.deleted!==t.deleted?e.deleted>t.deleted?1:-1:e.pos!==t.pos?t.pos-e.pos:e.id<t.id?1:-1}),t[0].pos+"-"+t[0].id},Pouch.merge.traverseRevTree=function(e,t){var n=[];for(e.forEach(function(e){n.push({pos:e.pos,ids:e.ids})});n.length>0;){var r=n.pop(),i=r.pos,s=r.ids,o=t(0===s[2].length,i,s[0],r.ctx,s[1]);s[2].forEach(function(e){n.push({pos:i+1,ids:e,ctx:o})})}},Pouch.merge.collectLeaves=function(e){var t=[];return Pouch.merge.traverseRevTree(e,function(e,n,r,i,s){e&&t.unshift({rev:n+"-"+r,pos:n,opts:s})}),t.sort(function(e,t){return t.pos-e.pos}),t.map(function(e){delete e.pos}),t},Pouch.merge.collectConflicts=function(e){var t=Pouch.merge.winningRev(e),n=Pouch.merge.collectLeaves(e.rev_tree),r=[];return n.forEach(function(e){e.rev===t||e.opts.deleted||r.push(e.rev)}),r},"undefined"!=typeof module&&module.exports&&(module.exports=Pouch);var Promise=function(){this.cancelled=!1,this.cancel=function(){this.cancelled=!0}},RequestManager=function(){var e=[],t={},n=!1;return t.enqueue=function(r,i){e.push({fun:r,args:i}),n||t.process()},t.process=function(){if(!n&&e.length){n=!0;var t=e.shift();t.fun.apply(null,t.args)}},t.notifyRequestComplete=function(){n=!1,t.process()},t},genReplicationId=function(e,t,n){var r=n.filter?""+n.filter:"";return"_local/"+Crypto.MD5(e.id()+t.id()+r)},fetchCheckpoint=function(e,t,n){e.get(t,function(e,t){e&&404===e.status?n(null,0):n(null,t.last_seq)})},writeCheckpoint=function(e,t,n,r){var i={_id:t,last_seq:n};e.get(i._id,function(t,n){n&&n._rev&&(i._rev=n._rev),e.put(i,function(){r()})})};Pouch.replicate=function(e,t,n,r){n instanceof Function&&(r=n,n={}),void 0===n&&(n={}),n.complete||(n.complete=r);var i=new Promise;return toPouch(e,function(e,s){return e?call(r,e):(toPouch(t,function(e,t){return e?call(r,e):(replicate(s,t,n,i),void 0)}),void 0)}),i};var call=function(e){if(typeof e==typeof Function){var t=Array.prototype.slice.call(arguments,1);e.apply(this,t)}},yankError=function(e){return function(t,n){t||n[0].error?call(e,t||n[0]):call(e,null,n[0])}},isLocalId=function(e){return/^_local/.test(e)},isAttachmentId=function(e){return/\//.test(e)&&!isLocalId(e)&&!/^_design/.test(e)},isValidId=function(e){return/^_/.test(e)?/^_(design|local)/.test(e):!0},reservedWords=["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree"],parseDoc=function(e,t){var n,r,i,s=null,o={status:"available"};if(e._deleted&&(o.deleted=!0),t)if(e._id||(e._id=Pouch.uuid()),r=Pouch.uuid({length:32,radix:16}).toLowerCase(),e._rev){if(i=/^(\d+)-(.+)$/.exec(e._rev),!i)throw"invalid value for property '_rev'";e._rev_tree=[{pos:parseInt(i[1],10),ids:[i[2],{status:"missing"},[[r,o,[]]]]}],n=parseInt(i[1],10)+1}else e._rev_tree=[{pos:1,ids:[r,o,[]]}],n=1;else if(e._revisions&&(e._rev_tree=[{pos:e._revisions.start-e._revisions.ids.length+1,ids:e._revisions.ids.reduce(function(e,t){return null===e?[t,o,[]]:[t,{status:"missing"},[e]]},null)}],n=e._revisions.start,r=e._revisions.ids[0]),!e._rev_tree){if(i=/^(\d+)-(.+)$/.exec(e._rev),!i)return Pouch.Errors.BAD_ARG;n=parseInt(i[1],10),r=i[2],e._rev_tree=[{pos:parseInt(i[1],10),ids:[i[2],o,[]]}]}"string"!=typeof e._id?s=Pouch.Errors.INVALID_ID:isValidId(e._id)||(s=Pouch.Errors.RESERVED_ID);for(var u in e)e.hasOwnProperty(u)&&"_"===u[0]&&-1===reservedWords.indexOf(u)&&(s=extend({},Pouch.Errors.DOC_VALIDATION),s.reason+=": "+u);return e._id=decodeURIComponent(e._id),e._rev=[n,r].join("-"),s?s:Object.keys(e).reduce(function(t,n){return/^_/.test(n)&&"_attachments"!==n?t.metadata[n.slice(1)]=e[n]:t.data[n]=e[n],t},{metadata:{},data:{}})},compareRevs=function(e,t){return e.id!==t.id?e.id<t.id?-1:1:e.deleted^t.deleted?e.deleted?-1:1:e.rev_tree[0].pos===t.rev_tree[0].pos?e.rev_tree[0].ids<t.rev_tree[0].ids?-1:1:e.rev_tree[0].start<t.rev_tree[0].start?-1:1},computeHeight=function(e){var t={},n=[];return Pouch.merge.traverseRevTree(e,function(e,r,i,s){var o=r+"-"+i;return e&&(t[o]=0),void 0!==s&&n.push({from:s,to:o}),o}),n.reverse(),n.forEach(function(e){t[e.from]=void 0===t[e.from]?1+t[e.to]:Math.min(t[e.from],1+t[e.to])}),t},arrayFirst=function(e,t){for(var n=0;e.length>n;n++)if(t(e[n],n)===!0)return e[n];return!1},filterChange=function(e){return function(t){var n={};if(n.query=e.query_params,e.filter&&!e.filter.call(this,t.doc,n))return!1;if(e.doc_ids&&-1!==e.doc_ids.indexOf(t.id))return!1;if(e.include_docs)for(var r in t.doc._attachments)t.doc._attachments[r].stub=!0;else delete t.doc;return!0}},processChanges=function(e,t,n){t=t.filter(filterChange(e)),e.limit&&e.limit<t.length&&(t.length=e.limit),t.forEach(function(t){call(e.onChange,t)}),call(e.complete,null,{results:t,last_seq:n})},rootToLeaf=function(e){var t=[];return Pouch.merge.traverseRevTree(e,function(e,n,r,i,s){if(i=i?i.slice(0):[],i.push({id:r,opts:s}),e){var o=n+1-i.length;t.unshift({pos:o,ids:i})}return i}),t},isDeleted=function(e,t){t||(t=Pouch.merge.winningRev(e)),t.indexOf("-")>=0&&(t=t.split("-")[1]);var n=!1;return Pouch.merge.traverseRevTree(e.rev_tree,function(e,r,i,s,o){i===t&&(n=!!o.deleted)}),n},isChromeApp=function(){return"undefined"!=typeof chrome&&chrome.storage!==void 0&&chrome.storage.local!==void 0},isCordova=function(){return"undefined"!=typeof cordova||"undefined"!=typeof PhoneGap||"undefined"!=typeof phonegap};if("undefined"!=typeof module&&module.exports){var crypto=require("crypto"),Crypto={MD5:function(e){return crypto.createHash("md5").update(e).digest("hex")}},extend=require("./deps/extend"),ajax=require("./deps/ajax");request=require("request"),_=require("underscore"),$=_,module.exports={Crypto:Crypto,call:call,yankError:yankError,isLocalId:isLocalId,isAttachmentId:isAttachmentId,parseDoc:parseDoc,isDeleted:isDeleted,compareRevs:compareRevs,computeHeight:computeHeight,arrayFirst:arrayFirst,filterChange:filterChange,processChanges:processChanges,atob:function(e){var t=new Buffer(e,"base64");if(t.toString("base64")!==e)throw"Cannot base64 encode full string";return t.toString("binary")},btoa:function(e){return(new Buffer(e,"binary")).toString("base64")},extend:extend,ajax:ajax,rootToLeaf:rootToLeaf,isChromeApp:isChromeApp,isCordova:isCordova}}var Changes=function(){var e={},t={};return isChromeApp()?chrome.storage.onChanged.addListener(function(t){e.notify(t.db_name.newValue)}):window.addEventListener("storage",function(t){e.notify(t.key)}),e.addListener=function(e,n,r,i){t[e]||(t[e]={}),t[e][n]={db:r,opts:i}},e.removeListener=function(e,n){delete t[e][n]},e.clearListeners=function(e){delete t[e]},e.notifyLocalWindows=function(e){isChromeApp()?chrome.storage.local.set({db_name:e}):localStorage[e]="a"===localStorage[e]?"b":"a"},e.notify=function(e){t[e]&&Object.keys(t[e]).forEach(function(n){var r=t[e][n].opts;t[e][n].db.changes({include_docs:r.include_docs,conflicts:r.conflicts,continuous:!1,descending:!1,filter:r.filter,since:r.since,query_params:r.query_params,onChange:function(e){e.seq>r.since&&!r.cancelled&&(r.since=e.seq,call(r.onChange,e))}})})},e},PouchAdapter=function(e,t){var n={},r=Pouch.adapters[e.adapter](e,function(r,i){if(r)return t&&t(r),void 0;for(var s in n)i.hasOwnProperty(s)||(i[s]=n[s]);e.name===Pouch.prefix+Pouch.ALL_DBS?t(r,i):Pouch.open(e,function(e){t(e,i)})}),i=e.auto_compaction===!0,s=function(e){return i?function(t,n){if(t)call(e,t);else{var r=n.length,i=function(){r--,r||call(e,null,n)};n.forEach(function(e){e.ok?o(e.id,1,i):i()})}}:e};n.post=function(e,t,n){return"function"==typeof t&&(n=t,t={}),"object"!=typeof e||Array.isArray(e)?call(n,Pouch.Errors.NOT_AN_OBJECT):r.bulkDocs({docs:[e]},t,s(yankError(n)))},n.put=function(e,t,n){return"function"==typeof t&&(n=t,t={}),"object"!=typeof e?call(n,Pouch.Errors.NOT_AN_OBJECT):"_id"in e?r.bulkDocs({docs:[e]},t,s(yankError(n))):call(n,Pouch.Errors.MISSING_ID)},n.putAttachment=function(e,t,r,i,s,o){function u(e){e._attachments=e._attachments||{},e._attachments[t]={content_type:s,data:i},n.put(e,o)}"function"==typeof s&&(o=s,s=i,i=r,r=null),s===void 0&&(s=i,i=r,r=null),n.get(e,function(t,n){return t&&t.error===Pouch.Errors.MISSING_DOC.error?(u({_id:e}),void 0):t?(call(o,t),void 0):n._rev!==r?(call(o,Pouch.Errors.REV_CONFLICT),void 0):(u(n),void 0)})},n.removeAttachment=function(e,t,r,i){n.get(e,function(e,s){return e?(call(i,e),void 0):s._rev!==r?(call(i,Pouch.Errors.REV_CONFLICT),void 0):s._attachments?(delete s._attachments[t],0===Object.keys(s._attachments).length&&delete s._attachments,n.put(s,i),void 0):call(i,null)})},n.remove=function(e,t,n){"function"==typeof t&&(n=t,t={}),void 0===t&&(t={}),t.was_delete=!0;var i={_id:e._id,_rev:e._rev};return i._deleted=!0,r.bulkDocs({docs:[i]},t,yankError(n))},n.revsDiff=function(e,t,r){function i(t,n,i){return e[i].map(function(e){var t=function(t){return t.rev!==e};(!n||n._revs_info.every(t))&&(u[i]||(u[i]={missing:[]}),u[i].missing.push(e))}),++o===s.length?call(r,null,u):void 0}"function"==typeof t&&(r=t,t={});var s=Object.keys(e),o=0,u={};s.map(function(e){n.get(e,{revs_info:!0},function(t,n){i(t,n,e)})})};var o=function(e,t,n){r._getRevisionTree(e,function(i,s){if(i)return call(n);var o=computeHeight(s),u=[],a=[];Object.keys(o).forEach(function(e){o[e]>t&&u.push(e)}),Pouch.merge.traverseRevTree(s,function(e,t,n,r,i){var s=t+"-"+n;"available"===i.status&&-1!==u.indexOf(s)&&(i.status="missing",a.push(s))}),r._doCompaction(e,s,a,n)})};n.compact=function(e){n.changes({complete:function(t,n){if(t)return call(e),void 0;var r=n.results.length;return r?(n.results.forEach(function(t){o(t.id,0,function(){r--,r||call(e)})}),void 0):(call(e),void 0)}})},n.get=function(e,t,i){function s(){var r=[],s=o.length;return s?(o.forEach(function(o){n.get(e,{rev:o,revs:t.revs},function(e,t){e?r.push({missing:o}):r.push({ok:t}),s--,s||call(i,null,r)})}),void 0):call(i,null,r)}if(!n.taskqueue.ready())return n.taskqueue.addTask("get",arguments),void 0;"function"==typeof t&&(i=t,t={});var o=[];if(!t.open_revs)return r._get(e,t,function(e,n){if(e)return call(i,e);var s=n.doc,o=n.metadata,u=n.ctx;if(t.conflicts){var a=Pouch.merge.collectConflicts(o);a.length&&(s._conflicts=a)}if(t.revs||t.revs_info){var f=rootToLeaf(o.rev_tree),l=arrayFirst(f,function(e){return-1!==e.ids.map(function(e){return e.id}).indexOf(s._rev.split("-")[1])});if(l.ids.splice(l.ids.map(function(e){return e.id}).indexOf(s._rev.split("-")[1])+1),l.ids.reverse(),t.revs&&(s._revisions={start:l.pos+l.ids.length-1,ids:l.ids.map(function(e){return e.id})}),t.revs_info){var c=l.pos+l.ids.length;s._revs_info=l.ids.map(function(e){return c--,{rev:c+"-"+e.id,status:e.opts.status}})}}if(t.local_seq&&(s._local_seq=n.metadata.seq),t.attachments&&s._attachments){var h=s._attachments,p=Object.keys(h).length;if(0===p)return call(i,null,s);Object.keys(h).forEach(function(e){r._getAttachment(h[e],{encode:!0,ctx:u},function(t,n){s._attachments[e].data=n,--p||call(i,null,s)})})}else{if(s._attachments)for(var d in s._attachments)s._attachments[d].stub=!0;call(i,null,s)}});if("all"===t.open_revs)r._getRevisionTree(e,function(e,t){e&&(t=[]),o=Pouch.merge.collectLeaves(t).map(function(e){return e.rev}),s()});else{if(!Array.isArray(t.open_revs))return call(i,Pouch.error(Pouch.Errors.UNKNOWN_ERROR,"function_clause"));o=t.open_revs;for(var u=0;o.length>u;u++){var a=o[u];if("string"!=typeof a||!/^\d+-/.test(a))return call(i,Pouch.error(Pouch.Errors.BAD_REQUEST,"Invalid rev format"))}s()}},n.getAttachment=function(e,t,n,i){n instanceof Function&&(i=n,n={}),r._get(e,n,function(e,s){return e?call(i,e):s.doc._attachments&&s.doc._attachments[t]?(n.ctx=s.ctx,r._getAttachment(s.doc._attachments[t],n,i),void 0):call(i,Pouch.Errors.MISSING_DOC)})},n.allDocs=function(e,t){if(!n.taskqueue.ready())return n.taskqueue.addTask("allDocs",arguments),void 0;if("function"==typeof e&&(t=e,e={}),"keys"in e){if("startkey"in e)return call(t,Pouch.error(Pouch.Errors.QUERY_PARSE_ERROR,"Query parameter `start_key` is not compatible with multi-get")),void 0;if("endkey"in e)return call(t,Pouch.error(Pouch.Errors.QUERY_PARSE_ERROR,"Query parameter `end_key` is not compatible with multi-get")),void 0}return r._allDocs(e,t)},n.changes=function(e){return n.taskqueue.ready()?(e=extend(!0,{},e),e.since||(e.since=0),"descending"in e||(e.descending=!1),e.limit=0===e.limit?1:e.limit,r._changes(e)):(n.taskqueue.addTask("changes",arguments),void 0)},n.close=function(e){return n.taskqueue.ready()?r._close(e):(n.taskqueue.addTask("close",arguments),void 0)},n.info=function(e){return n.taskqueue.ready()?r._info(e):(n.taskqueue.addTask("info",arguments),void 0)},n.id=function(){return r._id()},n.type=function(){return"function"==typeof r._type?r._type():e.adapter},n.bulkDocs=function(e,t,i){if(!n.taskqueue.ready())return n.taskqueue.addTask("bulkDocs",arguments),void 0;if("function"==typeof t&&(i=t,t={}),t=t?extend(!0,{},t):{},!e||!e.docs||1>e.docs.length)return call(i,Pouch.Errors.MISSING_BULK_DOCS);if(!Array.isArray(e.docs))return call(i,Pouch.Errors.QUERY_PARSE_ERROR);for(var o=0;e.docs.length>o;++o)if("object"!=typeof e.docs[o]||Array.isArray(e.docs[o]))return call(i,Pouch.Errors.NOT_AN_OBJECT);return e=extend(!0,{},e),"new_edits"in t||(t.new_edits=!0),r._bulkDocs(e,t,s(i))};var u={};u.ready=!1,u.queue=[],n.taskqueue={},n.taskqueue.execute=function(e){u.ready&&u.queue.forEach(function(t){e[t.task].apply(null,t.parameters)})},n.taskqueue.ready=function(){return 0===arguments.length?u.ready:(u.ready=arguments[0],void 0)},n.taskqueue.addTask=function(e,t){u.queue.push({task:e,parameters:t})},n.replicate={},n.replicate.from=function(e,t,n){return"function"==typeof t&&(n=t,t={}),Pouch.replicate(e,r,t,n)},n.replicate.to=function(e,t,n){return"function"==typeof t&&(n=t,t={}),Pouch.replicate(r,e,t,n)};for(var a in n)r.hasOwnProperty(a)||(r[a]=n[a]);return e.skipSetup&&(n.taskqueue.ready(!0),n.taskqueue.execute(n)),isCordova()&&cordova.fireWindowEvent(e.name+"_pouch",{}),r};"undefined"!=typeof module&&module.exports&&(module.exports=PouchAdapter);var HTTP_TIMEOUT=1e4;parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var HttpPouch=function(e,t){var n=getHost(e.name);if(n.headers=e.headers||{},e.auth){var r=btoa(e.auth.username+":"+e.auth.password);n.headers.Authorization="Basic "+r}e.headers&&(n.headers=e.headers);var i=genDBUrl(n,""),s={},o={list:[],get:function(e,t){"function"==typeof e&&(t=e,e={count:10});var r=function(e,n){!e&&"uuids"in n?(o.list=o.list.concat(n.uuids),call(t,null,"OK")):call(t,e||Pouch.Errors.UNKNOWN_ERROR)},i="?count="+e.count;ajax({headers:n.headers,method:"GET",url:genUrl(n,"_uuids")+i},r)}},u=function(){ajax({headers:n.headers,method:"PUT",url:i},function(e){e&&401===e.status?ajax({headers:n.headers,method:"HEAD",url:i},function(e){e?call(t,e):call(t,null,s)}):e&&412!==e.status?call(t,Pouch.Errors.UNKNOWN_ERROR):call(t,null,s)})};return e.skipSetup||ajax({headers:n.headers,method:"GET",url:i},function(e){e?404===e.status?u():call(t,e):call(t,null,s)}),s.type=function(){return"http"},s.id=function(){return genDBUrl(n,"")},s.request=function(e,t){return s.taskqueue.ready()?(e.headers=n.headers,e.url=genDBUrl(n,e.url),ajax(e,t),void 0):(s.taskqueue.addTask("request",arguments),void 0)},s.compact=function(e,t){return s.taskqueue.ready()?("function"==typeof e&&(t=e,e={}),ajax({headers:n.headers,url:genDBUrl(n,"_compact"),method:"POST"},function(){function n(){s.info(function(r,i){i.compact_running?setTimeout(n,e.interval||200):call(t,null)})}"function"==typeof t&&n()}),void 0):(s.taskqueue.addTask("compact",arguments),void 0)},s.info=function(e){return s.taskqueue.ready()?(ajax({headers:n.headers,method:"GET",url:genDBUrl(n,"")},e),void 0):(s.taskqueue.addTask("info",arguments),void 0)},s.get=function(e,t,r){if(!s.taskqueue.ready())return s.taskqueue.addTask("get",arguments),void 0;"function"==typeof t&&(r=t,t={}),void 0===t.auto_encode&&(t.auto_encode=!0);var i=[];t.revs&&i.push("revs=true"),t.revs_info&&i.push("revs_info=true"),t.local_seq&&i.push("local_seq=true"),t.open_revs&&("all"!==t.open_revs&&(t.open_revs=JSON.stringify(t.open_revs)),i.push("open_revs="+t.open_revs)),t.attachments&&i.push("attachments=true"),t.rev&&i.push("rev="+t.rev),t.conflicts&&i.push("conflicts="+t.conflicts),i=i.join("&"),i=""===i?"":"?"+i,t.auto_encode&&(e=encodeDocId(e));var o={headers:n.headers,method:"GET",url:genDBUrl(n,e+i)},u=e.split("/");(u.length>1&&"_design"!==u[0]&&"_local"!==u[0]||u.length>2&&"_design"===u[0]&&"_local"!==u[0])&&(o.binary=!0),ajax(o,function(e,t,n){return e?call(r,e):(call(r,null,t,n),void 0)})},s.remove=function(e,t,r){return s.taskqueue.ready()?("function"==typeof t&&(r=t,t={}),ajax({headers:n.headers,method:"DELETE",url:genDBUrl(n,encodeDocId(e._id))+"?rev="+e._rev},r),void 0):(s.taskqueue.addTask("remove",arguments),void 0)},s.getAttachment=function(e,t,n,r){"function"==typeof n&&(r=n,n={}),void 0===n.auto_encode&&(n.auto_encode=!0),n.auto_encode&&(e=encodeDocId(e)),n.auto_encode=!1,s.get(e+"/"+t,n,r)},s.removeAttachment=function(e,t,r,i){return s.taskqueue.ready()?(ajax({headers:n.headers,method:"DELETE",url:genDBUrl(n,encodeDocId(e)+"/"+t)+"?rev="+r},i),void 0):(s.taskqueue.addTask("removeAttachment",arguments),void 0)},s.putAttachment=function(e,t,r,i,o,u){if(!s.taskqueue.ready())return s.taskqueue.addTask("putAttachment",arguments),void 0;"function"==typeof o&&(u=o,o=i,i=r,r=null),o===void 0&&(o=i,i=r,r=null);var f=encodeDocId(e)+"/"+t,l=genDBUrl(n,f);r&&(l+="?rev="+r);var c={headers:n.headers,method:"PUT",url:l,processData:!1,body:i};c.headers["Content-Type"]=o,ajax(c,u)},s.put=function(e,t,r){if(!s.taskqueue.ready())return s.taskqueue.addTask("put",arguments),void 0;if("function"==typeof t&&(r=t,t={}),"object"!=typeof e)return call(r,Pouch.Errors.NOT_AN_OBJECT);if(!("_id"in e))return call(r,Pouch.Errors.MISSING_ID);var i=[];t&&t.new_edits!==void 0&&i.push("new_edits="+t.new_edits),i=i.join("&"),""!==i&&(i="?"+i),ajax({headers:n.headers,method:"PUT",url:genDBUrl(n,encodeDocId(e._id))+i,body:e},r)},s.post=function(e,t,n){return s.taskqueue.ready()?("function"==typeof t&&(n=t,t={}),"object"!=typeof e?call(n,Pouch.Errors.NOT_AN_OBJECT):("_id"in e?s.put(e,t,n):o.list.length>0?(e._id=o.list.pop(),s.put(e,t,n)):o.get(function(r){return r?call(n,Pouch.Errors.UNKNOWN_ERROR):(e._id=o.list.pop(),s.put(e,t,n),void 0)}),void 0)):(s.taskqueue.addTask("post",arguments),void 0)},s.bulkDocs=function(e,t,r){return s.taskqueue.ready()?("function"==typeof t&&(r=t,t={}),t||(t={}),t.new_edits!==void 0&&(e.new_edits=t.new_edits),ajax({headers:n.headers,method:"POST",url:genDBUrl(n,"_bulk_docs"),body:e},r),void 0):(s.taskqueue.addTask("bulkDocs",arguments),void 0)},s.allDocs=function(e,t){if(!s.taskqueue.ready())return s.taskqueue.addTask("allDocs",arguments),void 0;"function"==typeof e&&(t=e,e={});var r,i=[],o="GET";e.conflicts&&i.push("conflicts=true"),e.descending&&i.push("descending=true"),e.include_docs&&i.push("include_docs=true"),e.startkey&&i.push("startkey="+encodeURIComponent(JSON.stringify(e.startkey))),e.endkey&&i.push("endkey="+encodeURIComponent(JSON.stringify(e.endkey))),e.limit&&i.push("limit="+e.limit),i=i.join("&"),""!==i&&(i="?"+i),e.keys!==void 0&&(o="POST",r=JSON.stringify({keys:e.keys})),ajax({headers:n.headers,method:o,url:genDBUrl(n,"_all_docs"+i),body:r},t)},s.changes=function(e){var t=25;if(!s.taskqueue.ready())return s.taskqueue.addTask("changes",arguments),void 0;Pouch.DEBUG&&console.log(i+": Start Changes Feed: continuous="+e.continuous);var r={},o=e.limit!==void 0?e.limit:!1;0===o&&(o=1);var u=o;if(e.style&&(r.style=e.style),(e.include_docs||e.filter&&"function"==typeof e.filter)&&(r.include_docs=!0),e.continuous&&(r.feed="longpoll"),e.conflicts&&(r.conflicts=!0),e.descending&&(r.descending=!0),e.filter&&"string"==typeof e.filter&&(r.filter=e.filter),e.query_params&&"object"==typeof e.query_params)for(var f in e.query_params)e.query_params.hasOwnProperty(f)&&(r[f]=e.query_params[f]);var l,c,h,p=function(i,s){r.since=i,r.limit=!o||u>t?t:u;var a="?"+Object.keys(r).map(function(e){return e+"="+r[e]}).join("&"),f={headers:n.headers,method:"GET",url:genDBUrl(n,"_changes"+a),timeout:null};c=i,e.aborted||(l=ajax(f,s))},d=10,v=0,m=function(t,n){if(n&&n.results){var r=e.filter&&"function"==typeof e.filter,i={};i.query=e.query_params,n.results=n.results.filter(function(t){return u--,e.aborted||r&&!e.filter.apply(this,[t.doc,i])?!1:e.doc_ids&&-1!==e.doc_ids.indexOf(t.id)?!1:(call(e.onChange,t),!0)})}n&&n.last_seq&&(c=n.last_seq);var s=o&&0>=u||!o&&c===h||e.descending&&0!==c;if(e.continuous||!s){t?v+=1:v=0;var a=1<<v,f=d*a,l=e.maximumWait||3e4;f>l&&call(e.complete,t||Pouch.Errors.UNKNOWN_ERROR,null),setTimeout(function(){p(c,m)},f)}else call(e.complete,null,n)};return e.continuous?p(e.since||0,m):s.info(function(t,n){h=n.update_seq,p(e.since||0,m)}),{cancel:function(){Pouch.DEBUG&&console.log(i+": Cancel Changes Feed"),e.aborted=!0,l.abort()}}},s.revsDiff=function(e,t,r){return s.taskqueue.ready()?("function"==typeof t&&(r=t,t={}),ajax({headers:n.headers,method:"POST",url:genDBUrl(n,"_revs_diff"),body:e},function(e,t){call(r,e,t)}),void 0):(s.taskqueue.addTask("revsDiff",arguments),void 0)},s.close=function(e){return s.taskqueue.ready()?(call(e,null),void 0):(s.taskqueue.addTask("close",arguments),void 0)},s};if(HttpPouch.destroy=function(e,t){var n=getHost(e);ajax({headers:n.headers,method:"DELETE",url:genDBUrl(n,"")},t)},HttpPouch.valid=function(){return!0},"undefined"!=typeof module&&module.exports){var pouchdir="../";Pouch=require(pouchdir+"pouch.js"),ajax=Pouch.utils.ajax}Pouch.adapter("http",HttpPouch),Pouch.adapter("https",HttpPouch);var indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB,IDBTransaction=window.IDBTransaction&&window.IDBTransaction.READ_WRITE?window.IDBTransaction:window.webkitIDBTransaction&&window.webkitIDBTransaction.READ_WRITE?window.webkitIDBTransaction:{READ_WRITE:"readwrite"},IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,idbError=function(e){return function(t){call(e,{status:500,error:t.type,reason:t.target})}},IdbPouch=function(opts,callback){function createSchema(e){e.createObjectStore(DOC_STORE,{keyPath:"id"}).createIndex("seq","seq",{unique:!0}),e.createObjectStore(BY_SEQ_STORE,{autoIncrement:!0}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0}),e.createObjectStore(ATTACH_STORE,{keyPath:"digest"}),e.createObjectStore(META_STORE,{keyPath:"id",autoIncrement:!1}),e.createObjectStore(DETECT_BLOB_SUPPORT_STORE)}function fixBinary(e){for(var t=e.length,n=new ArrayBuffer(t),r=new Uint8Array(n),i=0;t>i;i++)r[i]=e.charCodeAt(i);return n}function sortByBulkSeq(e,t){return e._bulk_seq-t._bulk_seq}var POUCH_VERSION=1,DOC_STORE="document-store",BY_SEQ_STORE="by-sequence",ATTACH_STORE="attach-store",META_STORE="meta-store",DETECT_BLOB_SUPPORT_STORE="detect-blob-support",name=opts.name,req=indexedDB.open(name,POUCH_VERSION);Pouch.openReqList&&(Pouch.openReqList[name]=req);var blobSupport=null,instanceId=null,api={},idb=null;return Pouch.DEBUG&&console.log(name+": Open Database"),req.onupgradeneeded=function(e){for(var t=e.target.result,n=e.oldVersion;n!==e.newVersion;)0===n&&createSchema(t),n++},req.onsuccess=function(e){idb=e.target.result;var t=idb.transaction([META_STORE,DETECT_BLOB_SUPPORT_STORE],IDBTransaction.READ_WRITE);if(idb.onversionchange=function(){idb.close()},idb.setVersion&&Number(idb.version)!==POUCH_VERSION){var n=idb.setVersion(POUCH_VERSION);return n.onsuccess=function(t){function n(){r.onsuccess(e)}t.target.result.oncomplete=n,r.onupgradeneeded(e)},void 0}var r=t.objectStore(META_STORE).get(META_STORE);r.onsuccess=function(e){var n=e.target.result||{id:META_STORE};name+"_id"in n?instanceId=n[name+"_id"]:(instanceId=Pouch.uuid(),n[name+"_id"]=instanceId,t.objectStore(META_STORE).put(n));try{t.objectStore(DETECT_BLOB_SUPPORT_STORE).put(new Blob,"key"),blobSupport=!0}catch(r){blobSupport=!1}finally{call(callback,null,api)}}},req.onerror=idbError(callback),api.type=function(){return"idb"},api.id=function(){return instanceId},api._bulkDocs=function(t,n,r){function i(e){var t=e.target.result;t.updateSeq=(t.updateSeq||0)+w,y.objectStore(META_STORE).put(t)}function s(){if(!m.length)return y.objectStore(META_STORE).get(META_STORE).onsuccess=i,void 0;var e=m.shift(),t=y.objectStore(DOC_STORE).get(e.metadata.id);t.onsuccess=function(t){var n=t.target.result;n?l(n,e):c(e)}}function o(){var e=[];b.sort(sortByBulkSeq),b.forEach(function(t){if(delete t._bulk_seq,t.error)return e.push(t),void 0;var n=t.metadata,r=Pouch.merge.winningRev(n);e.push({ok:!0,id:n.id,rev:r}),isLocalId(n.id)||(IdbPouch.Changes.notify(name),IdbPouch.Changes.notifyLocalWindows(name))}),call(r,null,e)}function u(e,t){if(e.stub)return t();if("string"==typeof e.data){var n;try{n=atob(e.data)}catch(i){var s=Pouch.error(Pouch.Errors.BAD_ARG,"Attachments need to be base64 encoded");return call(r,s)}if(e.digest="md5-"+Crypto.MD5(n),blobSupport){var o=e.content_type;n=fixBinary(n),e.data=new Blob([n],{type:o})}return t()}var u=new FileReader;u.onloadend=function(){e.digest="md5-"+Crypto.MD5(this.result),blobSupport||(e.data=btoa(this.result)),t()},u.readAsBinaryString(e.data)}function a(e){function t(){n++,m.length===n&&e()}if(!m.length)return e();var n=0;m.forEach(function(e){function n(){i++,i===r.length&&t()}var r=e.data&&e.data._attachments?Object.keys(e.data._attachments):[];if(!r.length)return t();var i=0;for(var s in e.data._attachments)u(e.data._attachments[s],n)})}function f(e,t){function n(e){s||(e?(s=e,call(t,s)):o===u.length&&i())}function r(e){o++,n(e)}function i(){e.data._doc_id_rev=e.data._id+"::"+e.data._rev;var n=y.objectStore(BY_SEQ_STORE).put(e.data);n.onsuccess=function(n){Pouch.DEBUG&&console.log(name+": Wrote Document ",e.metadata.id),e.metadata.seq=n.target.result,delete e.metadata.rev;var r=y.objectStore(DOC_STORE).put(e.metadata);r.onsuccess=function(){b.push(e),call(t)}}}var s=null,o=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,w++,isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var u=e.data._attachments?Object.keys(e.data._attachments):[];for(var a in e.data._attachments)if(e.data._attachments[a].stub)o++,n();else{var f=e.data._attachments[a].data;delete e.data._attachments[a].data;var l=e.data._attachments[a].digest;p(e,l,f,r)}u.length||i()}function l(e,t){var n=Pouch.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),r=isDeleted(e),i=r&&isDeleted(t.metadata)||!r&&d&&"new_leaf"!==n.conflicts;return i?(b.push(h(Pouch.Errors.REV_CONFLICT,t._bulk_seq)),s()):(t.metadata.rev_tree=n.tree,f(t,s),void 0)}function c(e){return"was_delete"in n&&isDeleted(e.metadata)?(b.push(Pouch.Errors.MISSING_DOC),s()):(f(e,s),void 0)}function h(e,t){return e._bulk_seq=t,e}function p(e,t,n,r){var i=y.objectStore(ATTACH_STORE);i.get(t).onsuccess=function(s){var o=s.target.result&&s.target.result.refs||{},u=[e.metadata.id,e.metadata.rev].join("@"),a={digest:t,body:n,refs:o};a.refs[u]=!0,i.put(a).onsuccess=function(){call(r)}}}var d=n.new_edits,v=t.docs,m=v.map(function(e,t){var n=parseDoc(e,d);return n._bulk_seq=t,n}),g=m.filter(function(e){return e.error});if(g.length)return call(r,g[0]);var y,b=[],w=0;a(function(){y=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,META_STORE],IDBTransaction.READ_WRITE),y.onerror=idbError(r),y.ontimeout=idbError(r),y.oncomplete=o,s()})},api._get=function(t,n,r){function i(){call(r,u,{doc:s,metadata:o,ctx:a})}var s,o,u,a;a=n.ctx?n.ctx:idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly"),a.objectStore(DOC_STORE).get(t).onsuccess=function(e){if(o=e.target.result,!o)return u=Pouch.Errors.MISSING_DOC,i();if(isDeleted(o)&&!n.rev)return u=Pouch.error(Pouch.Errors.MISSING_DOC,"deleted"),i();var t=Pouch.merge.winningRev(o),r=o.id+"::"+(n.rev?n.rev:t),f=a.objectStore(BY_SEQ_STORE).index("_doc_id_rev");f.get(r).onsuccess=function(e){return s=e.target.result,s&&s._doc_id_rev&&delete s._doc_id_rev,s?(i(),void 0):(u=Pouch.Errors.MISSING_DOC,i())}}},api._getAttachment=function(e,t,n){var r,i;i=t.ctx?t.ctx:idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");var s=e.digest,o=e.content_type;i.objectStore(ATTACH_STORE).get(s).onsuccess=function(e){var i=e.target.result.body;if(t.encode)if(blobSupport){var s=new FileReader;s.onloadend=function(){r=btoa(this.result),call(n,null,r)},s.readAsBinaryString(i)}else r=i,call(n,null,r);else blobSupport?r=i:(i=fixBinary(atob(i)),r=new Blob([i],{type:o})),call(n,null,r)}},api._allDocs=function(t,n){var r="startkey"in t?t.startkey:!1,i="endkey"in t?t.endkey:!1,s="descending"in t?t.descending:!1;s=s?"prev":null;var o=r&&i?IDBKeyRange.bound(r,i):r?IDBKeyRange.lowerBound(r):i?IDBKeyRange.upperBound(i):null,u=idb.transaction([DOC_STORE,BY_SEQ_STORE],"readonly");u.oncomplete=function(){"keys"in t&&(t.keys.forEach(function(e){e in c?l.push(c[e]):l.push({key:e,error:"not_found"})}),t.descending&&l.reverse()),call(n,null,{total_rows:l.length,rows:"limit"in t?l.slice(0,t.limit):l})};var a=u.objectStore(DOC_STORE),f=s?a.openCursor(o,s):a.openCursor(o),l=[],c={};f.onsuccess=function(e){function n(e,n){if(isLocalId(e.id))return r["continue"]();var i={id:e.id,key:e.id,value:{rev:Pouch.merge.winningRev(e)}};if(t.include_docs){i.doc=n,i.doc._rev=Pouch.merge.winningRev(e),i.doc._doc_id_rev&&delete i.doc._doc_id_rev,t.conflicts&&(i.doc._conflicts=Pouch.merge.collectConflicts(e));for(var s in i.doc._attachments)i.doc._attachments[s].stub=!0}"keys"in t?t.keys.indexOf(e.id)>-1&&(isDeleted(e)&&(i.value.deleted=!0,i.doc=null),c[i.id]=i):isDeleted(e)||l.push(i),r["continue"]()}if(e.target.result){var r=e.target.result,i=r.value;if(t.include_docs){var s=u.objectStore(BY_SEQ_STORE).index("_doc_id_rev"),o=Pouch.merge.winningRev(i),a=i.id+"::"+o;s.get(a).onsuccess=function(e){n(r.value,e.target.result)}}else n(i)}}},api._info=function(t){function n(e){s=e.target.result&&e.target.result.updateSeq||0}function r(e){var t=e.target.result;return t?(t.value.deleted!==!0&&i++,t["continue"](),void 0):(o.objectStore(META_STORE).get(META_STORE).onsuccess=n,void 0)}var i=0,s=0,o=idb.transaction([DOC_STORE,META_STORE],"readonly");o.oncomplete=function(){t(null,{db_name:name,doc_count:i,update_seq:s})},o.objectStore(DOC_STORE).openCursor().onsuccess=r},api._changes=function idb_changes(opts){function fetchChanges(){txn=idb.transaction([DOC_STORE,BY_SEQ_STORE]),txn.oncomplete=onTxnComplete;var e;e=descending?txn.objectStore(BY_SEQ_STORE).openCursor(IDBKeyRange.lowerBound(opts.since,!0),descending):txn.objectStore(BY_SEQ_STORE).openCursor(IDBKeyRange.lowerBound(opts.since,!0)),e.onsuccess=onsuccess,e.onerror=onerror}function onsuccess(e){if(!e.target.result){for(var t=0,n=results.length;n>t;t++){var r=results[t];r&&dedupResults.push(r)}return!1}var i=e.target.result,s=i.value._id,o=resultIndices[s];if(void 0!==o)return results[o].seq=i.key,results.push(results[o]),results[o]=null,resultIndices[s]=results.length-1,i["continue"]();var u=txn.objectStore(DOC_STORE);u.get(i.value._id).onsuccess=function(e){var t=e.target.result;if(isLocalId(t.id))return i["continue"]();t.seq>last_seq&&(last_seq=t.seq);var n=Pouch.merge.winningRev(t),r=t.id+"::"+n,s=txn.objectStore(BY_SEQ_STORE).index("_doc_id_rev");s.get(r).onsuccess=function(e){var r=e.target.result;delete r._doc_id_rev;var s=[{rev:n}];"all_docs"===opts.style&&(s=Pouch.merge.collectLeaves(t.rev_tree).map(function(e){return{rev:e.rev}}));var o={id:t.id,seq:i.key,changes:s,doc:r};isDeleted(t,n)&&(o.deleted=!0),opts.conflicts&&(o.doc._conflicts=Pouch.merge.collectConflicts(t));var u=o.id,a=resultIndices[u];void 0!==a&&(results[a]=null),results.push(o),resultIndices[u]=results.length-1,i["continue"]()}}}function onTxnComplete(){processChanges(opts,dedupResults,last_seq)}function onerror(){call(opts.complete)}if(Pouch.DEBUG&&console.log(name+": Start Changes Feed: continuous="+opts.continuous),opts.continuous){var id=name+":"+Pouch.uuid();return opts.cancelled=!1,IdbPouch.Changes.addListener(name,id,api,opts),IdbPouch.Changes.notify(name),{cancel:function(){Pouch.DEBUG&&console.log(name+": Cancel Changes Feed"),opts.cancelled=!0,IdbPouch.Changes.removeListener(name,id)}}}var descending=opts.descending?"prev":null,last_seq=0;opts.since=opts.since&&!descending?opts.since:0;var results=[],resultIndices={},dedupResults=[],txn;if(opts.filter&&"string"==typeof opts.filter){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter,fetchChanges()})}else fetchChanges()},api._close=function(e){return null===idb?call(e,Pouch.Errors.NOT_OPEN):(idb.close(),call(e,null),void 0)},api._getRevisionTree=function(e,t){var n=idb.transaction([DOC_STORE],"readonly"),r=n.objectStore(DOC_STORE).get(e);r.onsuccess=function(e){var n=e.target.result;n?call(t,null,n.rev_tree):call(t,Pouch.Errors.MISSING_DOC)}},api._doCompaction=function(e,t,n,r){var i=idb.transaction([DOC_STORE,BY_SEQ_STORE],IDBTransaction.READ_WRITE),s=i.objectStore(DOC_STORE);s.get(e).onsuccess=function(r){var s=r.target.result;s.rev_tree=t;var u=n.length;n.forEach(function(t){var n=i.objectStore(BY_SEQ_STORE).index("_doc_id_rev"),r=e+"::"+t;n.getKey(r).onsuccess=function(e){var t=e.target.result;t&&(i.objectStore(BY_SEQ_STORE)["delete"](t),u--,u||i.objectStore(DOC_STORE).put(s))}})},i.oncomplete=function(){call(r)}},api};IdbPouch.valid=function(){return!!indexedDB},IdbPouch.destroy=function(t,n){Pouch.DEBUG&&console.log(t+": Delete Database"),IdbPouch.Changes.clearListeners(t),Pouch.openReqList[t]&&Pouch.openReqList[t].result&&Pouch.openReqList[t].result.close();var r=indexedDB.deleteDatabase(t);r.onsuccess=function(){Pouch.openReqList[t]&&(Pouch.openReqList[t]=null),call(n,null)},r.onerror=idbError(n)},IdbPouch.Changes=new Changes,Pouch.adapter("idb",IdbPouch);var POUCH_VERSION=1,POUCH_SIZE=5242880,DOC_STORE=quote("document-store"),BY_SEQ_STORE=quote("by-sequence"),ATTACH_STORE=quote("attach-store"),META_STORE=quote("metadata-store"),unknownError=function(e){return function(t){call(e,{status:500,error:t.type,reason:t.target})}},webSqlPouch=function(opts,callback){function dbCreated(){callback(null,api)}function setup(){db.transaction(function(e){var t="CREATE TABLE IF NOT EXISTS "+META_STORE+" (update_seq, dbid)",n="CREATE TABLE IF NOT EXISTS "+ATTACH_STORE+" (digest, json, body BLOB)",r="CREATE TABLE IF NOT EXISTS "+DOC_STORE+" (id unique, seq, json, winningseq)",i="CREATE TABLE IF NOT EXISTS "+BY_SEQ_STORE+" (seq INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, doc_id_rev UNIQUE, json)";e.executeSql(n),e.executeSql(r),e.executeSql(i),e.executeSql(t);var s="SELECT update_seq FROM "+META_STORE;e.executeSql(s,[],function(e,t){if(!t.rows.length){var n="INSERT INTO "+META_STORE+" (update_seq) VALUES (?)";return e.executeSql(n,[0]),void 0}});var o="SELECT dbid FROM "+META_STORE+" WHERE dbid IS NOT NULL";e.executeSql(o,[],function(e,t){if(!t.rows.length){var n="UPDATE "+META_STORE+" SET dbid=?";return instanceId=Pouch.uuid(),e.executeSql(n,[instanceId]),void 0}instanceId=t.rows.item(0).dbid})},unknownError(callback),dbCreated)}function makeRevs(e){return e.map(function(e){return{rev:e.rev}})}var api={},instanceId=null,name=opts.name,db=openDatabase(name,POUCH_VERSION,name,POUCH_SIZE);return db?(isCordova()?window.addEventListener(name+"_pouch",setup,!1):setup(),api.type=function(){return"websql"},api.id=function(){return instanceId},api._info=function(e){db.transaction(function(t){var n="SELECT COUNT(id) AS count FROM "+DOC_STORE;t.executeSql(n,[],function(t,n){var r=n.rows.item(0).count,i="SELECT update_seq FROM "+META_STORE;t.executeSql(i,[],function(t,n){var i=n.rows.item(0).update_seq;e(null,{db_name:name,doc_count:r,update_seq:i})})})})},api._bulkDocs=function(t,n,r){function i(e,t){return e._bulk_seq-t._bulk_seq}function s(){var e=[];E.sort(i),E.forEach(function(t){if(delete t._bulk_seq,t.error)return e.push(t),void 0;var n=t.metadata,r=Pouch.merge.winningRev(n);e.push({ok:!0,id:n.id,rev:r}),isLocalId(n.id)||(g++,webSqlPouch.Changes.notify(name),webSqlPouch.Changes.notifyLocalWindows(name))});var t="SELECT update_seq FROM "+META_STORE;w.executeSql(t,[],function(t,n){var i=n.rows.item(0).update_seq+g,s="UPDATE "+META_STORE+" SET update_seq=?";t.executeSql(s,[i],function(){call(r,null,e)})})}function o(e,t){if(e.stub)return t();if("string"==typeof e.data){try{e.data=atob(e.data)}catch(n){var i=Pouch.error(Pouch.Errors.BAD_ARG,"Attachments need to be base64 encoded");return call(r,i)}return e.digest="md5-"+Crypto.MD5(e.data),t()}var s=new FileReader;s.onloadend=function(){e.data=this.result,e.digest="md5-"+Crypto.MD5(this.result),t()},s.readAsBinaryString(e.data)}function u(e){function t(){n++,y.length===n&&e()}if(!y.length)return e();var n=0,r=0;y.forEach(function(e){function n(){r++,r===i.length&&t()}var i=e.data&&e.data._attachments?Object.keys(e.data._attachments):[];if(!i.length)return t();for(var s in e.data._attachments)o(e.data._attachments[s],n)})}function a(e,t,n){function r(){var t=e.data,n="INSERT INTO "+BY_SEQ_STORE+" (doc_id_rev, json) VALUES (?, ?);";w.executeSql(n,[t._id+"::"+t._rev,JSON.stringify(t)],o)}function i(e){u||(e?(u=e,call(t,u)):a===f.length&&r())}function s(e){a++,i(e)}function o(r,i){var s=e.metadata.seq=i.insertId;delete e.metadata.rev;var o=Pouch.merge.winningRev(e.metadata),u=n?"UPDATE "+DOC_STORE+" SET seq=?, json=?, winningseq=(SELECT seq FROM "+BY_SEQ_STORE+" WHERE doc_id_rev=?) WHERE id=?":"INSERT INTO "+DOC_STORE+" (id, seq, winningseq, json) VALUES (?, ?, ?, ?);",a=JSON.stringify(e.metadata),f=e.metadata.id+"::"+o,l=n?[s,a,f,e.metadata.id]:[e.metadata.id,s,s,a];r.executeSql(u,l,function(){E.push(e),call(t,null)})}var u=null,a=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var f=e.data._attachments?Object.keys(e.data._attachments):[];for(var l in e.data._attachments)if(e.data._attachments[l].stub)a++,i();else{var c=e.data._attachments[l].data;delete e.data._attachments[l].data;var h=e.data._attachments[l].digest;p(e,h,c,s)}f.length||r()}function f(e,t){var n=Pouch.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),r=isDeleted(e)&&isDeleted(t.metadata)||!isDeleted(e)&&v&&"new_leaf"!==n.conflicts;return r?(E.push(h(Pouch.Errors.REV_CONFLICT,t._bulk_seq)),c()):(t.metadata.rev_tree=n.tree,a(t,c,!0),void 0)}function l(e){return"was_delete"in n&&isDeleted(e.metadata)?(E.push(Pouch.Errors.MISSING_DOC),c()):(a(e,c,!1),void 0)}function c(){if(!y.length)return s();var e=y.shift(),t=e.metadata.id;t in S?f(S[t],e):(S[t]=e.metadata,l(e))}function h(e,t){return e._bulk_seq=t,e}function p(e,t,n,r){var i=[e.metadata.id,e.metadata.rev].join("@"),s={digest:t},o="SELECT digest, json FROM "+ATTACH_STORE+" WHERE digest=?";w.executeSql(o,[t],function(e,u){u.rows.length?(s.refs=JSON.parse(u.rows.item(0).json).refs,o="UPDATE "+ATTACH_STORE+" SET json=?, body=? WHERE digest=?",e.executeSql(o,[JSON.stringify(s),n,t],function(){call(r,null)})):(s.refs={},s.refs[i]=!0,o="INSERT INTO "+ATTACH_STORE+"(digest, json, body) VALUES (?, ?, ?)",e.executeSql(o,[t,JSON.stringify(s),n],function(){call(r,null)}))})}function d(e,t){for(var n=0;t.rows.length>n;n++){var r=t.rows.item(n);S[r.id]=JSON.parse(r.json)}c()}var v=n.new_edits,m=t.docs,g=0,y=m.map(function(e,t){var n=parseDoc(e,v);return n._bulk_seq=t,n}),b=y.filter(function(e){return e.error});if(b.length)return call(r,b[0]);var w,E=[],S={};u(function(){db.transaction(function(e){w=e;var t="("+y.map(function(e){return quote(e.metadata.id)}).join(",")+")",n="SELECT * FROM "+DOC_STORE+" WHERE id IN "+t;w.executeSql(n,[],d)},unknownError(r))})},api._get=function(e,t,n){function r(){call(n,o,{doc:i,metadata:s,ctx:u})}var i,s,o;if(!t.ctx)return db.transaction(function(r){t.ctx=r,api._get(e,t,n)}),void 0;var u=t.ctx,a="SELECT * FROM "+DOC_STORE+" WHERE id=?";u.executeSql(a,[e],function(e,n){if(!n.rows.length)return o=Pouch.Errors.MISSING_DOC,r();if(s=JSON.parse(n.rows.item(0).json),isDeleted(s)&&!t.rev)return o=Pouch.error(Pouch.Errors.MISSING_DOC,"deleted"),r();var a=Pouch.merge.winningRev(s),f=t.rev?t.rev:a;f=s.id+"::"+f;var l="SELECT * FROM "+BY_SEQ_STORE+" WHERE doc_id_rev=?";u.executeSql(l,[f],function(e,t){return t.rows.length?(i=JSON.parse(t.rows.item(0).json),r(),void 0):(o=Pouch.Errors.MISSING_DOC,r())})})},api._allDocs=function(e,t){var n=[],r={},i="startkey"in e?e.startkey:!1,s="endkey"in e?e.endkey:!1,o="descending"in e?e.descending:!1,u="SELECT "+DOC_STORE+".id, "+BY_SEQ_STORE+".seq, "+BY_SEQ_STORE+".json AS data, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq";"keys"in e?u+=" WHERE "+DOC_STORE+".id IN ("+e.keys.map(function(e){return quote(e)}).join(",")+")":(i&&(u+=" WHERE "+DOC_STORE+'.id >= "'+i+'"'),s&&(u+=(i?" AND ":" WHERE ")+DOC_STORE+'.id <= "'+s+'"'),u+=" ORDER BY "+DOC_STORE+".id "+(o?"DESC":"ASC")),db.transaction(function(t){t.executeSql(u,[],function(t,i){for(var s=0,o=i.rows.length;o>s;s++){var u=i.rows.item(s),a=JSON.parse(u.metadata),f=JSON.parse(u.data);if(!isLocalId(a.id)){if(u={id:a.id,key:a.id,value:{rev:Pouch.merge.winningRev(a)}},e.include_docs){u.doc=f,u.doc._rev=Pouch.merge.winningRev(a),e.conflicts&&(u.doc._conflicts=Pouch.merge.collectConflicts(a));for(var l in u.doc._attachments)u.doc._attachments[l].stub=!0}"keys"in e?e.keys.indexOf(a.id)>-1&&(isDeleted(a)&&(u.value.deleted=!0,u.doc=null),r[u.id]=u):isDeleted(a)||n.push(u)}}})},unknownError(t),function(){"keys"in e&&(e.keys.forEach(function(e){e in r?n.push(r[e]):n.push({key:e,error:"not_found"})}),e.descending&&n.reverse()),call(t,null,{total_rows:n.length,rows:"limit"in e?n.slice(0,e.limit):n})})},api._changes=function idb_changes(opts){function fetchChanges(){var e="SELECT "+DOC_STORE+".id, "+BY_SEQ_STORE+".seq, "+BY_SEQ_STORE+".json AS data, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq WHERE "+DOC_STORE+".seq > "+opts.since+" ORDER BY "+DOC_STORE+".seq "+(descending?"DESC":"ASC");db.transaction(function(t){t.executeSql(e,[],function(e,t){for(var n=0,r=0,i=t.rows.length;i>r;r++){var s=t.rows.item(r),o=JSON.parse(s.metadata);if(!isLocalId(o.id)){s.seq>n&&(n=s.seq);var u=JSON.parse(s.data),a=u._rev,f=[{rev:a}];"all_docs"===opts.style&&(f=makeRevs(Pouch.merge.collectLeaves(o.rev_tree)));var l={id:o.id,seq:s.seq,changes:f,doc:u};isDeleted(o,a)&&(l.deleted=!0),opts.conflicts&&(l.doc._conflicts=Pouch.merge.collectConflicts(o)),results.push(l)}}processChanges(opts,results,n)})})}if(Pouch.DEBUG&&console.log(name+": Start Changes Feed: continuous="+opts.continuous),opts.continuous){var id=name+":"+Pouch.uuid();return opts.cancelled=!1,webSqlPouch.Changes.addListener(name,id,api,opts),webSqlPouch.Changes.notify(name),{cancel:function(){Pouch.DEBUG&&console.log(name+": Cancel Changes Feed"),opts.cancelled=!0,webSqlPouch.Changes.removeListener(name,id)}}}var descending=opts.descending;opts.since=opts.since&&!descending?opts.since:0;var results=[],txn;if(opts.filter&&"string"==typeof opts.filter){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter,fetchChanges()})}else fetchChanges()},api._close=function(e){call(e,null)},api._getAttachment=function(e,t,n){var r,i=t.ctx,s=e.digest,o=e.content_type,u="SELECT body FROM "+ATTACH_STORE+" WHERE digest=?";i.executeSql(u,[s],function(e,i){var s=i.rows.item(0).body;r=t.encode?btoa(s):new Blob([s],{type:o}),call(n,null,r)})},api._getRevisionTree=function(e,t){db.transaction(function(n){var r="SELECT json AS metadata FROM "+DOC_STORE+" WHERE id = ?";n.executeSql(r,[e],function(e,n){if(n.rows.length){var r=JSON.parse(n.rows.item(0).metadata);call(t,null,r.rev_tree)}else call(t,Pouch.Errors.MISSING_DOC)})})},api._doCompaction=function(e,t,n,r){db.transaction(function(i){var s="SELECT json AS metadata FROM "+DOC_STORE+" WHERE id = ?";i.executeSql(s,[e],function(i,s){if(!s.rows.length)return call(r);var o=JSON.parse(s.rows.item(0).metadata);o.rev_tree=t;var u="DELETE FROM "+BY_SEQ_STORE+" WHERE doc_id_rev IN ("+n.map(function(t){return quote(e+"::"+t)}).join(",")+")";i.executeSql(u,[],function(t){var n="UPDATE "+DOC_STORE+" SET json = ? WHERE id = ?";t.executeSql(n,[JSON.stringify(o),e],function(){r()})})})})},api):call(callback,Pouch.Errors.UNKNOWN_ERROR)};webSqlPouch.valid=function(){return!!window.openDatabase},webSqlPouch.destroy=function(e,t){var n=openDatabase(e,POUCH_VERSION,e,POUCH_SIZE);n.transaction(function(e){e.executeSql("DROP TABLE IF EXISTS "+DOC_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+BY_SEQ_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+ATTACH_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+META_STORE,[])},unknownError(t),function(){call(t,null)})},webSqlPouch.Changes=new Changes,Pouch.adapter("websql",webSqlPouch);var MapReduce=function(db){function viewQuery(fun,options){function sum(e){return e.reduce(function(e,t){return e+t},0)}if(options.complete){fun.reduce||(options.reduce=!1);var builtInReduce={_sum:function(e,t){return sum(t)},_count:function(e,t,n){return n?sum(t):t.length},_stats:function(e,t){return{sum:sum(t),min:Math.min.apply(null,t),max:Math.max.apply(null,t),count:t.length,sumsqr:function(){var e=0;for(var n in t)e+=t[n]*t[n];return e}()}}},results=[],current=null,num_started=0,completed=!1,emit=function(e,t){var n={id:current.doc._id,key:e,value:t};if(!(options.startkey&&0>Pouch.collate(e,options.startkey)||options.endkey&&Pouch.collate(e,options.endkey)>0||options.key&&0!==Pouch.collate(e,options.key))){if(num_started++,options.include_docs){if(t&&"object"==typeof t&&t._id)return db.get(t._id,function(e,t){t&&(n.doc=t),results.push(n),checkComplete()}),void 0;n.doc=current.doc}results.push(n)}};eval("fun.map = "+(""+fun.map)+";"),fun.reduce&&(builtInReduce[fun.reduce]&&(fun.reduce=builtInReduce[fun.reduce]),eval("fun.reduce = "+(""+fun.reduce)+";"));var checkComplete=function(){if(completed&&results.length==num_started){if(results.sort(function(e,t){return Pouch.collate(e.key,t.key)}),options.descending&&results.reverse(),options.reduce===!1)return options.complete(null,{rows:"limit"in options?results.slice(0,options.limit):results,total_rows:results.length});var e=[];results.forEach(function(t){var n=e[e.length-1]||null;return n&&0===Pouch.collate(n.key[0][0],t.key)?(n.key.push([t.key,t.id]),n.value.push(t.value),void 0):(e.push({key:[[t.key,t.id]],value:[t.value]}),void 0)}),e.forEach(function(e){e.value=fun.reduce(e.key,e.value)||null,e.key=e.key[0][0]}),options.complete(null,{rows:"limit"in options?e.slice(0,options.limit):e,total_rows:e.length})}};db.changes({conflicts:!0,include_docs:!0,onChange:function(e){"deleted"in e||(current={doc:e.doc},fun.map.call(this,e.doc))},complete:function(){completed=!0,checkComplete()}})}}function httpQuery(e,t,n){var r=[],i=void 0,s="GET";if(t.reduce!==void 0&&r.push("reduce="+t.reduce),t.include_docs!==void 0&&r.push("include_docs="+t.include_docs),t.limit!==void 0&&r.push("limit="+t.limit),t.descending!==void 0&&r.push("descending="+t.descending),t.startkey!==void 0&&r.push("startkey="+encodeURIComponent(JSON.stringify(t.startkey))),t.endkey!==void 0&&r.push("endkey="+encodeURIComponent(JSON.stringify(t.endkey))),t.key!==void 0&&r.push("key="+encodeURIComponent(JSON.stringify(t.key))),t.group!==void 0&&r.push("group="+t.group),t.group_level!==void 0&&r.push("group_level="+t.group_level),t.keys!==void 0&&(s="POST",i=JSON.stringify({keys:t.keys})),r=r.join("&"),r=""===r?"":"?"+r,"string"==typeof e){var o=e.split("/");return db.request({method:s,url:"_design/"+o[0]+"/_view/"+o[1]+r,body:i},n),void 0}var u=JSON.parse(JSON.stringify(e,function(e,t){return"function"==typeof t?t+"":t}));db.request({method:"POST",url:"_temp_view"+r,body:u},n)}function query(e,t,n){if("function"==typeof t&&(n=t,t={}),n&&(t.complete=n),"http"===db.type())return"function"==typeof e?httpQuery({map:e},t,n):httpQuery(e,t,n);if("object"==typeof e)return viewQuery(e,t);if("function"==typeof e)return viewQuery({map:e},t);var r=e.split("/");db.get("_design/"+r[0],function(e,i){return e?(n&&n(e),void 0):i.views[r[1]]?(viewQuery({map:i.views[r[1]].map,reduce:i.views[r[1]].reduce},t),void 0):(n&&n({error:"not_found",reason:"missing_named_view"}),void 0)})}return{query:query}};MapReduce._delete=function(){},Pouch.plugin("mapreduce",MapReduce)})(this);