define(["controllers/controllers","config"],function(e,t){e.controller("messages",["$scope","$rootScope","$q","$location","$route","data","Messages","Offsetter","Store",function(e,t,n,r,i,s,o,u,a){function f(t){e.views={compose:!1,message:!1,inbox:!1,outbox:!1,trash:!1,notifications:!1,scheaduler:!1},e.views[t]=!0}function c(n){t.statusBar.display(t.ui.message.loadingMessage),f("message"),e.setViewTo("message"),e.message=o.find(n);if(e.message.state=="NEW"&&e.message.box=="inbox"){o.changeState([n],"READ").then(function(e){e.error&&(t.notifier.error(t.ui.errors.messages.changeState),console.warn("error ->",e))});var r=[];_.each(e.messages.inbox,function(t){t.uuid==e.message.uuid&&(t.state="READ"),r.push(t)}),e.messages.inbox=r,o.unreadCount()}t.statusBar.off()}function h(n){e.origin="notifications",e.scheadulerPane=!0;var r=o.scheaduled.find(n);_.each(r.types,function(t){t=="sms"&&(e.broadcast.sms=!0),t=="email"&&(e.broadcast.email=!0)});var i=a("network").get("unique"),s=a("network").get("groups"),f=[];_.each(r.recipients,function(e){var n;i[e]?(n=i[e].name,f.push({group:t.ui.message.receiversUsers,id:e,name:n})):_.each(s,function(r){r.uuid==e&&(n=r.name,f.push({group:t.ui.message.receiversGroups,id:e,name:n}))})}),e.message={subject:r.subject,body:r.message,receivers:f},_.each($("div#composeTab select.chosen-select option"),function(e){_.each(r.recipients,function(t){i[t]?e.innerHTML==i[t].name&&(e.selected=!0):_.each(s,function(n){n.uuid==t&&e.innerHTML==n.name&&(e.selected=!0)})})}),$("div#composeTab select.chosen-select").trigger("chosen:updated"),e.scheaduled={uuid:r.uuid,sender:r.sender,title:r.label,status:r.active,offsets:u.factory(r.offsets)};var l=0;_.each(e.scheaduled.offsets,function(){l++}),e.scheaduleCount=l}function p(){_.each(e.message.receivers,function(e){_.each($("div#composeTab select.chosen-select option"),function(t){t.innerHTML==e.name&&(t.selected=!0)})}),$("div#composeTab select.chosen-select").trigger("chosen:updated")}t.notification.status=!1,t.fixStyles(),e.receviersList=o.receviers(),e.messages=s.messages,e.scheadules=s.scheadules,e.page={inbox:0,outbox:0,trash:0},e.paginate={set:function(t,n){e.page[n]=t},next:function(t){e.page[t]+1!=e.messages[t].length&&e.page[t]++},before:function(t){e.page[t]!=0&&e.page[t]--}},e.selection={inbox:{},outbox:{},trash:{}},e.selectionMaster={inbox:!1,outbox:!1,trash:!1},e.broadcast={sms:!1,email:!1},e.scheaduled={title:"",offsets:{},status:!1},e.origin="inbox",e.setViewTo=function(t){e.$watch(t,function(){r.hash(t),f(t)})};var l;r.hash()?l=r.hash():(l="inbox",r.hash("inbox")),f(l),e.scheadulerPane=!1,r.search().uuid&&(r.hash()=="scheaduler"?h(r.search().uuid):c(r.search().uuid)),e.requestMessage=function(t,n){e.origin=n,c(t),e.$watch(r.search(),function(){r.search({uuid:t})})},e.scheaduleCounter=function(){var t=0;_.each(e.scheaduled.offsets,function(){t++}),e.scheaduleCount=t},e.requestNotification=function(n){t.statusBar.display(t.ui.message.loadingNotifications),f("scheaduler"),e.setViewTo("scheaduler"),h(n),e.$watch(r.search(),function(){r.search({uuid:n})}),t.statusBar.off()},e.composeMessage=function(){e.views.compose?e.closeTabs():(r.search({}),e.message={},e.broadcast.sms=!1,e.broadcast.email=!1,e.scheadulerPane=!1,_.each($("div#composeTab select.chosen-select option"),function(e){e.selected=!1}),$("div#composeTab select.chosen-select").trigger("chosen:updated"),e.scheaduled={title:"",offsets:{},status:!1},e.scheaduleCounter(),e.setViewTo("inbox"))},e.closeTabs=function(){e.message={},r.search({}),f(e.origin),e.setViewTo(e.origin),a("environment").remove("escalation")},e.toggleSelection=function(t,n,r){var i=r?!1:!0;_.each(t,function(t){e.selection[n][t.uuid]=i})},e.removeMessage=function(n){t.statusBar.display(t.ui.message.removing);var r=[];r.push(n),o.remove(r).then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.removeMessage),console.warn("error ->",n)):(t.notifier.success(t.ui.message.removed),t.statusBar.display(t.ui.message.refreshing),o.query().then(function(n){e.messages=n.messages,t.loading=!1,e.closeTabs(),t.statusBar.off()}))})},e.removeMessages=function(n){t.statusBar.display(t.ui.message.removingSelected);var r=[];_.each(n,function(e,t){e&&r.push(t)}),o.remove(r).then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.removeMessages),console.warn("error ->",n)):(t.notifier.success(t.ui.message.removed),t.statusBar.display(t.ui.message.refreshing),o.query().then(function(n){e.messages=n.messages,t.statusBar.off()}))})},e.restoreMessage=function(n){t.statusBar.display(t.ui.message.restoring);var r=[];r.push(n),o.restore(r).then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.restoreMessage),console.warn("error ->",n)):(t.notifier.success(t.ui.message.restored),t.statusBar.display(t.ui.message.refreshing),o.query().then(function(n){e.messages=n.messages,t.statusBar.off()}))})},e.restoreMessages=function(n){t.statusBar.display(t.ui.message.restoringSelected);var r=[];_.each(n,function(e,t){e&&r.push(t)}),o.restore(r).then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.restoreMessages),console.warn("error ->",n)):(t.notifier.success(t.ui.message.removed),t.statusBar.display(t.ui.message.refreshing),o.query().then(function(n){e.messages=n.messages,t.statusBar.off()}))})},e.emptyTrash=function(){t.statusBar.display(t.ui.message.emptying),o.emptyTrash().then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.emptyTrash),console.warn("error ->",n)):(t.notifier.success(t.ui.message.emptied),t.statusBar.display(t.ui.message.refreshing),o.query().then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.query),console.warn("error ->",n)):(e.messages=n.messages,t.statusBar.off())}))})},e.reply=function(t){f("compose"),e.setViewTo("compose");var n=a("network").get("members"),r=t.requester,i=typeof n[r]=="undefined"?r:n[r].name;e.message={subject:"RE: "+t.subject,receivers:[{group:"Users",id:r,name:i}]},p()},e.send=function(n,r){t.statusBar.display(t.ui.message.sending),n.receivers?o.send(n,r).then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.send),console.warn("error ->",n)):(t.notifier.success(t.ui.message.sent),t.statusBar.display(t.ui.message.refreshing),o.query().then(function(r){r.error?(t.notifier.error(t.ui.errors.messages.query),console.warn("error ->",r)):(e.messages=r.messages,e.closeTabs(),e.requestMessage(n,e.origin),t.statusBar.off())}))}):(t.notifier.error(t.ui.message.noReceivers),t.statusBar.off())},$("div#composeTab select.chosen-select").chosen({width:"95%"}).change(function(){$.each($(this).next().find("ul li.result-selected"),function(e,t){var n=$(t).html();$.each($("div#composeTab select.chosen-select option"),function(e,t){t.innerHTML==n&&(t.selected=!0)})})});if(r.search().escalate){var d=a("environment").get("escalation"),v=d.group.split(">")[1].split("<")[0],m=d.group.split("uuid=")[1].split("#view")[0];setTimeout(function(){_.each($("div#composeTab select.chosen-select option"),function(e){e.innerHTML==v&&(e.selected=!0)}),$("div#composeTab select.chosen-select").trigger("chosen:updated")},t.StandBy.config.timers.TICKER),e.message={subject:t.ui.message.escalation,receivers:[{group:t.ui.message.receiversGroups,id:m,name:v}],body:t.ui.message.escalationBody(d.diff,d.start.date,d.start.time,d.end.date,d.end.time)},e.broadcast={sms:!0}}e.clean={inbox:function(){o.clean(e.messages.inbox)},outbox:function(){o.clean(e.messages.outbox)},trash:function(){o.clean(e.messages.trash)}},e.scheaduler={job:function(e,n,r){var i=[],s=[];return _.each(e.receivers,function(e){i.push(e.id)}),s.push("paige"),n.sms&&s.push("sms"),n.email&&s.push("email"),{sender:t.StandBy.resources.uuid,recipients:i,label:r.title,subject:e.subject,message:e.body,offsets:u.arrayed(r.offsets),repeat:"week",types:s,active:r.status}},list:function(n){t.statusBar.display(t.ui.message.notificationsRefresh),o.scheaduled.list().then(function(r){r.error?(t.notifier.error(t.ui.errors.messages.notificationsList),console.warn("error ->",r)):(e.scheadules=r,t.statusBar.off(),n())})},get:function(n){o.scheaduled.get(n).then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.notificationsGet),console.warn("error ->",n)):e.scheaduled=n})},save:function(e,t,n){n.uuid?this.edit(e,t,n):this.add(e,t,n)},add:function(n,r,i){var s=this;t.statusBar.display(t.ui.message.notificationsAdd),o.scheaduled.create(this.job(n,r,i)).then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.notificationsAdd),console.warn("error ->",n)):(t.notifier.success(t.ui.message.notificationSaved),s.list(function(){e.setViewTo("notifications")}))})},edit:function(n,r,i){var s=this;t.statusBar.display(t.ui.message.notificationsEditing),o.scheaduled.edit(i.uuid,this.job(n,r,i)).then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.notificationsEdit),console.warn("error ->",n)):(t.notifier.success(t.ui.message.notificationsEdited),s.list(function(){e.setViewTo("notifications")}))})},remove:function(n){var r=this;t.statusBar.display(t.ui.message.notificationsDeleting),o.scheaduled.remove(n).then(function(n){n.error?(t.notifier.error(t.ui.errors.messages.notificationsDelete),console.warn("error ->",n)):(t.notifier.success(t.ui.message.notificationsDeleted),r.list(function(){e.setViewTo("notifications")}))})}}}])});