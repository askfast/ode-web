define(["controllers/controllers","config"],function(e,t){e.controller("clientCtrl",["$rootScope","$scope","$location","Clients","data","$route","$routeParams","Store","Dater","$filter","$modal","TeamUp","$timeout",function(e,n,r,i,s,o,u,a,f,l,c,h,p){function E(e){angular.forEach(s.clientGroups,function(t){t.id==e&&(n.clientGroup=t)}),n.clients=s.clients[e],n.current=e,n.views.reports&&(n.currentCLient="0",n.currentMonth="0",w())}e.fixStyles(),s.clientId&&(s.clientGroups=a("app").get("ClientGroups"),s.clients={},angular.forEach(s.clientGroups,function(e){s.clients[e.id]=a("app").get(e.id),angular.forEach(s.clients[e.id],function(e){e.uuid==s.clientId&&(n.client=e,n.contacts=e.contacts,e.birthDate=l("nicelyDate")(e.birthDate),n.clientmeta=e)})})),n.imgHost=t.app.host,n.ns=t.app.namespace,n.clients=s.clients,n.clientGroups=s.clientGroups;var d=f.getMonthTimeStamps();n.Months=[],angular.forEach(d,function(e,t){n.Months[t]={number:t,name:t,start:e.first.timeStamp,end:e.last.timeStamp}}),n.Months[0]={number:0,name:e.ui.teamup.selectMonth};var v=r.search();n.search={query:""},n.selection={},n.data=s;var m,g;!v.uuid&&!r.hash()?(m=s.clientGroups[0].id,g="client",r.search({uuid:s.clientGroups[0].id}).hash("client")):v.uuid?(m=v.uuid,typeof m=="undefined"&&(m=n.client.clientGroupUuid),g=r.hash()):(m=s.clientGroups[0].id,g=r.hash(),r.search({uuid:s.clientGroups[0].id})),n.views={client:!0,newClientGroup:!1,newClient:!1,reports:!1,editClientGroup:!1,editClient:!1,viewClient:!1,editImg:!1};var y=function(e){n.views={client:!1,newClientGroup:!1,newClient:!1,reports:!1,editImg:!1},e=="viewClient"&&b(),e=="reports"&&w(),n.views[e]=!0},b=function(){e.statusBar.display(e.ui.teamup.loadingReports),h._("clientReportsQuery",{second:n.client.uuid},null,{success:function(e){a("app").save("reports_"+n.client.uuid,e)}}).then(function(t){e.statusBar.off(),n.reports=n.processReports(t)},function(e){console.log(e)})},w=function(){e.statusBar.display(e.ui.teamup.loadingReports),n.clientGroup||(n.clientGroup=s.clientGroups[0]),h._("clientGroupReportsQuery",{second:n.clientGroup.id}).then(function(t){e.statusBar.off(),n.groupReports=n.processReports(t),n.currentCLient!=0&&n.requestReportsByFilter();var i=r.search().reportUuid,s=null;if(i){angular.forEach(n.groupReports,function(e){e.uuid==i&&(s=e)});if(s==null){r.search().reportUuid&&r.search("reportUuid",null),e.notifier.error(e.ui.teamup.reportNotExists);return}n.openReport(s)}},function(e){console.log(e)})};y(g),E(m),n.requestClientGroup=function(e,t){E(e),n.$watch(r.search(),function(){r.search({uuid:e})}),t&&(r.hash()!="client"&&r.hash("client"),y("client"))},n.processReports=function(e){var t=[];return angular.forEach(e,function(e){t.push({uuid:e.uuid,title:e.title,creationTime:e.creationTime,clientUuid:e.clientUuid,body:e.body,media:e.media||[],author:n.$root.getTeamMemberById(e.authorUuid),client:n.$root.getClientByID(e.clientUuid),filtered:"false"})}),t},n.setViewTo=function(e){n.$watch(e,function(){n.clientGroup||(n.clientGroup=n.clientGroups[0]),(r.hash()=="viewClient"||r.hash()=="editClient"||r.hash()=="editImg")&&e=="client"&&r.path("/client").search({uuid:n.clientGroup.id}),r.hash(e),y(e)})},n.editClientGroup=function(e){n.cGroupEditForm={name:e.name,id:e.id},n.views.editClientGroup=!0},n.cancelClientGroupEdit=function(e){n.cGroupEditForm={name:e.name,id:e.id},n.views.editClientGroup=!1},n.changeClientGroup=function(t){if($.trim(t.name)=="")return;h._("clientGroupUpdate",{second:t.id},t.id).then(function(r){r.error?e.notifier.error(e.ui.teamup.errorSaveClientGroup):(e.statusBar.display(e.ui.teamup.refreshing),i.query(!1).then(function(){e.notifier.success(e.ui.teamup.dataChanged),e.statusBar.off(),n.clientGroup.name=t.name,n.views.editClientGroup=!1}))})};var S=function(t){i.query(!1,t).then(function(i){i.error?console.warn("error ->",i):(e.notifier.success(e.ui.teamup.dataChanged),n.closeTabs(),n.data=i,n.clientGroups=i.clientGroups,n.clients=i.clients,angular.forEach(i.clientGroups,function(e){e.id==t.uuid&&(n.clientGroup=e,n.current=e.id,r.url("/client?uuid="+e.id).hash("client"))})),e.statusBar.off()})};n.cGroupSubmit=function(t){if(typeof t=="undefined"||$.trim(t.name)==""){e.notifier.error(e.ui.teamup.teamNamePrompt1);return}h._("clientGroupAdd",null,t,{success:function(e){a("app").save(e.id,e)}}).then(function(t){t.error||(e.statusBar.display(e.ui.teamup.refreshing),S({uuid:t.id}))})},n.closeTabs=function(){n.clientGroupForm={},n.clientForm={},y("client")},n.addContacts=function(){if(typeof n.contactForm=="undefined"||n.contactForm.func==""){e.notifier.error(e.ui.teamup.teamNamePrompt2);return}var t={firstName:"",lastName:"","function":"",phone:""};t.firstName=n.contactForm.firstName,t.lastName=n.contactForm.lastName,t.function=n.contactForm.function,t.phone=n.contactForm.phone,typeof n.contacts=="undefined"&&(n.contacts=[]),n.contacts==null&&(n.contacts=[]),n.contacts.push(t)},n.clientSubmit=function(t){if(typeof t=="undefined"||!t.firstName||!t.lastName||!t.phone){e.notifier.error(e.ui.teamup.clinetInfoFill);return}e.statusBar.display(e.ui.teamup.savingClient);try{t.birthDate=f.convert.absolute(t.birthDate,0)}catch(r){e.notifier.error(e.ui.teamup.birthdayError);return}t.clientGroupUuid=n.clientGroup.id,h._("clientAdd",null,t,{success:function(e){a("app").save(e.id,e)}}).then(function(t){t.error?e.notifier.error(e.ui.teamup.clientSubmitError):S({uuid:t.clientGroupUuid})})},n.clientChange=function(t){e.statusBar.display(e.ui.teamup.savingClient);try{t.birthDate=f.convert.absolute(t.birthDate,0)}catch(n){e.notifier.error(e.ui.teamup.birthdayError);return}h._("clientUpdate",{second:t.uuid},t).then(function(t){t.error?e.notifier.error(e.ui.teamup.clientSubmitError):(e.statusBar.display(e.ui.teamup.refreshing),e.notifier.success(e.ui.teamup.dataChanged),S({uuid:t.clientGroupUuid}))})},n.saveContacts=function(t){var r=n.client;try{r.birthDate=f.convert.absolute(r.birthDate,0)}catch(s){e.notifier.error(e.ui.teamup.birthdayError);return}r.contacts=t,e.statusBar.display(e.ui.teamup.savingContacts),h._("clientUpdate",{second:r.uuid},r).then(function(t){t.error?e.notifier.error(e.ui.teamup.clientSubmitError):(e.notifier.success(e.ui.teamup.dataChanged),e.statusBar.off(),i.query(!1,{uuid:t.clientGroupUuid}).then(function(e){})),n.client.birthDate=l("nicelyDate")(n.client.birthDate)})},n.removeContact=function(e){angular.forEach(n.contacts,function(t,r){e.name==t.name&&e.func==t.func&&e.phone==t.phone&&n.contacts.splice(r,1)})},n.confirmDeleteClientGroup=function(){p(function(){angular.element("#confirmClientGroupModal").modal("show")})},n.deleteClientGroup=function(){angular.element("#confirmClientGroupModal").modal("hide"),e.statusBar.display(e.ui.teamup.deletingClientGroup),h._("clientGroupDelete",{second:n.current}).then(function(t){t.id&&i.query(!0,{}).then(function(e){n.requestClientGroup(e[0].id),angular.forEach(n.clientGroups,function(e,r){e.id==t.id&&n.clientGroups.splice(r,1)})},function(e){console.log(e)}),e.notifier.success(e.ui.teamup.dataChanged),e.statusBar.off()},function(e){console.log(e)})},n._clientId={},n.confirmDeleteClient=function(e){p(function(){n._clientId=e,angular.element("#confirmClientModal").modal("show")})},n.deleteClient=function(t){n._clientId={},angular.element("#confirmClientModal").modal("hide"),e.statusBar.display(e.ui.teamup.deletingClient),h._("clientDelete",{second:t}).then(function(){h._("clientsQuery").then(function(e){a("app").save("clients",e),n.views.viewClient==1?n.setViewTo("client"):o.reload()})},function(e){console.log(e)})},n.requestReportsByFilter=function(){angular.forEach(n.groupReports,function(e){e.clientUuid!=n.currentCLient&&n.currentCLient!="0"?e.filtered="true":e.filtered="false";var t=(new Date(e.creationTime)).getMonth()+1;t!=n.currentMonth&&n.currentMonth!="0"||e.filtered=="true"?e.filtered="true":e.filtered="false"})};var x=function(t,n,i){t.report=i,t.view={editReport:!!i.editMode,viewReport:!i.editMode&&typeof i.uuid!="undefined",newReport:typeof i.uuid=="undefined"},t.close=function(){n.dismiss(),r.search().reportUuid&&r.search("reportUuid",null)},t.saveReport=function(t){console.log(t),t.editMode?h._("clientReportUpdate",{second:t.clientUuid,fourth:t.uuid},{uuid:t.uuid,title:t.title,body:t.body,creationTime:t.creationTime}).then(function(r){n.close(t),e.notifier.success(e.ui.teamup.dataChanged)}):h._("clientReportAdd",{second:t.clientUuid},{uuid:t.uuid,title:t.title,body:t.body,creationTime:t.creationTime}).then(function(r){n.close(t),e.notifier.success(e.ui.teamup.dataChanged)})}};x.$inject=["$scope","$modalInstance","report"],n.openReport=function(e){n.report=e,n.report.editMode=!1,c.open({templateUrl:"./views/reportTemplate.html",controller:x,resolve:{report:function(){return n.report}}})},n.newReport=function(){if(n.currentCLient==0){e.notifier.error(e.ui.teamup.selectClient);return}n.report={title:e.ui.teamup.newReport,creationTime:(new Date).getTime(),clientUuid:n.currentCLient,body:null,author:n.$root.getTeamMemberById(e.app.resources.uuid),client:n.$root.getClientByID(n.currentCLient),editMode:!1};var t=c.open({templateUrl:"views/reportTemplate.html",controller:x,resolve:{report:function(){return n.report},editMode:!1}});t.result.then(function(){w()},function(){console.log("Modal dismissed at: "+new Date)})},n.editReport=function(e){n.report=e,n.report.editMode=!0,c.open({templateUrl:"./views/reportTemplate.html",controller:x,resolve:{report:function(){return n.report}}})},n._report={},n.confirmDeleteReport=function(e){p(function(){n._report=e,angular.element("#confirmReportModal").modal("show")})},n.removeReport=function(t){e.statusBar.display(e.ui.teamup.loading),n._report={},angular.element("#confirmReportModal").modal("hide"),h._("clientReportDelete",{second:t.clientUuid,reportId:t.uuid}).then(function(t){t.result=="ok"?(e.notifier.success(e.ui.teamup.dataChanged),w(),n.views.viewClient==1&&b()):e.notifier.error(t.error)},function(e){console.log(e)})},n.editImg=function(){n.uploadURL=n.imgHost+n.ns+"/client/"+n.client.uuid+"/photo?square=true",n.setViewTo("editImg")},n.$on("$locationChangeSuccess",function(t,i,s){var o=t.currentScope;if(r.hash()=="reports"){var u=r.search().uuid,a=r.search().reportUuid;if(u)if(u!=o.clientGroup.id)angular.forEach(o.data.clientGroups,function(e){e.id==u&&(o.clientGroup=e)}),o.setViewTo("reports");else if(a){var f=null;angular.forEach(n.groupReports,function(e){e.uuid==a&&(f=e)});if(f==null){e.notifier.error(e.ui.teamup.reportNotExists),r.search().reportUuid&&r.search("reportUuid",null);return}o.openReport(f)}}})}])});