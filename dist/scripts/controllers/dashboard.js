define(["controllers/controllers"],function(e){e.controller("dashboard",["$scope","$rootScope","$q","$window","$location","Dashboard","Slots","Dater","Settings","Profile","Groups","StandBy","Announcer","Network","$timeout","Store",function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){function S(){e.loadingPies=!0,e.checkAnyPies()?t.statusBar.off():s.pies().then(function(n){e.loadingPies=!1,n.error?(t.notifier.error(t.ui.errors.dashboard.getOverviews),console.warn("error ->",n.error)):(e.shortageHolders={},e.loading.pies=!1,e.periods={start:n[0].weeks.current.start.date,end:n[0].weeks.next.end.date},_.each(n,function(n){n.weeks.current.state instanceof Array&&(n.weeks.current.state=n.weeks.current.state[0]),n.weeks.current.state.diff===null&&(n.weeks.current.state.diff=0),n.weeks.current.state.wish===null&&(n.weeks.current.state.wish=0),n.weeks.current.state.wish==0?n.weeks.current.state.cls="disabled":n.weeks.current.state.diff>0?n.weeks.current.state.cls="more":n.weeks.current.state.diff===0?n.weeks.current.state.cls="even":n.weeks.current.state.diff<0&&(n.weeks.current.state.cls="less"),n.weeks.current.state.start=n.weeks.current.state.start!==undefined?(new Date(n.weeks.current.state.start*1e3)).toString(t.StandBy.config.formats.datetime):t.ui.dashboard.possiblyAvailable,n.weeks.current.state.end=n.weeks.current.state.end!==undefined?(new Date(n.weeks.current.state.end*1e3)).toString(t.StandBy.config.formats.datetime):t.ui.dashboard.possiblyAvailable,n.shortages={current:n.weeks.current.shortages,next:n.weeks.next.shortages,total:n.weeks.current.shortages.length+n.weeks.next.shortages.length},n.state=n.weeks.current.state,delete n.weeks.current.shortages,delete n.weeks.current.state,e.shortageHolders["shortages-"+n.id]=!1}),e.pies=n)}).then(function(){function n(e,n,r){d(function(){$.browser.msie&&$.browser.version=="8.0"?$("#"+e+n).html(""):document.getElementById(e+n)&&(document.getElementById(e+n).innerHTML="");var t=[],i={more:"#6cad6c",even:"#e09131",less:"#d34545"},s=[],o=[];_.each(r,function(e,n){e!==0&&t.push({ratio:e,color:i[n]})}),t=t.sort(function(e,t){return t.ratio-e.ratio}),_.each(t,function(e){s.push(e.color),o.push(e.ratio)});try{(new Raphael(e+n)).piechart(40,40,40,o,{colors:s,stroke:"white"})}catch(u){console.warn(" Raphael error ->",u)}},t.StandBy.config.timers.TICKER)}_.each(e.pies,function(e){n("weeklyPieCurrent-",e.id+"-"+e.division,e.weeks.current.ratios),n("weeklyPieNext-",e.id+"-"+e.division,e.weeks.next.ratios)})})}function x(n){var r=v("smartAlarm").get("guard");e.saMembers={truck:[],reserves:[]},e.saSynced=r.synced,_.each(n.selection,function(r){function i(e){return e!==null?n.users[e].name:t.ui.dashboard.notAssigned}var s=r.user==null?"sa-icon-not-assigned":null;switch(r.role){case"bevelvoerder":e.saMembers.truck.push({rank:1,icon:t.ui.dashboard.alarmRoles.commanderInitial,role:t.ui.dashboard.alarmRoles.commander,"class":r.user==null?"sa-icon-not-assigned":"sa-icon-commander",name:i(r.user),uuid:r.user});break;case"chauffeur":e.saMembers.truck.push({rank:0,icon:t.ui.dashboard.alarmRoles.driverInitial,role:t.ui.dashboard.alarmRoles.driver,"class":r.user==null?"sa-icon-not-assigned":"sa-icon-driver",name:i(r.user),uuid:r.user});break;case"manschap.1":e.saMembers.truck.push({rank:2,icon:"M1",role:t.ui.dashboard.alarmRoles.manpower+" 1",name:i(r.user),uuid:r.user,"class":s});break;case"manschap.2":e.saMembers.truck.push({rank:3,icon:"M2",role:t.ui.dashboard.alarmRoles.manpower+" 2",name:i(r.user),uuid:r.user,"class":s});break;case"manschap.3":e.saMembers.truck.push({rank:4,icon:"M3",role:t.ui.dashboard.alarmRoles.manpower+" 3",name:i(r.user),uuid:r.user,"class":s});break;case"manschap.4":e.saMembers.truck.push({rank:5,icon:"M4",role:t.ui.dashboard.alarmRoles.manpower+" 4",name:i(r.user),uuid:r.user,"class":s})}t.StandBy.guard.role=n.role,n.users[t.StandBy.resources.uuid]?t.StandBy.guard.currentState=n.users[t.StandBy.resources.uuid].state:o.currentState().then(function(e){t.StandBy.guard.currentState=e.label});var u={},a=["available","unavailable","noplanning"];_.each(a,function(e){u[e]=[],_.each(n.reserves[e],function(t){_.each(t,function(t,n){t.role!=0&&u[e].push({id:n,name:t.name,state:t.state})})})}),e.saMembers.reserves=u,e.loading.smartAlarm=!1})}t.notification.status=!1,t.fixStyles(),e.loading={pies:!0,alerts:!0,smartAlarm:!0},e.more={status:!1,text:t.ui.dashboard.showMore},e.synced={alarms:(new Date).getTime(),pies:(new Date).getTime()},c._("channels").then(function(e){_.each(e,function(e){e.adapterType=="broadsoft"&&t.phoneNumberParser(e.address)})});var m=v("network").get("groups"),g={},y=angular.fromJson(v("user").get("resources").settingsWebPaige);_.each(y.app.widgets.groups,function(e,t){g[t]=e}),_.each(m,function(e){g[e.uuid]||(g[e.uuid]={divisions:t.StandBy.config.timeline.config.divisions.length>0,status:!1})});var b=[];_.each(m,function(e){e.uuid!="all"&&b.push(e)}),e.loadingPresence=!0;var w=function(e){var t={},n=[],r=[],i=["Hoofd BHV","BHV Ploegleider","BHV'er","EHBO'er"];return _.each(e,function(e){e.resources.groups?_.each(m,function(n){e.resources.groups[0].uuid===n.uuid&&(typeof t[n.name]=="undefined"&&(t[n.name]=[]),e.resources.groups[0].name=n.name,t[n.name].push(e))}):(typeof t["ungrouped"]=="undefined"&&(t.ungrouped=[]),t.ungrouped.push(e))}),_.each(t,function(e,t){i.indexOf(t)!==-1?n[i.indexOf(t)]=e:r.push(e)}),r.sort(),_.each(r,function(e){n.push(e)}),n=_.compact(n),n},E=function(t){var n=[],r,i=["memberStateAvailable","memberStateOffline","memberStateBusy"];return _.each(t,function(t){_.each(e.availability.members,function(e,s){switch(s){case"available":r=0;break;case"possible":r=1;break;case"unavailable":r=2}_.each(e,function(e){t.uuid===e.id&&(typeof n[r]=="undefined"&&(n[r]=[]),t.availabilityClass=i[r],n[r].push(t))})})}),n};e.checkPresence=function(){var t=v("network").get("unique"),n=[],r=[];_.each(t,function(e){e.resources&&(e.resources.groups=l.getMemberGroups(e.uuid),e.resources.groups&&e.resources.groups.length>1&&(e.resources.groups.sort(function(e,t){return e.name.toUpperCase()>t.name.toUpperCase()?1:e.name.toUpperCase()<t.name.toUpperCase()?-1:0}),e.resources.groups=e.resources.groups.slice(0,1)),e.resources.currentPresence?n.push(e):r.push(e))}),e.present=E(n),e.absent=E(r),e.loadingPresence=!1},t.intervals=[],t.intervals.push(r.setInterval(function(){p.population().then(e.checkPresence)},t.StandBy.config.timers.ALARM_SYNC)),e.popover={groups:b,selection:g,divisions:t.StandBy.environment.divisions.length>0},e.checkAnyPies=function(){var t=!0;return e.loading.pies=!1,_.each(y.app.widgets.groups,function(e){e.status===!0&&(t=!1)}),t},e.loadingPies=!0,d(function(){S()},25),t.StandBy.config.profile.smartAlarm&&(v("smartAlarm").get("guard").selection&&(e.loading.smartAlarm=!1,x(v("smartAlarm").get("guard"))),l.guardMonitor().then(function(){l.guardRole().then(function(e){x(e)})}));var T=v("network").get("unique"),N;m.unshift({name:t.ui.dashboard.everyone,uuid:"all"}),N="all",e.groups=m,e.states=t.StandBy.config.timeline.config.states,e.states["no-state"]={className:"no-state",label:t.ui.dashboard.possiblyAvailable,color:"#ececec",type:t.ui.dashboard.noPlanning,display:!1},e.divisions=t.StandBy.environment.divisions||[],e.divisions.length>0&&e.divisions[0].id!=="all"&&e.divisions.unshift({id:"all",label:t.ui.dashboard.allDivisions}),e.current={group:N,division:"all"},e.loadingAvailability=!0,e.getAvailability=function(r,i){var s=n.defer();return r||(r=e.current.group),i||(i=e.current.division),o.getMemberAvailabilities(r,i).then(function(n){var r={};_.each(angular.fromJson(angular.toJson(n.members)),function(n,i){if(T[i]&&T[i].resources.role!=0&&T[i].resources.role!=4){var s={id:i,state:n.length>0?n[0].state:"no-state",label:n.length>0?e.states[n[0].state].label[0]:"",end:n.length>0&&n[0].end!==undefined?n[0].end*1e3:t.ui.dashboard.possiblyAvailable,name:T&&T[i]?T[i].resources.firstName+" "+T[i].resources.lastName:i};n.length>0?(r.available||(r.available=[]),r.unavailable||(r.unavailable=[]),n[0].state=="com.ask-cs.State.Unreached"?r.unavailable.push(s):n[0].state=="com.ask-cs.State.Unavailable"?r.unavailable.push(s):(n[0].state=="com.ask-cs.State.Available"&&(s.style="sa-icon-reserve-available"),n[0].state=="com.ask-cs.State.KNRM.BeschikbaarNoord"&&(s.style="sa-icon-reserve-available-north"),n[0].state=="com.ask-cs.State.KNRM.BeschikbaarZuid"&&(s.style="sa-icon-reserve-available-south"),n[0].state=="com.ask-cs.State.KNRM.SchipperVanDienst"&&(s.style="sa-icon-reserve-available-schipper"),r.available.push(s))):(r.possible||(r.possible=[]),r.possible.push(s))}}),e.loadingAvailability=!1;var i=function(e,t){return e.end<t.end?-1:e.end>t.end?1:0};r.hasOwnProperty("available")&&r.available.sort(i),r.hasOwnProperty("unavailable")&&r.unavailable.sort(i);var o=[];_.each(r.available,function(e){e.state=="com.ask-cs.State.KNRM.SchipperVanDienst"&&o.push(e)}),_.each(r.available,function(e){e.state=="com.ask-cs.State.Available"&&o.push(e)}),_.each(r.available,function(e){e.state=="com.ask-cs.State.KNRM.BeschikbaarNoord"&&o.push(e)}),_.each(r.available,function(e){e.state=="com.ask-cs.State.KNRM.BeschikbaarZuid"&&o.push(e)}),r.available=o,e.availability={members:r,synced:n.synced*1e3},s.resolve(e.availability)},function(e){s.reject(e)}),s.promise},e.getGroupAvailability=function(){var t=n.defer();return e.current.division="all",e.getAvailability(e.current.group,e.current.division).then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},e.getDivisionAvailability=function(){e.getAvailability(e.current.group,e.current.division)},t.StandBy.config.profile.presence?n.all([e.getGroupAvailability(),p.population()]).then(function(){e.checkPresence()},function(){e.getGroupAvailability().then(function(){e.checkPresence()})}):e.getGroupAvailability(),e.saveOverviewWidget=function(e){t.statusBar.display(t.ui.settings.saving),_.each(e,function(e){e.status||(e.divisions=!1)}),a.save(t.StandBy.resources.uuid,{user:angular.fromJson(v("user").get("resources").settingsWebPaige).user,app:{group:angular.fromJson(v("user").get("resources").settingsWebPaige).app.group,widgets:{groups:e}}}).then(function(){t.statusBar.display(t.ui.dashboard.refreshGroupOverviews),f.get(t.StandBy.resources.uuid,!0).then(function(){S()})})},e.getP2000=function(){s.p2000().then(function(t){e.loading.alerts=!1,e.alarms=t.alarms,e.alarms.list=e.alarms.short,e.synced.alarms=t.synced})},t.alarmSync={start:function(){this.id=r.setInterval(function(){i.path()=="/dashboard"&&e.$apply(function(e){e.getP2000(),t.StandBy.config.profile.smartAlarm?(v("smartAlarm").get("guard").selection&&(console.log("Guard",v("smartAlarm").get("guard").selection),x(v("smartAlarm").get("guard"))),l.guardRole().then(function(e){x(e)})):e.getAvailability(e.current.group)})},t.StandBy.config.timers.ALARM_SYNC),t.intervals.push(this.id)},clear:function(){r.clearInterval(this.id)},id:""},t.alarmSync.start(),e.toggle=function(n){e.alarms.list=n?e.alarms.short:e.alarms.long,e.more.text=n?t.ui.dashboard.showMore:t.ui.dashboard.showLess,e.more.status=!e.more.status},t.StandBy.config.profile.smartAlarm?$.ajax({url:t.StandBy.config.profile.p2000.url,dataType:"json",success:function(n){t.statusBar.off();var r=h.process(n,!0),i={alarms:r,synced:(new Date).getTime()};e.$apply(function(){e.loading.alerts=!1,e.alarms=i.alarms,e.alarms.list=e.alarms.short,e.synced.alarms=i.synced})},error:function(){console.log("ERROR with getting p2000 for the first time!")}}):s.getCapcodes().then(function(n){var r="";n=n.sort(),_.each(n,function(e){r+=e+", "}),e.capcodes=r.substring(0,r.length-2),$.ajax({url:t.StandBy.config.profile.p2000.url+"?code="+n,dataType:"jsonp",success:function(n){t.statusBar.off();var r=h.process(n),i={alarms:r,synced:(new Date).getTime()};e.$apply(function(){e.loading.alerts=!1,e.alarms=i.alarms,e.alarms.list=e.alarms.short,e.synced.alarms=i.synced})},error:function(){console.log("ERROR with getting p2000 for the first time!")}})}),e.setPrefixedAvailability=function(e,t){v("environment").save("setPrefixedAvailability",{availability:e,period:t}),i.path("/planboard").search({setPrefixedAvailability:!0})}}])});