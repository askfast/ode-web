define(["controllers/controllers","config"],function(e,t){e.controller("presence",["$scope","$rootScope","$q","$window","$location","$timeout","Dashboard","Dater","Settings","Profile","Groups","Announcer","Network","Slots","Store","$http",function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){t.notifier.destroy();if(!v.defaults.headers.common["X-SESSION_ID"]){var m=d("session").get("sessionId");v.defaults.headers.common["X-SESSION_ID"]=m.id}t.fixStyles(),$(".navbar").hide(),$("#footer").hide(),$("#watermark").css({bottom:"-10px"});var g=d("network").get("groups"),y=angular.fromJson(d("user").get("resources").settingsWebPaige),b=[],w=["Hoofd BHV","BHV Ploegleider","BHV'er","EHBO'er"];e.loadingPresence=!0,_.each(g,function(e){e.uuid!="all"&&b.push(e)});var E=d("network").get("unique"),S=function(e){var t={},n=[],r=[];return _.each(e,function(e){e.resources.groups?_.each(g,function(n){e.resources.groups[0].uuid===n.uuid&&(typeof t[n.name]=="undefined"&&(t[n.name]=[]),e.resources.groups[0].name=n.name,t[n.name].push(e))}):(typeof t["ungrouped"]=="undefined"&&(t.ungrouped=[]),t.ungrouped.push(e))}),_.each(t,function(e,t){w.indexOf(t)!==-1?n[w.indexOf(t)]=e:r.push(e)}),r.sort(),_.each(r,function(e){n.push(e)}),n=_.compact(n),n};e.checkPresence=function(){var t=d("network").get("unique"),n=e.availability.members.available,r=[];_.each(n,function(e){_.each(t,function(t){e.uuid===t.uuid&&(e.resources=t.resources)}),e.resources&&(e.resources.groups&&e.resources.groups.length>1&&(e.resources.groups=e.resources.groups.slice(0,1)),r.push(e))}),e.loadingPresence=!1,e.present=S(r)},r.setInterval(function(){e.getGroupAvailability().then(e.checkPresence(),function(){})},5e3),r.setInterval(function(){h.population()},7500);var x;g.unshift({name:t.ui.dashboard.everyone,uuid:"all"}),x="all",e.groups=g,e.states=t.StandBy.config.timeline.config.states,e.states["no-state"]={className:"no-state",label:t.ui.dashboard.possiblyAvailable,color:"#ececec",type:t.ui.dashboard.noPlanning,display:!1},e.divisions=t.StandBy.environment.divisions||[],e.divisions.length>0&&e.divisions[0].id!=="all"&&e.divisions.unshift({id:"all",label:t.ui.dashboard.allDivisions}),e.current={group:x,division:"all"},e.loadingAvailability=!0,e.getAvailability=function(r,i){r||(r=e.current.group),i||(i=e.current.division);var s=n.defer();return p.getMemberAvailabilities(r,i).then(function(n){var r={};_.each(angular.fromJson(angular.toJson(n.members)),function(n,i){if(E[i]&&E[i].resources.role!=0&&E[i].resources.role!=4){var s={id:i,uuid:i,state:n.length>0?n[0].state:"no-state",label:n.length>0?e.states[n[0].state].label[0]:"",end:n.length>0&&n[0].end!==undefined?n[0].end*1e3:t.ui.dashboard.possiblyAvailable,name:E&&E[i]?E[i].resources.firstName+" "+E[i].resources.lastName:i,resources:E[i].resources};n.length>0?(r.available||(r.available=[]),r.unavailable||(r.unavailable=[]),n[0].state=="com.ask-cs.State.Unreached"?r.unavailable.push(s):n[0].state=="com.ask-cs.State.Unavailable"?r.unavailable.push(s):(n[0].state=="com.ask-cs.State.Available"&&(s.style="sa-icon-reserve-available"),n[0].state=="com.ask-cs.State.KNRM.BeschikbaarNoord"&&(s.style="sa-icon-reserve-available-north"),n[0].state=="com.ask-cs.State.KNRM.BeschikbaarZuid"&&(s.style="sa-icon-reserve-available-south"),n[0].state=="com.ask-cs.State.KNRM.SchipperVanDienst"&&(s.style="sa-icon-reserve-available-schipper"),r.available.push(s))):(r.possible||(r.possible=[]),r.possible.push(s))}}),e.loadingAvailability=!1;var i=function(e,t){return e.end<t.end?-1:e.end>t.end?1:0};r.hasOwnProperty("available")&&r.available.sort(i),r.hasOwnProperty("unavailable")&&r.unavailable.sort(i);var o=[];_.each(r.available,function(e){e.state=="com.ask-cs.State.KNRM.SchipperVanDienst"&&o.push(e)}),_.each(r.available,function(e){e.state=="com.ask-cs.State.Available"&&o.push(e)}),_.each(r.available,function(e){e.state=="com.ask-cs.State.KNRM.BeschikbaarNoord"&&o.push(e)}),_.each(r.available,function(e){e.state=="com.ask-cs.State.KNRM.BeschikbaarZuid"&&o.push(e)}),r.available=o,e.availability={members:r,synced:n.synced*1e3},s.resolve()},function(e){s.reject}),s.promise},e.getGroupAvailability=function(){e.current.division="all";var t=n.defer();return e.getAvailability(e.current.group,e.current.division).then(function(){t.resolve()},function(){t.reject()}),t.promise},e.getDivisionAvailability=function(){e.getAvailability(e.current.group,e.current.division)},e.getGroupAvailability()}])});