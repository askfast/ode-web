define(["controllers/controllers"],function(e){e.controller("login",function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){function y(t,n){e.StandBy.config.smartAlarm&&f("smartAlarm").save("guard",{monitor:"",role:""}),d.login(t,n).then(function(t){if(t.error&&t.error.status)return r.alert={login:{display:!0,type:"alert-danger",message:t.error.status==400||t.error.status==403||t.error.status==404?"Wrong username or password!":"There has been an error with your login!"}},angular.element("#login button[type=submit]").text(e.ui.login.button_login).removeAttr("disabled"),!1;angular.element("#login").hide(),angular.element("#download").hide(),angular.element("#preloader").show(),E(30,e.ui.login.loading_User),d.resources().then(function(t){E(50,"Setting up environment."),v.setup().then(function(){E(70,e.ui.login.loading_Group),m.groups().then(function(e){E(70,"Populating group members."),m.population().then(function(){b(t,e)})})})})})}function b(t,n){var r=angular.fromJson(t.settingsWebPaige)||{},i=!1,s=!1,u=e.StandBy.config.defaults.settingsWebPaige,a=function(e){var t={};return _.each(e,function(e){t[e.uuid]={status:!0,divisions:!1}}),t};if(r!=null||r!=undefined){r.user?r.user.language?(e.changeLanguage(angular.fromJson(t.settingsWebPaige).user.language),u.user.language=r.user.language):(e.changeLanguage(e.StandBy.config.defaults.settingsWebPaige.user.language),i=!0):i=!0;if(r.app){if(r.app.widgets)if(r.app.widgets.groups){var f=!1;jQuery.isEmptyObject(r.app.widgets.groups)?f=!0:_.each(r.app.widgets.groups,function(e){if(typeof e!="object"||e=={})f=!0}),f?(u.app.widgets.groups=a(n),i=!0):u.app.widgets.groups=r.app.widgets.groups}else u.app.widgets.groups=a(n),i=!0;else u.app.widgets={groups:a(n)},i=!0;if(r.app.group&&r.app.group!=undefined){var l=!0;_.each(n,function(e){var t=new RegExp(r.app.group);t.test(e.uuid)?l=!0:l||(l=!1)}),l||(i=!0)}else s=!0,i=!0}else u.app={widgets:{groups:a(n)}},i=!0}else u={user:e.StandBy.config.defaults.settingsWebPaige.user,app:{widgets:{groups:a(n)},group:n[0].uuid}},i=!0;if(i)s?o.parents().then(function(r){r!=null?u.app.group=r:u.app.group=n[0].uuid,c.save(t.uuid,u).then(function(){d.resources().then(function(t){e.StandBy.resources=t,w()})})}):(u.app.group=n[0].uuid,c.save(t.uuid,u).then(function(){d.resources().then(function(t){e.StandBy.resources=t,w()})}));else{try{ga("send","pageview",{dimension1:t.uuid,dimension2:e.StandBy.environment.domain}),ga("send","event","Login",t.uuid)}catch(h){}w()}}function w(){E(100,e.ui.login.loading_everything),t.search({}),setTimeout(function(){angular.element("body").css({background:"url(../images/bg.jpg) repeat"}),angular.element(".navbar").show(),angular.element("#watermark").show(),e.browser.mobile||angular.element("#footer").show()},e.StandBy.config.timers.TICKER),u.query().then(function(){e.StandBy.unreadMessages=u.unreadCount()}),t.path("/dashboard")}function E(e,t){angular.element("#preloader .progress .progress-bar").css({width:e+"%"}),angular.element("#preloader span").text(t)}l.uuid&&l.key?(r.views={changePass:!0},r.changepass={uuid:l.uuid,key:l.key}):r.views={login:!0,forgot:!1},r.alert={login:{display:!1,type:"",message:""},forgot:{display:!1,type:"",message:""}},angular.element(".navbar").hide(),angular.element("#footer").hide(),angular.element("#watermark").hide(),e.StandBy.config.profile.showBackground&&angular.element("body").css({background:"url(../"+e.StandBy.config.profile.background+") no-repeat center center fixed",backgroundSize:"cover"}),navigator.userAgent.indexOf("Firefox")>=0&&angular.element("#login form").attr("autocomplete","off");var g=f("environment").get("logindata");g&&g.remember&&(r.logindata=g),r.login=function(){var t=f("notifications").get("registeredNotifications"),n=f("app").get("periods"),i=f("app").get("periodsNext");f("network").nuke(),f("environment").nuke(),f("messages").nuke(),f("records").nuke(),f("smartAlarm").nuke(),f("notifications").nuke(),f("user").nuke(),f("app").nuke(),a.clearAll(),a.session.clearAll(),f("notifications").save("registeredNotifications",t),f("app").save("periods",n),f("app").save("periodsNext",i),angular.element("#alertDiv").hide(),angular.element("#login button[type=submit]").text(e.ui.login.button_loggingIn).attr("disabled","disabled");if(!r.logindata||!r.logindata.username||!r.logindata.password)return r.alert={login:{display:!0,type:"alert-danger",message:e.ui.login.alert_fillfiled}},angular.element("#login button[type=submit]").text(e.ui.login.button_login).removeAttr("disabled"),!1;f("environment").save("logindata",{username:r.logindata.username,password:r.logindata.password,remember:r.logindata.remember}),f("environment").save("askPass",p(r.logindata.password)),y(r.logindata.username,r.logindata.password)},t.search().username&&t.search().password&&y(t.search().username,t.search().password),r.forgot=function(){angular.element("#forgot button[type=submit]").text(e.ui.login.setting).attr("disabled","disabled"),d.password(r.remember.id).then(function(t){t=="ok"?r.alert={forget:{display:!0,type:"alert-success",message:e.ui.login.checkYourMail}}:r.alert={forget:{display:!0,type:"alert-danger",message:e.ui.errors.login.forgotCantFind}},angular.element("#forgot button[type=submit]").text(e.ui.login.button_changePassword).removeAttr("disabled")})},r.changePass=function(){angular.element("#alertDiv").hide();if(!r.changeData||!r.changeData.newPass||!r.changeData.retypePass)return r.alert={changePass:{display:!0,type:"alert-danger",message:e.ui.errors.login.changePassAllFields}},angular.element("#changePass button[type=submit]").text(e.ui.login.button_changePassword).removeAttr("disabled"),!1;if(r.changeData.newPass!=r.changeData.retypePass)return r.alert={changePass:{display:!0,type:"alert-danger",message:e.ui.errors.login.changePassNoMatch}},angular.element("#changePass button[type=submit]").text(e.ui.login.button_changePassword).removeAttr("disabled"),!1;angular.element("#changePass button[type=submit]").text(e.ui.login.button_changingPassword).attr("disabled","disabled"),d.changePass(r.changepass.uuid,p(r.changeData.newPass),r.changepass.key).then(function(n){n.status==400||n.status==500||n.status==409?r.alert={changePass:{display:!0,type:"alert-danger",message:e.ui.errors.login.changePass}}:(r.alert={changePass:{display:!0,type:"alert-success",message:e.ui.login.passwordChanged}},t.path("/message")),angular.element("#changePass button[type=submit]").text(e.ui.login.button_changePassword).removeAttr("disabled")})},f("environment").has("sessionTimeout",function(t){t&&(f("environment").remove("sessionTimeout"),r.alert={login:{display:!0,type:"alert-danger",message:e.ui.login.sessionTimeout}})})})});