define(["controllers/controllers"],function(e){e.controller("tasksCtrl",["$rootScope","$scope","$location","Store","Teams","Clients","Dater","TeamUp","$filter","$route","$timeout",function(e,t,n,r,i,s,o,u,a,f,l){function m(){t.views={myTasks:!1,allTasks:!1,newTask:!1}}e.fixStyles(),t.myTasks=r("app").get("myTasks"),t.allTasks=r("app").get("allTasks"),t.allTasks=a("orderBy")(t.allTasks,"plannedStartVisitTime",!0),t.myTasks=a("orderBy")(t.myTasks,"plannedStartVisitTime",!0),t.orders=[{id:1,name:e.ui.task.orderType1},{id:2,name:e.ui.task.orderType2}];var c=n.search();c.orderType?t.currentOrder=c.orderType:t.currentOrder=1,t.orderItem="plannedStartVisitTime",t.reverse=!0,t.resort=function(e){if(e=="clientName")l(function(){t.orderItem="relatedClientName"});else if(e=="memberName"){var n=function(e){return a("getObjAttr")(e.assignedTeamMemberUuid,"member","name")+""};t.orderItem=n}else t.orderItem=e;t.reverse=!t.reverse};var h=i.queryLocal(),p=s.queryLocal(),d=i.queryLocalClientGroup(h.teams);t.teams=h.teams;if(t.currentTeam==null||typeof t.currentTeam=="undefined")t.currentTeam=h.teams[0].uuid;t.members=h.members[t.currentTeam],t.groups=[],t.clients=[],t.teamAffectGroup=function(e){angular.forEach(p.clientGroups,function(e){t.currentGroup==e.id&&(t.groups=[],t.groups.push(e))}),t.groupAffectClient(t.currentGroup)},t.groupAffectClient=function(e){t.clients=p.clients[e],(t.curentClient==null||typeof t.curentClient=="undefined")&&t.clients&&t.clients.length>0?t.curentClient=t.clients[0].uuid:t.curentClient=null,t.task&&t.task.client&&(t.task.client=t.curentClient)},typeof d[t.currentTeam]=="undefined"?t.currentGroup=null:(t.currentGroup=d[t.currentTeam],t.teamAffectGroup(t.currentTeam),t.groupAffectClient(t.currentGroup)),t.changeClientGroup=function(e){t.groupAffectClient(e)},t.changeTeam=function(e){t.members=h.members[e],t.currentGroup=d[e],t.teamAffectGroup(e)},t.validateTaskForm=function(n){return!n||!n.start||!n.end?(e.notifier.error(e.ui.task.filltheTime),!1):n.start.date==""||n.start.time==""||!n.start.time?(e.notifier.error(e.ui.task.startTimeEmpty),!1):n.end.date==""||n.end.time==""||!n.end.time?(e.notifier.error(e.ui.task.endTimeEmpty),!1):(t.task.startTime=e.browser.mobile?(new Date(n.start.date)).getTime():o.convert.absolute(n.start.date,n.start.time,!1),t.task.endTime=e.browser.mobile?(new Date(n.end.date)).getTime():o.convert.absolute(n.end.date,n.end.time,!1),t.task.startTime<=Date.now().getTime()||t.task.endTime<=Date.now().getTime()?(e.notifier.error(e.ui.task.planTaskInFuture),!1):t.task.startTime>=t.task.endTime?(e.notifier.error(e.ui.task.startLaterThanEnd),!1):!n.client||n.client==null?(e.notifier.error(e.ui.task.specifyClient),!1):!0)},t.reloadAndSaveTask=function(t,i){u._("taskById",{second:t},null).then(function(s){if(s.error&&i!="delete")e.notifier.error(s.error);else{var o=r("app").get("allTasks"),u=r("app").get("myTasks"),l="",c=function(e,t){var n=0;for(;n<e.length;n++)t==e[n].uuid&&(e.splice(n,1),n--);return e};if(i=="assign"||i=="unAssign"||i=="add"){var h=a("getByUuid")(o,s.uuid),p=a("getByUuid")(u,s.uuid);if(s.assignedTeamMemberUuid&&s.assignedTeamMemberUuid==e.app.resources.uuid){h&&(o=c(o,h.uuid)),p&&(u=c(u,p.uuid));if(!u.length||u.length==0)u=[];u.push(s)}else{h&&(o=c(o,h.uuid)),p&&(u=c(u,p.uuid));if(!o.length||o.length==0)o=[];o.push(s)}s.assignedTeamMemberUuid&&s.assignedTeamMemberUuid==e.app.resources.uuid?l="myTasks":l="allTasks"}else i=="delete"?(o=c(o,t),u=c(u,t),l=n.hash(),f.reload()):i=="update";r("app").save("allTasks",o),r("app").save("myTasks",u),n.hash(l)}})},t.createTask=function(n){if(!t.validateTaskForm(n))return;var r={uuid:"",status:2,plannedStartVisitTime:t.task.startTime,plannedEndVisitTime:t.task.endTime,relatedClientUuid:n.client,assignedTeamUuid:n.team,description:n.description,assignedTeamMemberUuid:n.member};u._("taskAdd",null,r).then(function(n){n.error?n.error.data?e.notifier.error(e.transError(n.error.data.result)):e.notifier.error(e.transError(n.error)):(e.notifier.success(e.ui.task.taskSaved),t.reloadAndSaveTask(n.result,"add"))})};var v;n.hash()?v=n.hash():v="myTasks";var g=function(e){m(),t.views[e]=!0};t.setViewTo=function(e){t.$watch(e,function(){n.hash(e),g(e)})},g(v),t.assignYourself=function(n){n.assignedTeamMemberUuid=e.app.resources.uuid,u._("taskUpdate",{second:n.uuid},n).then(function(r){r.error?(r.error.data.result?e.notifier.error(e.transError(r.error.data.result)):e.notifier.error(e.transError(r.error)),n.assignedTeamMemberUuid=null):t.reloadAndSaveTask(r.result,"assign")})},t.unassignYourself=function(n){n.assignedTeamMemberUuid=null,u._("taskUpdate",{second:n.uuid},n).then(function(r){r.error?(r.error.data?e.notifier.error(e.transError(r.error.data.result)):e.notifier.error(e.transError(r.error)),n.assignedTeamMemberUuid=null):t.reloadAndSaveTask(r.result,"unAssign")})},t._task={},t.confirmDeleteTask=function(e){l(function(){t._task=e,angular.element("#confirmTaskModal").modal("show")})},t.deleteTask=function(n){t._task={},angular.element("#confirmTaskModal").modal("hide"),u._("taskDelete",{second:n.uuid},n).then(function(n){n.error?n.error.data?e.notifier.error(n.error.data):e.notifier.error(n.error):(e.notifier.success(e.ui.task.taskDeleted),t.reloadAndSaveTask(n.uuid,"delete"))})},t.updateTask=function(e){},v!="myTasks"&&v!="allTasks"&&(t.map={center:{latitude:52,longitude:4},zoom:8,bounds:{}}),t.$on("$viewContentLoaded",function(){$("#task-map .angular-google-map-container").height(500),google.maps.event.trigger($("#task-map"),"resize"),e.taskVisit||(e.$broadcast("taskFinishLoading"),e.taskVisit=!0)}),t.clientCoords={latitude:0,longitude:0},t.changeClient=function(e){var n=a("getObjAttr")(e,"client","latlong"),r=n.split(",");r.length==2&&(t.clientCoords.latitude=r[0],t.clientCoords.longitude=r[1],t.map.center.latitude=r[0],t.map.center.longitude=r[1])},t.sortableOptions={update:function(e,n){var r=t.myTasks.map(function(e){return e.plannedEndVisitTime}).join(", ")},stop:function(e,n){var r=t.myTasks.map(function(e){return e.plannedEndVisitTime}).join(", ")},cancel:function(e,t){}},t.tasksPerPage=7,c.tasksPerPage&&(t.taskPerPage=parseInt(c.tasksPerPage));var y=1;c.currentPage&&(y=parseInt(c.currentPage),v=="myTasks"?y>Math.round(t.myTasks.length/t.tasksPerPage)&&(y=1):v=="allTasks"&&y>Math.round(t.allTasks.length/t.tasksPerPage)&&(y=1)),t.allTaskCurrentPage=y,t.myTaskCurrentPage=y,t.maxSize=10,c.maxSize&&(t.maxSize=parseInt(c.maxSize)),t.currentTasks=[],v=="allTasks"&&t.$watch("allTaskCurrentPage",function(){t.currentTasks=[];var e=[];angular.forEach(t.allTasks,function(n,r){r>=(t.allTaskCurrentPage-1)*t.tasksPerPage&&r<t.allTaskCurrentPage*t.tasksPerPage&&e.push(n)}),t.currentTasks=e}),v=="myTasks"&&t.$watch("myTaskCurrentPage",function(){t.currentTasks=[];var e=[];angular.forEach(t.myTasks,function(n,r){r>=(t.myTaskCurrentPage-1)*t.tasksPerPage&&r<t.myTaskCurrentPage*t.tasksPerPage&&e.push(n)}),t.currentTasks=e}),t.refreshTask=function(n){e.statusBar.display(e.ui.task.refreshTask);if(n=="my")u._("taskMineQuery").then(function(n){console.log("result ->",n),angular.forEach(n,function(t){var n=e.getClientByID(t.relatedClientUuid);console.log("client ->",n)}),r("app").save("myTasks",n),t.myTasks=r("app").get("myTasks"),t.myTasks=a("orderBy")(t.myTasks,t.orderItem,!0),t.myTaskCurrentPage!=1?(t.myTaskCurrentPage=1,e.statusBar.off()):(t.myTaskCurrentPage=0,setTimeout(function(){t.myTaskCurrentPage=1,e.statusBar.off()},500))});else if(n=="all"){var i=[];angular.forEach(t.teams,function(n){u._("taskByTeam",{fourth:n.uuid}).then(function(n){angular.forEach(n,function(e){var t=a("getByUuid")(i,e.uuid);t==null&&i.push(e)}),r("app").save("allTasks",i),t.allTasks=a("orderBy")(i,"plannedStartVisitTime",!0),t.allTaskCurrentPage!=1?(t.allTaskCurrentPage=1,e.statusBar.off()):(t.allTaskCurrentPage=0,setTimeout(function(){t.allTaskCurrentPage=1,e.statusBar.off()},500))})})}}}])});