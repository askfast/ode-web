define(["controllers/controllers"],function(e){e.controller("groups",["$rootScope","$scope","$location","data","Groups","Profile","$route","$routeParams","Slots","$timeout","Settings","Store",function(e,t,n,r,i,s,o,u,a,f,l,c){function y(n){_.each(r.groups,function(e){e.uuid==n&&(t.group=e)}),t.members=r.members[n],t.members.sort(function(t,n){var r,i;return e.StandBy.config.profile.meta!="demo"?(r=t.resources.lastName.toLowerCase(),i=n.resources.lastName.toLowerCase()):typeof t.resources.lastName!="undefined"&&t.resources.lastName!=null&&typeof n.resources.lastName!="undefined"&&n.resources.lastName!=null?(r=t.resources.lastName.toLowerCase(),i=n.resources.lastName.toLowerCase()):(r=t.uuid.toLowerCase(),i=n.uuid.toLowerCase()),r<i?-1:r>i?1:0}),t.current=n,b(n)}function b(e){t.wished=!1,i.wish(e).then(function(n){t.wished=!0,t.wish=n.count,t.popover={id:e,wish:n.count}})}function w(e){t.views={view:!1,add:!1,edit:!1,search:!1,member:!1},t.views[e]=!0}e.fixStyles(),e.resetPhoneNumberChecker();var h=n.search();t.search={query:""},t.selection={},t.data=r;var p=!1;_.each(r.members,function(e){_.each(e,function(e){e.resources.PhoneAddresses&&(p=!0)})}),t.PhoneAddressesExist=p,t.roles=e.StandBy.config.roles,t.groups=r.groups;var d,v;if(!h.uuid&&!n.hash()){var m=angular.fromJson(c("user").get("resources").settingsWebPaige);d=m.app.group;var g=!1;_.each(r.groups,function(e){var t=new RegExp(d);t.test(e.uuid)?g=!0:g||(g=!1)}),g||(d=r.groups[0].uuid),v="view",n.search({uuid:d}).hash("view")}else d=h.uuid,v=n.hash();y(d),w(v),t.saveWish=function(t,n){e.statusBar.display(e.ui.planboard.changingWish),a.setWish({id:t,start:255600,end:860400,recursive:!0,wish:n}).then(function(n){e.statusBar.off(),n.error?(e.notifier.error(e.ui.errors.groups.saveWish),console.warn("error ->",n)):e.notifier.success(e.ui.planboard.wishChanged),b(t)})},t.requestGroup=function(e,r){y(e),t.$watch(n.search(),function(){n.search({uuid:e})}),r&&(n.hash()!="view"&&n.hash("view"),w("view"))},t.setViewTo=function(e){t.$watch(e,function(){n.hash(e),w(e)})},t.addGroupForm=function(){t.views.add?t.closeTabs():(t.groupForm={},t.setViewTo("add"))},t.newMemberForm=function(){t.views.member?t.closeTabs():(t.memberForm={},t.memberForm.PhoneAddress="",t.memberForm.username="",t.memberForm.password="",t.memberForm.role={id:3},t.setViewTo("member"))},t.editGroup=function(e){t.setViewTo("edit"),t.groupForm={id:e.uuid,name:e.name}},t.closeTabs=function(){f(function(){t.groupForm={},t.memberForm={},t.selectionMaster={},t.selection={},t.setViewTo("view")})},t.searchMembers=function(n){e.statusBar.display(e.ui.groups.searchingMembers),i.search(n).then(function(r){r.error?(e.notifier.error(e.ui.errors.groups.searchMembers),console.warn("error ->",r)):(t.search={query:"",queried:n},t.candidates=r,t.setViewTo("search"),e.statusBar.off())})},t.addMember=function(r){e.statusBar.display(e.ui.groups.addingNewMember),i.addMember(r).then(function(r){r.error?(e.notifier.error(e.ui.errors.groups.addMember),console.warn("error ->",r)):(e.notifier.success(e.ui.groups.memberAdded),e.statusBar.display(e.ui.groups.refreshingGroupMember),i.query().then(function(r){r.error?(e.notifier.error(e.ui.errors.groups.query),console.warn("error ->",r)):(t.data=r,e.statusBar.off(),n.hash()=="search"&&t.searchMembers(t.search.query))}))})},t.removeMember=function(n,r){e.statusBar.display(e.ui.groups.removingMember),i.removeMember(n,r).then(function(n){n.error?(e.notifier.error(e.ui.errors.groups.removeMember),console.warn("error ->",n)):(e.notifier.success(e.ui.groups.memberRemoved),e.statusBar.display(e.ui.groups.refreshingGroupMember),i.query().then(function(n){n.error?(e.notifier.error(e.ui.errors.groups.query),console.warn("error ->",n)):(t.data=n,e.statusBar.off())}))})},t.removeMembers=function(n,r){e.statusBar.display(e.ui.groups.removingSelected);var s=!1;_.each(n,function(e,t){e&&(s=!0)}),s?i.removeMembers(n,r).then(function(n){n.error?(e.notifier.error(e.ui.errors.groups.removeMembers),console.warn("error ->",n)):(e.notifier.success(e.ui.groups.memberRemoved),e.statusBar.display(e.ui.groups.refreshingGroupMember),t.selection={},i.query().then(function(n){n.error?(e.notifier.error(e.ui.errors.groups.query),console.warn("error ->",n)):(t.data=n,e.statusBar.off())}))}):e.notifier.error(e.ui.errors.groups.noSelection)},t.groupSubmit=function(r){e.statusBar.display(e.ui.groups.saving),i.save(r).then(function(r){r.error?(e.notifier.error(e.ui.errors.groups.groupSubmit),console.warn("error ->",r)):(e.notifier.success(e.ui.groups.groupSaved),e.statusBar.display(e.ui.groups.refreshingGroupMember),i.query().then(function(i){i.error?(e.notifier.error(e.ui.errors.groups.query),console.warn("error ->",i)):(t.closeTabs(),t.data=i,_.each(i.groups,function(e){e.uuid==r&&(t.groups=i.groups,_.each(i.groups,function(n){n.uuid==e.uuid&&(t.group=n)}),t.members=i.members[e.uuid],t.current=e.uuid,t.$watch(n.search(),function(){n.search({uuid:e.uuid})}))}),e.statusBar.off())}))})};var E=250;t.userExistsValidation=!0,t.userExists=function(){t.memberForm.username!=""||t.memberForm.username.length>0?(t.checkUsername&&(clearTimeout(t.checkUsername),t.checkUsername=null),t.checkUsername=setTimeout(function(){t.checkUsername=null,s.userExists(t.memberForm.username).then(function(e){t.userExistsValidation=e})},E)):t.memberForm.username=""},t.checkUsername=null,t.memberSubmit=function(r){if(r.username==""||r.password==""){e.notifier.error(e.ui.errors.groups.emptyUserCredentials),$(window).scrollTop(0);return}if(!t.userExistsValidation){e.notifier.error(e.ui.groups.registerUserName.pleaseChooseAnother),$(window).scrollTop(0);return}e.statusBar.display(e.ui.groups.registerNew);if(r==undefined||r.PhoneAddress=="")e.phoneNumberParsed.result=!0;if(e.phoneNumberParsed.result){if(r.PhoneAddress){var o=phoneNumberParser(r.PhoneAddress,"NL");r.PhoneAddress=o.formatting.e164}s.register(r).then(function(s){s.error?(s.error.status===409?(e.notifier.error(e.ui.errors.groups.memberSubmitRegistered),e.statusBar.off(),$(window).scrollTop(0)):s.error.status===403?(e.notifier.error(e.ui.errors.groups.failedRegistration),e.statusBar.off(),$(window).scrollTop(0)):e.notifier.error(e.ui.errors.groups.memberSubmitRegister),console.warn("error ->",s)):(e.notifier.success(e.ui.groups.memberRegstered),e.statusBar.display(e.ui.groups.refreshingGroupMember),i.query().then(function(i){i.error?(e.notifier.error(e.ui.errors.groups.query),console.warn("error ->",i)):(t.data=i,n.path("/profile/"+r.username).hash("profile"),e.statusBar.off())}))})}else e.notifier.error(e.ui.errors.phone.notValidOnSubmit),e.statusBar.off(),$(window).scrollTop(0)},t.confirmGroupDelete=function(t){e.notifier.alert("",!1,!0,{section:"groups",id:t})},e.$on("fireGroupDelete",function(e,n){t.deleteGroup(n.id)}),t.deleteGroup=function(r){e.statusBar.display(e.ui.groups.deleting),i.remove(r).then(function(r){r.error?(e.notifier.error(e.ui.errors.groups.deleteGroup),console.warn("error ->",r)):(e.notifier.success(e.ui.groups.deleted),e.statusBar.display(e.ui.groups.refreshingGroupMember),i.query().then(function(r){r.error?(e.notifier.error(e.ui.errors.groups.query),console.warn("error ->",r)):(t.data=r,_.each(r.groups,function(e,i){t.groups=r.groups,t.group=r.groups[0],t.members=r.members[r.groups[0].uuid],t.current=r.groups[0].uuid,t.$watch(n.search(),function(){n.search({uuid:r.groups[0].uuid})})}),e.statusBar.off())}))})},t.fetchParent=function(){i.parents().then(function(e){console.log("parent -> ",e)})},t.fetchContainers=function(e){i.containers(e).then(function(e){console.log("containers -> ",e)})},t.toggleSelection=function(e,n){var r=n?!1:!0,i=c("network").get(e.uuid);_.each(i,function(e){t.selection[e.uuid]=r})},t.reverse=!1,t.sorter="resources.lastName",t.toggleSorter=function(e){t.reverse=t.sorter==e?!t.reverse:!1,t.sorter=e}}])});