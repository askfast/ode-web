define(["controllers/controllers"],function(e){e.controller("treegrid",["$rootScope","$scope","$window",function(e,t,n){t.treeGrid={options:{grid:{width:"auto",height:null,items:{minHeight:40}}},type:null,grid:null,data:{},processed:{},grids:{},stores:{},caches:{},connections:{},areas:function(){this.options.grid.height=angular.element("#wrap").height()-470+"px"},build:function(e,n){var r=this,i=t.treeGrid.grid+"_"+e;this.grids[i]=new links.TreeGrid(document.getElementById(t.treeGrid.grid+"_"+e),this.options.grid),angular.forEach(this.stores,function(e){var t=[];angular.forEach(e.data,function(e){e._id&&t.push(e)}),e.data=e.filteredData=t}),this.grids[i].draw(this.store(e,n)),links.events.addListener(this.grids[i],"expand",function(e){console.log("expanding ->",i,e)}),links.events.addListener(this.grids[i],"collapse",function(e){console.log("collapsing ->",i,e)}),links.events.addListener(this.grids[i],"select",function(e){console.log("selecting ->",i,e)}),links.events.addListener(this.grids[i],"remove",function(e){var t=e.items;for(var n=0;n<t.length;n++)r.stores[i].removeLink(t[n])})},store:function(e,n){var r=this,i=t.treeGrid.grid+"_"+e;return this.stores[i]=new links.DataTable(this.process(e,n),this.configure(e)),this.stores[i].totalItems=this.stores[i].data.length,this.stores[i].appendItems=function(e,t){function n(e,t){var n=!0;for(var r=0;r<t.length;r++)e._id==t[r]._id&&(n=!1);return e.nodes&&(n=!1),n}for(var r=0;r<e.length;r++){var i=n(e[r],this.data);i&&(e[r]._actions=[{event:"remove",text:"remove"}],this.data.push(e[r]))}i&&(this.updateFilters(),t&&t({totalItems:this.filteredData.length,items:e}),this.trigger("change",undefined))},this.stores[i].linkItems=function(e,t,n,r){var i=this.data.indexOf(t);if(i==-1){r("Error: targetItem not found in data");return}var s=[],o=[];for(var u=0;u<e.length;u++)s.push(e[u].name),o.push(e[u]._id);this.data[i]={_id:t._id,name:t.name,links:s.join(", "),_ids:o.join(", "),_actions:[{event:"unlink",text:"unlink"}]},n({items:[t],totalItems:this.data.length}),this.update()},this.stores[i].unlink=function(e){var t=this.data.indexOf(e);if(t==-1)throw Error("item not found in data");this.data[t]={_id:e._id,name:e.name},this.update()},this.stores[i].removeLink=function(e){var t=[];angular.forEach(r.stores[e._parent].data,function(n){n._id!=e._id&&t.push(n)}),r.stores[e._parent].data=r.stores[e._parent].filteredData=t,this.updateFilters(),this.trigger("change",undefined);var n=[],i=e._parent.split("_"),s=i[0],o=i[i.length-1];angular.forEach(r.connections[s][o],function(t){t._id!=e._id&&(t._actions=[{event:"remove",text:"remove"}],n.push(t))}),r.connections[s][o]=r.caches[e._parent]=n,this.update()},links.events.addListener(this.stores[i],"change",function(){angular.forEach(r.stores[i].data,function(e){e._parent=i}),r.caches[i]=r.stores[i].data}),links.events.addListener(this.stores[i],"unlink",function(e){var t=e.items;for(var n=0;n<t.length;n++)r.stores[i].unlink(t[n])}),t.treeGrid.grid=="teamClients"&&e=="right"&&this.connections.teamClients.length>0&&angular.forEach(this.connections.teamClients,function(e){var t;angular.forEach(r.stores.teamClients_right.data,function(n,i){if(e.targetItem.id==n._id){t=i;var s=[],o=[];for(var u=0;u<e.sourceItems.length;u++)s.push(e.sourceItems[u].name),o.push(e.sourceItems[u].id);r.stores.teamClients_right.data[t]={_id:e.targetItem.id,name:e.targetItem.name,links:s.join(", "),_ids:o.join(", "),_actions:[{event:"unlink",text:"unlink"}]},r.stores.teamClients_right.update()}})}),this.stores[i]},process:function(e,n){var r=this,i=[],s=t.treeGrid.grid+"_"+e;return angular.forEach(n,function(e){e.id&&i.push(e)}),this.processed[s]=[],angular.forEach(i,function(t){var n=r.grid+"_"+e+"_"+t.id,i={name:t.name,_id:t.id,_parent:n};if(r.type=="1:n"&&e=="right"){r.grid=="teams"&&r.connections.teams[t.id]&&r.connections.teams[t.id].length>0&&setTimeout(function(){r.stores[n].appendItems(r.connections.teams[t.id],function(e){r.stores[n].totalItems=e.totalItems})},100),r.grid=="clients"&&r.connections.clients[t.id]&&r.connections.clients[t.id].length>0&&setTimeout(function(){r.stores[n].appendItems(r.connections.clients[t.id],function(e){r.stores[n].totalItems=e.totalItems})},100);var o=r.caches[n]?r.caches[n]:[];i.nodes=r.store(e+"_"+t.id,o)}r.processed[s].push(i)}),this.processed[s]},configure:function(e){var t={showHeader:!1,dataTransfer:{}};switch(this.type){case"1:1":switch(e){case"left":t.dataTransfer={allowedEffect:"link"};break;case"right":t.dataTransfer={dropEffect:"link"}}break;case"1:n":t.dataTransfer={allowedEffect:"copy",dropEffect:"copy"}}return t},init:function(){this.areas(),this.build("left",this.data.left),this.build("right",this.data.right)}},e.$on("TreeGridManager",function(){t.treeGrid.grid=arguments[1],t.treeGrid.type=arguments[2],t.treeGrid.data=arguments[3],t.treeGrid.connections=arguments[4],function(e){setTimeout(function(){e.treeGrid.init()},100)}(t)}),n.onresize=function(){t.treeGrid.init()},t.extract=function(e){var t={};return angular.forEach(e,function(e){if(e.nodes.data.length>0){var n=[];angular.forEach(e.nodes.data,function(e){n.push(e._id)}),t[e._id]=n}}),t},t.save={teamClients:function(){var n=t.treeGrid.stores.teamClients_right.data,r={};angular.forEach(n,function(e){if(e._ids||e.links)r[e._id]=e._ids}),e.$broadcast("save:teamClients",r)},teams:function(){e.$broadcast("save:teams",t.extract(t.treeGrid.stores.teams_right.data))},clients:function(){e.$broadcast("save:clients",t.extract(t.treeGrid.stores.clients_right.data))}},t.getData={teamClients:function(){var e=t.treeGrid.stores.teamClients_right.data,n={};return angular.forEach(e,function(e){if(e._ids||e.links)n[e._id]=e._ids}),n},teams:function(){return t.extract(t.treeGrid.stores.teams_right.data)},clients:function(){return t.extract(t.treeGrid.stores.clients_right.data)}}}])});