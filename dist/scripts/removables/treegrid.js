/**
 * @file treegrid.js
 *
 * @brief
 * TreeGrid is a visualization which represents data in a hierarchical grid
 * view. It is designed to handle large amouts of data, and has options for lazy
 * loading. Items in the TreeGrid can contain custom HTML code. Information in
 * one item can be spread over multiple columns, and can have action buttons on
 * the right.
 * TreeGrid offers built in functionality to sort, arrange, and filter items.
 *
 * TreeGrid is part of the CHAP Links library.
 *
 * TreeGrid is tested on Firefox 3.6, Safari 5.0, Chrome 6.0, Opera 10.6, and
 * Internet Explorer 9+.
 *
 * @license
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy
 * of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 * Copyright (c) 2011-2012 Almende B.V.
 *
 * @author   Jos de Jong, <jos@almende.org>
 * @date    2012-07-03
 * @version 1.2.0
 */

/**
 * Drag and Drop library
 *
 * This module allows to create draggable and droppable elements in a webpage,
 * and easy transfer of data of any type between drag and drop areas.
 *
 * The interface of the library is equal to the 'real' drag and drop API.
 * However, this library works on all browsers without issues (in contrast to
 * the official drag and drop API).
 * https://developer.mozilla.org/En/DragDrop/Drag_and_Drop
 *
 * The library is tested on: Chrome, Firefox, Opera, Safari,
 * Internet Explorer 5.5+
 *
 * DOCUMENTATION
 *
 * To create a draggable area, use the method makeDraggable:
 *   dnd.makeDraggable(element, options);
 *
 * with parameters:
 *   {HTMLElement} element   The element to become draggable.
 *   {Object}      options   An object with options.
 *
 * available options:
 *   {String} effectAllowed  The allowed drag effect. Available values:
 *                           'copy', 'move', 'link', 'copyLink',
 *                           'copyMove', 'linkMove', 'all', 'none'.
 *                           Default value is 'all'.
 *   {String or HTMLElement} dragImage
 *                           Image to be used as drag image. If no
 *                           drag image is provided, an opague clone
 *                           of the drag area is used.
 *   {Number} dragImageOffsetX
 *                           Horizontal offset for the drag image
 *   {Number} dragImageOffsetY
 *                           Vertical offset for the drag image
 *   {function} dragStart    Method called once on start of a drag.
 *                           The method is called with an event object
 *                           as parameter. The event object contains a
 *                           parameter 'data' to pass data to a drop
 *                           event. This data can be any type.
 *   {function} drag         Method called repeatedly while dragging.
 *                           The method is called with an event object
 *                           as parameter.
 *   {function} dragEnd      Method called after the drag event is
 *                           finished. The method is called with an
 *                           event object as parameter. This event
 *                           object contains a parameter 'dropEffect'
 *                           with the applied drop effect, which is
 *                           undefined when no drop occurred.
 *
 * To make a droppable area, use the method makeDroppable:
 *   dnd.makeDroppable(element, options);
 *
 * with parameters:
 *   {HTMLElement} element   The element to become droppable.
 *   {Object}      options   An object with options.
 *
 * available options:
 *   {String} dropEffect     The drop effect. Available
 *                           values: 'copy', 'move', 'link', 'none'.
 *                           Default value is 'link'
 *   {function} dragEnter    Method called once when the dragged image
 *                           enters the drop area. Can be used to
 *                           apply visual effects to the drop area.
 *   {function} dragLeave    Method called once when the dragged image
 *                           leaves the drop area. Can be used to
 *                           remove visual effects from the drop area.
 *   {function} dragOver     Method called repeatedly when moving
 *                           over the drop area.
 *   {function} drop         Method called when the drag image is
 *                           dropped on this drop area.
 *                           The method is called with an event object
 *                           as parameter. The event object contains a
 *                           parameter 'data' which can contain data
 *                           provided by the drag area.
 *
 * Created draggable or doppable areas are registed in the drag and
 * drop module. To remove a draggable or droppable area, the
 * following methods can be used respectively:
 *   dnd.removeDraggable(element);
 *   dnd.removeDroppable(element);
 *
 * which removes all drag and drop functionality from the concerning
 * element.
 *
 *
 * EXAMPLE
 *
 *   var drag = document.getElementById('drag');
 *   dnd.makeDraggable(drag, {
 *     'dragStart': function (event) {
 *       event.data = 'Hello World!'; // data can be any type
 *     }
 *   });
 *
 *   var drop = document.getElementById('drop');
 *   dnd.makeDroppable(drop, {
 *     'drop': function (event) {
 *       alert(event.data);                     // will alert 'Hello World!'
 *     },
 *     'dragEnter': function (event) {
 *       drop.style.backgroundColor = 'yellow'; // set visual effect
 *     },
 *     'dragLeave': function (event) {
 *       drop.style.backgroundColor = '';       // remove visual effect
 *     }
 *   });
 *
 *
 * @license
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy
 * of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 * Copyright (c) 2011-2012 Almende B.V. <http://www.almende.com>
 *
 * @author Jos de Jong <jos@almende.org>
 * @date   2012-02-09
 */

typeof links=="undefined"&&(links={}),typeof google=="undefined"&&(google=undefined),links.TreeGrid=function(e,t){Array.prototype.indexOf||(Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]==e)return t;return-1}),this.options={width:"100%",height:"100%",padding:4,indentationWidth:20,items:{defaultHeight:24,minHeight:24},dropAreaHeight:0};try{t.itemHeight!=undefined&&console.log("WARNING: property option.itemHeight is no longer supported. It is changed to options.items.defaultHeight")}catch(n){}t&&links.TreeGrid.extend(this.options,t);while(e.hasChildNodes())e.removeChild(e.firstChild);this.frame=new links.TreeGrid.Frame(e,this.options),this.frame.setTreeGrid(this),this.frame.repaint(),this.frame.reflow(),this.trigger("ready")},links.TreeGrid.extend=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]instanceof Object?t[n]instanceof Object&&links.TreeGrid.extend(e[n],t[n]):e[n]=t[n])},links.TreeGrid.prototype.draw=function(e,t){t&&links.TreeGrid.extend(this.options,t);var n=new links.TreeGrid.Grid(e,this.options);this.frame.setGrid(n)},links.TreeGrid.prototype.redraw=function(){this.frame&&this.frame.onRangeChange()},links.TreeGrid.Node=function(){this.top=0,this.width=0,this.left=0,this.height=0,this.visible=!0,this.selected=!1},links.TreeGrid.Node.prototype.setParent=function(e){this.parent=e},links.TreeGrid.Node.prototype.getAbsTop=function(){return(this.parent?this.parent.getAbsTop():0)+this.top},links.TreeGrid.Node.prototype.getAbsLeft=function(){return(this.parent?this.parent.getAbsLeft():0)+this.left},links.TreeGrid.Node.prototype.getHeight=function(){return this.height},links.TreeGrid.Node.prototype.getWidth=function(){return this.width},links.TreeGrid.Node.prototype.getLeft=function(){return this.left},links.TreeGrid.Node.prototype.getTop=function(){return this.top},links.TreeGrid.Node.prototype.setLeft=function(e){this.left=e||0},links.TreeGrid.Node.prototype.setTop=function(e){this.top=e||0},links.TreeGrid.Node.prototype.getTreeGrid=function(){return this.parent?this.parent.getTreeGrid():undefined},links.TreeGrid.Node.prototype.getSelection=function(){return this.parent?this.parent.getSelection():[]},links.TreeGrid.Node.prototype.getContainer=function(){return this.parent?this.parent.getContainer():undefined},links.TreeGrid.Node.prototype.getVisibleWindow=function(){return this.parent?this.parent.getVisibleWindow():{top:0,left:0,width:0,height:0}},links.TreeGrid.Node.prototype.setVisible=function(e){this.visible=e==1},links.TreeGrid.Node.prototype.isVisible=function(){return this.visible&&(this.parent?this.parent.isVisible():!0)},links.TreeGrid.Node.prototype.updateHeight=function(e,t){},links.TreeGrid.Node.prototype.onUpdateHeight=function(e){this.parent&&this.parent.updateHeight(this,e)},links.TreeGrid.Node.prototype.repaint=function(){return!1},links.TreeGrid.Node.prototype.reflow=function(){},links.TreeGrid.Node.prototype.update=function(){},links.TreeGrid.Node.prototype.hide=function(){this.setVisible(!1),this.repaint(),this.reflow()},links.TreeGrid.Node.prototype.show=function(){this.setVisible(!0),this.repaint()},links.TreeGrid.Node.prototype.select=function(){this.selected=!0},links.TreeGrid.Node.prototype.unselect=function(){this.selected=!1},links.TreeGrid.Node.prototype.onResize=function(){this.parent&&this.parent.onResize&&this.parent.onResize()},links.TreeGrid.Frame=function(e,t){this.options=t,this.container=e,this.dom={},this.frameWidth=0,this.frameHeight=0,this.grid=undefined,this.eventParams={},this.selection=[],this.top=0,this.left=0,this.window={left:0,top:0,height:0,width:0},this.repaint()},links.TreeGrid.Frame.prototype=new links.TreeGrid.Node,links.TreeGrid.Frame.prototype.trigger=function(e,t){if(!this.treegrid)throw"Error: cannot trigger an event because treegrid is missing";this.treegrid.trigger(e,t)},links.TreeGrid.Frame.prototype.getContainer=function(){return this.dom.itemFrame},links.TreeGrid.Frame.prototype.getTreeGrid=function(){return this.treegrid},links.TreeGrid.Frame.prototype.setTreeGrid=function(e){this.treegrid=e},links.TreeGrid.Frame.prototype.setGrid=function(e){this.grid&&(this.grid.hide(),delete this.grid),this.grid=e,this.grid.setParent(this),this.gridHeight=this.grid.getHeight(),this.update(),this.repaint()},links.TreeGrid.Frame.prototype.getAbsTop=function(){return this.verticalScroll?-this.verticalScroll.get():0},links.TreeGrid.Frame.prototype.onResize=function(){this.repaint();var e=0,t=10;while(this.reflow()&&e<t)this.update(),this.repaint(),e++;if(e>=t)try{console.log("Warning: maximum number of loops exceeded")}catch(n){}},links.TreeGrid.Frame.prototype.onRangeChange=function(){this._updateVisibleWindow(),this.update(),this.repaint();var e=0,t=10,n=this.reflow();while(this.reflow())this.repaint();if(e>=t)try{console.log("Warning: maximum number of loops exceeded")}catch(r){}},links.TreeGrid.Frame.prototype.getVisibleWindow=function(){return this.window},links.TreeGrid.Frame.prototype.update=function(){this.grid&&this.grid.update()},links.TreeGrid.Frame.prototype._updateVisibleWindow=function(){var e=this.grid,t=this.frameHeight,n=this.frameWidth,r=e?e.getTop():0,i=e?e.getHeight():0,s=this.verticalScroll?this.verticalScroll.get():0;i>0&&t>0&&s>0?this.top=(r+i-t)/(i-t)*s:this.top=0,this.window={left:this.left,top:this.top,height:t,width:n}},links.TreeGrid.Frame.prototype.reflow=function(){var e=!1,t=this.dom,n=this.options,r=this.grid;if(r){var i=r.reflow();e=e||i}var s=t.mainFrame?t.mainFrame.clientHeight:0,o=t.mainFrame?t.mainFrame.clientWidth:0;return e=e||this.frameHeight!=s,e=e||this.frameWidth!=o,this.frameHeight=s,this.frameWidth=o,e&&(this.verticalScroll.setInterval(0,this.gridHeight-s),this._updateVisibleWindow()),this.verticalScroll.reflow(),e},links.TreeGrid.Frame.prototype.updateHeight=function(e,t){e==this.grid&&(this.gridHeight+=t)},links.TreeGrid.Frame.prototype.repaint=function(){this._repaintFrame(),this._repaintScrollbars(),this._repaintGrid()},links.TreeGrid.Frame.prototype._repaintFrame=function(){var e=this,t=this.dom,n=this.options,r=t.mainFrame;if(!r){r=document.createElement("DIV"),r.className="treegrid-frame",r.style.position="relative",r.style.overflow="hidden",r.style.left="0px",r.style.top="0px",this.container.appendChild(r),t.mainFrame=r,links.TreeGrid.addEventListener(r,"mousedown",function(t){e.onMouseDown(t)}),links.TreeGrid.addEventListener(r,"mousewheel",function(t){e.onMouseWheel(t)}),links.TreeGrid.addEventListener(r,"touchstart",function(t){e.onTouchStart(t)});var i=document.createElement("div");i.innerHTML="1 item",i.className="treegrid-drag-image",this.dom.dragImage=i,links.dnd.makeDraggable(r,{dragImage:i,dragImageOffsetX:10,dragImageOffsetY:-10,dragStart:function(t){return e.onDragStart(t)},dragEnd:function(t){return e.onDragEnd(t)}})}r.style.width=n.width||"100%",r.style.height=n.height||"100%";var s=t.itemFrame;s||(s=document.createElement("DIV"),s.style.position="absolute",s.style.left="0px",s.style.top="0px",s.style.width="100%",s.style.height="0px",t.mainFrame.appendChild(s),t.itemFrame=s)},links.TreeGrid.Frame.prototype._repaintGrid=function(){this.grid&&this.grid.repaint()},links.TreeGrid.Frame.prototype._repaintScrollbars=function(){var e=this.dom,t=e.scrollContainer;if(!t){t=document.createElement("div"),t.style.position="absolute",t.style.zIndex=9999,t.style.right="0px",t.style.top="0px",t.style.height="100%",t.style.width="16px",e.mainFrame.appendChild(t),e.scrollContainer=t;var n=this;verticalScroll=new links.TreeGrid.VerticalScroll(t),verticalScroll.addOnChangeHandler(function(e){n.onRangeChange()}),this.verticalScroll=verticalScroll}this.verticalScroll.redraw()},links.TreeGrid.isArray=function(e){return e instanceof Array?!0:Object.prototype.toString.call(e)==="[object Array]"},links.TreeGrid.Grid=function(e,t){this.setData(e),this.dom={},this.options={items:{defaultHeight:24,minHeight:24}},t&&links.TreeGrid.extend(this.options,t),this.columns=[],this.itemsHeight=0,this.items=[],this.itemCount=undefined,this.visibleItems=[],this.expandedItems=[],this.iconsWidth=0,this.headerHeight=0,this.header=new links.TreeGrid.Header({options:this.options}),this.header.setParent(this),this.loadingHeight=0,this.emptyHeight=0,this.errorHeight=0,this.height=this.options.items.defaultHeight,this.dropAreas=[],this.dropAreaHeight=this.options.dropAreaHeight,this.offset=0,this.limit=0},links.TreeGrid.Grid.prototype=new links.TreeGrid.Node,links.TreeGrid.Grid.prototype.update=function(){var e={offset:this.offset,limit:this.limit},t=this.getVisibleWindow(),n=this._getRangeFromWindow(t,e);this.offset=n.offset,this.limit=n.limit;var r=this,i=this.items,s=this.offset,o=this.limit,u=links.TreeGrid.mergeArray(this.visibleItems,this.expandedItems);for(var a=0,f=u.length;a<f;a++){var l=u[a];l&&l.update()}var c=function(e){r.error=undefined,r._updateItems(s,o)},h=function(e){r.error=e};this._getChanges(s,o,c,h)},links.TreeGrid.Grid.prototype.updateHeight=function(e,t){var n=-1;e instanceof links.TreeGrid.Header?(this.headerHeight+=t,n=-1):e instanceof links.TreeGrid.Item&&(this.itemsHeight+=t,n=this.items.indexOf(e));var r=this.items;for(var i=n+1,s=r.length;i<s;i++){var o=r[i];o&&(o.top+=t)}},links.TreeGrid.Grid.prototype.onDrop=function(e){var t=JSON.parse(e.dataTransfer.getData("text"));if(this.dataConnector){var n=this,r=function(){},i=r,s=[t.item];e.dataTransfer.dropEffect=="move"?this.dataConnector.appendItems(s,r,i):e.dataTransfer.dropEffect=="copy"&&this.dataConnector.appendItems(s,r,i)}else console.log("dropped but do nothing",e.dataTransfer.dropEffect);links.TreeGrid.preventDefault(e)},links.TreeGrid.mergeArray=function(e,t){var n=e.slice(0);for(var r=0,i=t.length;r<i;r++){var s=t[r];e.indexOf(s)==-1&&n.push(s)}return n},links.TreeGrid.Grid.prototype.reflow=function(){var e=!1,t=this.visibleItems;if(this.header){var n=this.header.reflow();e=e||n}var r=links.TreeGrid.mergeArray(this.visibleItems,this.expandedItems);for(var i=0,s=r.length;i<s;i++){var o=r[i];if(o){var u=o.reflow();e=e||u}}var a=this.dropAreas;for(var i=0,s=a.length;i<s;i++)a[i].reflow();var f=this.header.getFieldWidths(),l=this.columns,c=this.options.indentationWidth;for(var i=0,s=f.length;i<s;i++){var h=l[i];if(!h.fixedWidth){var p=f[i]+c;p>h.width&&(h.width=p,e=!0)}}for(var i=0,s=t.length;i<s;i++){var o=t[i],d=0,f=o.getFieldWidths();for(var v=0,m=l.length;v<m;v++){var h=l[v];if(!h.fixedWidth){var p=f[v]+c;p>h.width&&(h.width=p,e=!0)}}}if(this.isVisible()){var g=0;for(var i=0,s=t.length;i<s;i++){var o=t[i],p=o.getIconsWidth();g=Math.max(p,g)}this.iconsWidth!=g&&(e=!0),this.iconsWidth=g}var y=c+this.iconsWidth;for(var i=0,s=l.length;i<s;i++){var h=l[i];h.left=y,y+=h.width}var p=0;if(l&&l.length)var b=l[l.length-1],p=b.left+b.width;e=e||p!=this.width,this.width=p,this.loading?this.dom.loading&&(this.loadingHeight=this.dom.loading.clientHeight):this.loadingHeight=0,this.error?this.dom.error&&(this.errorHeight=this.dom.error.clientHeight):this.errorHeight=0,this.itemCount==0?this.dom.empty&&(this.emptyHeight=this.dom.empty.clientHeight):this.emptyHeight=0;var w=0;w+=this.headerHeight,w+=this.itemsHeight,w+=this.loadingHeight,w+=this.emptyHeight,w==0&&(w=this.options.items.defaultHeight);var E=w-this.height;return E&&(e=!0,this.height=w,this.onUpdateHeight(E)),e},links.TreeGrid.Grid.prototype.repaint=function(){var e=this,t=e.dom;this._repaintLoading(),this._repaintEmpty(),this._repaintError(),this._repaintHeader(),this._repaintItems(),window.count=window.count?window.count+1:1},links.TreeGrid.Grid.prototype._repaintLoading=function(){if(this.isVisible()&&this.itemCount==undefined&&!this.error){var e=this.dom.loadingIcon;e||(e=document.createElement("DIV"),e.className="treegrid-loading-icon",e.style.position="absolute",e.title="refreshing...",this.getContainer().appendChild(e),this.dom.loadingIcon=e),e.style.top=Math.max(this.getAbsTop(),0)+"px",e.style.left=this.getAbsLeft()+"px"}else this.dom.loadingIcon&&(this.dom.loadingIcon.parentNode.removeChild(this.dom.loadingIcon),this.dom.loadingIcon=undefined);if(this.isVisible()&&!this.error&&this.itemCount==undefined){var t=this.dom.loadingText;t||(t=document.createElement("div"),t.className="treegrid-loading",t.style.position="absolute",t.appendChild(document.createTextNode("loading...")),this.getContainer().appendChild(t),this.dom.loadingText=t),t.style.top=Math.max(this.getAbsTop(),0)+"px",t.style.left=this.getAbsLeft()+this.options.indentationWidth+"px"}else this.dom.loadingText&&(delete this.loadingHeight,this.dom.loadingText.parentNode.removeChild(this.dom.loadingText),this.dom.loadingText=undefined)},links.TreeGrid.Grid.prototype._repaintEmpty=function(){var e=this.dom;if(this.itemCount==0&&this.isVisible()){var t=e.empty;if(!t){t=document.createElement("div"),t.className="treegrid-loading",t.style.position="absolute",t.appendChild(document.createTextNode("(leeg)")),this.getContainer().appendChild(t),e.empty=t;var n=this.parent,r=n.dataConnector?n.dataConnector.getOptions().dataTransfer:undefined;r&&links.dnd.makeDroppable(t,{dropEffect:r.dropEffect,drop:function(e){n.onDrop(e)},dragEnter:function(e){n.onDragEnter(e)},dragOver:function(e){n.onDragOver(e)},dragLeave:function(e){n.onDragLeave(e)}})}t.style.top=Math.max(this.getAbsTop(),0)+"px",t.style.left=this.getAbsLeft()+this.options.indentationWidth+"px",t.style.width=this.parent.width-2*this.options.indentationWidth+"px"}else e.empty&&(links.dnd.removeDroppable(t),e.empty.parentNode.removeChild(e.empty),delete this.dom.empty)},links.TreeGrid.Grid.prototype._repaintError=function(){var e=this.dom;if(this.isVisible()&&this.error){var t=e.error;t||(t=document.createElement("div"),t.className="treegrid-error",t.style.position="absolute",t.appendChild(document.createTextNode("Error: "+links.TreeGrid.Grid._errorToString(this.error))),this.getContainer().appendChild(t),e.error=t),t.style.top=Math.max(this.getAbsTop(),0)+"px",t.style.left=this.getAbsLeft()+this.options.indentationWidth+"px"}else e.error&&(e.error.parentNode.removeChild(e.error),e.error=undefined);if(this.isVisible()&&this.error&&!this.loading){var n=this.dom.errorIcon;n||(n=document.createElement("DIV"),n.className="treegrid-error-icon",n.style.position="absolute",n.title=this.error,this.getContainer().appendChild(n),this.dom.errorIcon=n);var r=this.getAbsLeft();n.style.top=Math.max(this.getAbsTop(),0)+"px",n.style.left=r+"px",n.style.zIndex=r+1}else this.dom.errorIcon&&(this.dom.errorIcon.parentNode.removeChild(this.dom.errorIcon),this.dom.errorIcon=undefined)},links.TreeGrid.Grid.prototype.getColumnsFromFields=function(e){var t=[];if(e){var n=0;for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];r.charAt(0)!="_"&&!links.TreeGrid.isArray(i)&&!(i instanceof links.DataConnector)&&(t[n]={name:r},n++)}}return t},links.TreeGrid.Grid.prototype.setColumns=function(e){var t=this.options.indentationWidth,n=[],r=!1;for(var i=0,s=e.length;i<s;i++){var o=this.columns[i],u=e[i];o||(r=!0);if(!r)for(var a in u)if(o[a]!=u[a]){r=!0;break}if(!r)for(var a in o)if(a!="width"&&a!="left"&&o[a]!=u[a]){r=!0;break}var f={name:"",width:0,left:0};!r&&o&&(o.width!=undefined&&(f.width=o.width),o.left!=undefined&&(f.left=o.left)),f.fixedWidth=u.width!=undefined;for(a in u)f[a]=u[a];this.columns[i]=f,n[i]=f}this.columns.length!=e.length&&(r=!0);if(r){this.columns.splice(0,this.columns.length);for(var i=0;i<n.length;i++)this.columns.push(n[i])}},links.TreeGrid.Grid.prototype.setData=function(e){var t=e!=this.data;if(t){var n;if(links.TreeGrid.isArray(e))n=new links.DataTable(e);else{if(!(e instanceof links.DataConnector))throw"Error: no valid data. JSON Array or DataConnector expected.";n=e}if(this.dataConnector&&this.eventListener){this.dataConnector.removeEventListener(this.eventListener),this.eventListener=undefined,this.dataConnector=undefined;var r=this.items;for(var i=0,s=this.items.length;i<s;i++){var o=r[i];o&&(o.data=undefined)}}var u=this;this.eventListener=function(e,t){e=="change"&&u.update()},this.dataConnector=n,this.dataConnector.addEventListener(this.eventListener),this.dataConnector&&this.dataConnector.options.showHeader!=undefined?this.showHeader=this.dataConnector.options.showHeader:this.showHeader=!0}},links.TreeGrid.Grid.prototype._removeItem=function(e){var t=this.items,n=t.indexOf(e);if(n!=-1){e.expanded&&e.onExpand();var r=this.visibleItems.indexOf(e);r!=-1&&this.visibleItems.splice(r,1);var i=e.getHeight();this.updateHeight(e,-i),e.hide(),t.splice(n,1),this.itemCount--}},links.TreeGrid.Grid.prototype._updateHeader=function(e){this.header.setFields(e)},links.TreeGrid.Grid.prototype._getChanges=function(e,t,n,r){var i=this,s=[],o=[];for(var u=e,a=e+t;u<a;u++){var f=this.getItem(u);s.push(f.data),o.push(u)}var l=function(r){var o=r.items||[],u=s.length<t||o.length>0,a=r.totalItems!==i.itemCount;a&&i.setItemCount(r.totalItems);for(var f=e,l=e+t;f<l;f++){var c=i.getItem(f);c.updating=!1;if(!c.data||o.indexOf(c.data)!=-1)c.dirty=!0}(a||u)&&i.onResize(),n&&n(o)},c=function(n){for(var s=e,o=e+t;s<o;s++){var u=i.getItem(s);u.error=n,u.updating=!1,u.dirty=!0}i.onResize(),r&&r(n)};for(var u=0,a=o.length;u<a;u++){var h=o[u];this.items[h].updating=!0}this.dataConnector.getChanges(e,t,s,l,c)},links.TreeGrid.Grid.prototype._updateItems=function(e,t,n,r){var i=this,s=this.items,o=this.getItem(e);while(t>0&&(o.loading||!o.dirty&&o.data))e++,t--,o=this.getItem(e);o=this.getItem(e+t-1);while(t>0&&(o.loading||!o.dirty&&o.data))t--,o=this.getItem(e+t-1);for(var u=e,a=e+t;u<a;u++){var o=this.getItem(u);if(o.error||o.dirty||!o.data)o.loading=!0,o.dirty=!0}var f=function(r){var s=r.items;for(var o=e,u=e+t;o<u;o++){var a=i.getItem(o);a.loading=!1,a.dirty=!1}var f=[];for(var o=0,u=s.length;o<u;o++){var l=s[o],c=i.dataConnector.getOptions().columns||i.getColumnsFromFields(s[o]);c.length>f.length&&(f=c),i.setColumns(f),o==0&&i._updateHeader(i.columns);if(l){var h=e+o,a=i.getItem(h);a.data=l,a.setFields(l,i.columns),a.error=undefined}}i.onResize(),n&&n()},l=function(n){for(var s=e,o=e+t;s<o;s++){var u=i.getItem(s);u.loading=!1,u.dirty=!0,u.error=n}i.onResize(),r&&r(n)};t>0||this.totalItems===undefined?(this.repaint(),this.dataConnector.getItems(e,t,f,l)):n&&n()},links.TreeGrid.Grid.prototype._repaintHeader=function(){var e=this.showHeader&&this.itemCount!=undefined&&this.itemCount>0;this.header.setVisible(e),this.header.repaint()},links.TreeGrid.Grid.prototype._repaintItems=function(){var e=this.columns,t=this.window&&this.window.top?this.window.top:0,n=this.visibleItems,r=this.isVisible(),n=this.visibleItems,i=0;while(i<n.length){var s=n[i];if(s.index<this.offset||s.index>=this.offset+this.limit||!r){s.hide();var o=n.indexOf(s);o!=-1&&(n.splice(o,1),i--)}i++}var u=this.itemCount||0,a=this.offset,f=Math.min(this.offset+this.limit,u);if(this.isVisible())for(var i=a;i<f;i++){var s=this.getItem(i);s.setVisible(!0),n.indexOf(s)==-1&&n.push(s)}for(var i=0;i<n.length;i++){var s=n[i];s.repaint()}},links.TreeGrid.Grid.prototype._repaintDropAreas=function(){var e="none";this.dataConnector&&this.dataConnector.options&&this.dataConnector.options.dataTransfer&&this.dataConnector.options.dataTransfer.dropEffect&&(e=this.dataConnector.options.dataTransfer.dropEffect);if(e!="none"&&this.isVisible()){var t=this.itemCount||0,n=this.offset,r=Math.min(this.offset+this.limit,t),i=this.dropAreas,s=this.dropAreaHeight,o=this.getContainer(),u=this.limit-i.length,a=-u;for(var f=0;f<u;f++){var l=new links.TreeGrid.DropArea({dataConnector:this.dataConnector,item:this.getItem(this.offset+f),height:s});l.setParent(this),i.push(l)}for(var f=0;f<a;f++){var l=i.shift();l.hide()}for(var f=n;f<r;f++){var c=this.getItem(f),l=i[f-this.offset];l.setTop(c.top-s),l.item=c,l.repaint()}}else{var i=this.dropAreas;while(i.length>0){var l=i.shift();l.hide()}}},links.TreeGrid.Header=function(e){e&&(this.height=e.height||0,this.options=e.options),this.fieldsHeight=0,this.dom={},this.columns=undefined},links.TreeGrid.Header.prototype=new links.TreeGrid.Node,links.TreeGrid.Header.prototype.clearFields=function(){this.columns=undefined,this.fieldsHeight=0},links.TreeGrid.Header.prototype.repaint=function(){if(this.isVisible()&&this.columns){var e=this.columns,t=this.prevColumns;e!=t&&(this.hide(),this.prevColumns=e);var n=this.dom.header;if(!n){n=document.createElement("DIV"),n.treeGridType="header",n.className="treegrid-header",n.style.position="absolute",n.style.zIndex=1+this.getAbsLeft(),this.getContainer().appendChild(n),this.dom.header=n,this.dom.fields=[];if(this.columns){var e=this.columns,r=this.options.padding;for(var i=0,s=e.length;i<s;i++)if(!this.dom.fields[i]){var o=this.columns[i],u=document.createElement("DIV");u.className="treegrid-header-field",u.style.position="absolute",u.style.top="0px",u.innerHTML=o.text||o.name||"",u.title=o.title||"",n.appendChild(u),this.dom.fields[i]=u}}}var a=Math.max(this.getAbsTop(),0);n.style.top=a+"px",n.style.left=this.getAbsLeft()+"px",n.style.height=this.height+"px",n.style.width=this.width+"px";var f=this.dom.fields,e=this.columns;for(var i=0,s=f.length;i<s;i++)f[i].style.left=e[i].left+"px"}else this.dom.header&&(this.dom.header.parentNode.removeChild(this.dom.header),this.dom.header=undefined,this.dom.fields=undefined)},links.TreeGrid.Header.prototype.reflow=function(){var e=!1,t=this.dom?this.dom.fields:undefined,n=t?t.length:0,r=this.options.items.minHeight;if(t){for(var i=0;i<n;i++)t[i]&&(r=Math.max(r,t[i].clientHeight));this.fieldsHeight=r}else this.columns||(this.fieldsHeight=0);this.width=this.getVisibleWindow().width-this.getAbsLeft();var s=0;s+=this.fieldsHeight;var o=s-this.height;return o&&(e=!0,this.height=s,this.onUpdateHeight(o)),e},links.TreeGrid.Header.prototype.setFields=function(e){e&&(this.columns=e)},links.TreeGrid.Header.prototype.getFieldWidths=function(){var e=[];if(this.dom.fields){var t=this.dom.fields;for(var n=0,r=t.length;n<r;n++)e[n]=t[n].clientWidth}return e},links.TreeGrid.Grid.prototype.setItemCount=function(e){var t=this.options.items.defaultHeight,n=e-(this.itemCount||0);if(n>0){var r=(t+this.dropAreaHeight)*n;this.itemsHeight+=r}if(n<0){var i=this.itemCount,s=this.items;for(var o=e;o<i;o++){var u=s[o];u&&(u.hide(),delete s[o]);var a=u?u.getHeight():t;this.itemsHeight-=a+this.dropAreaHeight}e==0&&this.header.clearFields()}this.itemCount=e||0},links.TreeGrid.Grid.prototype.registerExpandedItem=function(e){var t=this.expandedItems.indexOf(e);t==-1&&this.expandedItems.push(e)},links.TreeGrid.Grid.prototype.unregisterExpandedItem=function(e){var t=this.expandedItems.indexOf(e);t!=-1&&this.expandedItems.splice(t,1)},links.TreeGrid.Grid.prototype.getItemCount=function(){return this.itemCount},links.TreeGrid.Grid.prototype.getItem=function(e){var t=this.items[e];return t||(t=new links.TreeGrid.Item({options:this.options,index:e,top:this._calculateItemTop(e),height:this.options.items.defaultHeight}),t.setParent(this),this.items[e]=t),t},links.TreeGrid.Grid.prototype._calculateItemTop=function(e){var t=this.items,n=this.options.items.defaultHeight,r=0,i=undefined;for(var s=e-1;s>=0;s--){i=t[s];if(i&&i.top){r+=i.top+i.height;break}r+=n}var o=i!=undefined?r+this.dropAreaHeight:this.headerHeight+n*e+this.dropAreaHeight*(e+1);return o},links.TreeGrid.Item=function(e){e&&(this.options=e.options,this.index=e.index||0,this.top=e.top||0),this.height=this.options.items.defaultHeight,this.data=undefined,this.fields=undefined,this.fieldsHeight=0,this.grid=undefined,this.gridHeight=0,this.dirty=!1,this.loading=!1,this.loadingHeight=0,this.error=undefined,this.errorheight=0,this.dataTransfer={},this.dom={}},links.TreeGrid.Item.prototype=new links.TreeGrid.Node,links.TreeGrid.eval=function(fn,obj){var t=typeof fn;if(t=="function")return fn.call(obj);if(t=="string"){var evalHistory=links.TreeGrid.evalHistory;evalHistory||(evalHistory={},links.TreeGrid.evalHistory=evalHistory);var f=evalHistory[fn];return f||(f=eval("f=("+fn+");"),evalHistory[fn]=f),f.call(obj)}throw new Error("Function must be of type function or string")},links.TreeGrid.Item.prototype.setFields=function(e,t){if(e&&t){var n=[];for(var r=0,i=t.length;r<i;r++){var s=t[r];s.format?n[r]=links.TreeGrid.eval(s.format,e)||"":n[r]=e[s.name]||""}this.fields=n,this.columns=t,this.icons=e._icons,this.actions=e._actions;var o=[];for(var u in e){if(e.hasOwnProperty(u)&&u.charAt(0)!="_"){var a=e[u];links.TreeGrid.isArray(a)?o.push({name:u,data:new links.DataTable(a)}):a instanceof links.DataConnector&&o.push({name:u,data:a})}if(u=="_childs")try{console.log("WARNING: special field _childs encountered. This field is no longer in use for subgrids, and is now a regular hidden field. Use a fieldname without underscore instead for subgrids.")}catch(f){}}var l=undefined;if(o.length==1)l=o[0].data;else if(o.length>1){var c={showHeader:!1};l=new links.DataTable(o,c)}l?(this.dataConnector=l,this.grid&&(this.grid.setData(this.dataConnector),this.grid.update())):(this.dataConnector&&delete this.dataConnector,this.grid&&(this.grid.hide(),this.gridHeight=0,delete this.grid),this.expanded&&(this.expanded=!1,this.parent.unregisterExpandedItem(this)))}},links.TreeGrid.Item.prototype.getFieldWidths=function(){var e=[];if(this.dom.fields){var t=this.dom.fields;for(var n=0,r=this.columns.length;n<r;n++)e[n]=t[n]?t[n].clientWidth:0}return e},links.TreeGrid.Item.prototype.getIconsWidth=function(){return this.dom.icons?this.dom.icons.clientWidth:0},links.TreeGrid.Item.prototype.updateHeight=function(e,t){e==this.grid&&(this.gridHeight+=t)},links.TreeGrid.Item.prototype.onEvent=function(e){var t={items:[this.data]};links.events.trigger(this.getTreeGrid(),e,t);var n=this.parent.dataConnector;n&&n._onEvent(e,t)},links.TreeGrid.Item.prototype.onExpand=function(){this.expanded?(this.dom.buttonExpand.className="treegrid-fold",this.expanded=!1,this.parent.unregisterExpandedItem(this),this.grid&&(this.grid.setVisible(!1),this.gridHeight-=this.grid.getHeight()+this.options.padding),this.onEvent("collapse")):(this.dom.buttonExpand.className="treegrid-unfold",this.expanded=!0,this.parent.registerExpandedItem(this),this.dataConnector&&(this.grid||(this.grid=new links.TreeGrid.Grid(this.dataConnector,this.options),this.grid.setParent(this),this.grid.setLeft(this.left+this.options.indentationWidth),this.grid.setTop(this.height)),this.grid.setVisible(!0),this.gridHeight+=this.grid.getHeight()+this.options.padding),this.onEvent("expand")),this.onResize()},links.TreeGrid.Item.prototype.onDragOver=function(e){if(this.dataTransfer.dragging)return;var t=this.fieldsHeight/2,n=(e.offsetY||e.layerY)<t||!this.dataConnector;return n=!1,this.dataTransfer.dragover=!n,this.dataTransfer.dragbefore=n,this.repaint(),links.TreeGrid.preventDefault(e),!1},links.TreeGrid.Item.prototype.onDragEnter=function(e){if(this.dataTransfer.dragging)return;return!1},links.TreeGrid.Item.prototype.onDragLeave=function(e){if(this.dataTransfer.dragging)return;return this.dataTransfer.dragover=!1,this.dataTransfer.dragbefore=!1,this.repaint(),!1},links.TreeGrid.Item.prototype.onDrop=function(e){var t=e.dataTransfer.getData("items");this.dataTransfer.dragover=!1,this.dataTransfer.dragbefore=!1,this.repaint();if(this.dataConnector){var n=this,r=function(){n.expanded?n.onResize():n.onExpand()},i=r,s=0;while(s<t.length){var o=this;while(o&&o!=t[s])o=o.parent;o==t[s]?t.splice(s,1):s++}var u=[];for(var s=0;s<t.length;s++)u.push(t[s].data);this.dataConnector.appendItems(u,r,i)}else if(this.parent&&this.parent.dataConnector&&e.dataTransfer.dropEffect=="link"){var a=this.data,r=function(e){},i=function(e){console.log(e)},f=[];for(var s=0;s<t.length;s++)f.push(t[s].data);this.parent.dataConnector.linkItems(f,a,r,i)}else console.log("dropped but do nothing",e.dataTransfer.dropEffect);links.TreeGrid.preventDefault(e)},links.TreeGrid.Item.prototype.repaint=function(){this._repaintError(),this._repaintLoading(),this._repaintFields(),this._repaintGrid()},links.TreeGrid.Item.prototype.update=function(){this.grid&&this.expanded&&this.grid.update()},links.TreeGrid.Item.prototype.reflow=function(){var e=!1;if(this.grid&&this.expanded){var t=this.grid.reflow();e=e||t}this.width=this.getVisibleWindow().width-this.getAbsLeft();if(this.isVisible()){var n=this.options.items.minHeight,r=this.dom.fields,i=this.dom.actions,s=this.dom.icons,o=this.dom.expandButton,u=r?r.length:0;if(s){var a=s.clientWidth;a!=this.iconsWidth&&(e=!0),this.iconsWidth=a}if(r||i||s||o||i){for(var f=0;f<u;f++)r[f]&&(n=Math.max(n,r[f].clientHeight));i&&(n=Math.max(n,i.clientHeight)),s&&(n=Math.max(n,s.clientHeight)),o&&(n=Math.max(n,o.clientHeight)),this.fieldsHeight=n}}this.loading?this.dom.loading&&(this.loadingHeight=this.dom.loading.clientHeight):this.loadingHeight=0,this.error?this.dom.error&&(this.errorHeight=this.dom.error.clientHeight):this.errorHeight=0;var l=0;l+=this.fieldsHeight,l+=this.loadingHeight,l+=this.errorHeight,l+=this.gridHeight,l==0&&(l=this.options.items.defaultHeight);var c=l-this.height;return c&&(e=!0,this.height=l,this.onUpdateHeight(c)),e},links.TreeGrid.Grid.prototype._getRangeFromWindow=function(e,t){var n=this.options.items.defaultHeight,r=this.itemCount!=undefined?this.itemCount:Math.ceil(e.height/n),i=-this.getAbsTop()+this.header.getHeight(),s=i+e.height-this.header.getHeight(),o=t?t.offset:0,u=0,a,f,l,c;a=this.items[o],f=a?a.top:this._calculateItemTop(o),l=a?a.getHeight():n,c=f+l;while(o<r-1&&c<i)o++,a=this.items[o],f=c+this.dropAreaHeight,l=a?a.getHeight():n,c=f+l;while(o>0&&f>i)o--,a=this.items[o],l=a?a.getHeight():n,c=f,f=f-l-this.dropAreaHeight;while(o+u<r-1&&f<s)u++,a=this.items[o+u],f=c+this.dropAreaHeight,l=a?a.getHeight():n,c=f+l;return f<s&&c>i&&o+u<r&&u++,{offset:o,limit:u}},links.TreeGrid.Item.prototype._repaintFields=function(){var e;if(this.isVisible()&&this.fields){var t=this.fields,n=this.prevFields;t!=n&&(this.dom.frame&&(this.dom.frame.parentNode.removeChild(this.dom.frame),delete this.dom.frame),this.prevFields=t);var r=this.dom.frame;if(!r){var r=document.createElement("DIV");r.className="treegrid-item",r.style.position="absolute",r.item=this,r.treeGridType="item",this.dom.frame=r;if(this.dataConnector){var i=document.createElement("button");i.treeGridType="expand",i.className=this.expanded?"treegrid-unfold":"treegrid-fold",i.style.position="absolute",i.grid=this,i.node=this,i.index=this.index,r.appendChild(i),this.dom.buttonExpand=i}var s=this.icons;if(s){var o=document.createElement("DIV");o.className="treegrid-icons",o.style.position="absolute",o.style.top="0px";for(var u=0,a=s.length;u<a;u++){var f=s[u];if(f&&f.image){var l=document.createElement("img");l.className="treegrid-icon",l.src=f.image,l.title=f.title?f.title:"",l.style.width=f.width?f.width:"",l.style.height=f.height?f.height:"",o.appendChild(l)}}r.appendChild(o),this.dom.icons=o}var c=[];this.dom.fields=c;var h=this.options.padding,t=this.fields,p=this.height;for(var u=0,a=t.length;u<a;u++){var e=t[u],d=document.createElement("DIV");d.className="treegrid-item-field",d.style.position="absolute",d.style.top="0px";var v=this.columns[u];typeof v!="undefined"&&v.fixedWidth&&(d.style.width=v.width+"px"),d.innerHTML=e,r.appendChild(d),c.push(d)}if(this.actions){var m=this.actions,g=document.createElement("DIV");this.dom.actions=g,g.style.position="absolute",g.className="treegrid-actions",g.style.top="0px",g.style.right="24px";for(var u=0,a=m.length;u<a;u++){var y=m[u];if(y.event)if(y.image){var b=document.createElement("INPUT");b.treeGridType="action",b.type="image",b.className="treegrid-action-image",b.title=y.title||"",b.src=y.image,b.event=y.event,b.item=this,g.appendChild(b)}else{var b=document.createElement("A");b.treeGridType="action",b.className="treegrid-action-link",b.href="#",b.title=y.title||"",b.innerHTML=y.text?y.text:y.event,b.event=y.event,b.item=this,g.appendChild(b)}}r.appendChild(g)}var w=this,E=this.dataConnector?this.dataConnector.getOptions().dataTransfer:undefined;if(E)E.dropEffect!=undefined&&E.dropEffect!="none"&&(this.dataTransfer.dropEffect=E.dropEffect,links.dnd.makeDroppable(r,{dropEffect:E.dropEffect,drop:function(e){w.onDrop(e)},dragEnter:function(e){w.onDragEnter(e)},dragOver:function(e){w.onDragOver(e)},dragLeave:function(e){w.onDragLeave(e)}}));else if(this.parent&&this.parent.dataConnector){var E=this.parent.dataConnector.getOptions().dataTransfer;E&&E.dropEffect=="link"&&(this.dataTransfer.dropEffect=E.dropEffect,links.dnd.makeDroppable(r,{dropEffect:E.dropEffect,drop:function(e){w.onDrop(e)},dragEnter:function(e){w.onDragEnter(e)},dragOver:function(e){w.onDragOver(e)},dragLeave:function(e){w.onDragLeave(e)}}))}}r.parentNode||this.getContainer().appendChild(r),r.style.top=this.getAbsTop()+"px",r.style.left=this.getAbsLeft()+"px",r.style.height=this.fieldsHeight+"px",r.style.width=this.width-2+"px";var o=this.dom.icons;o&&(o.style.left=this.options.indentationWidth+"px");var c=this.dom.fields;if(c)for(var u=0,a=this.columns.length;u<a;u++){var v=this.columns[u],d=c[u];d&&(d.style.left=v.left+"px")}this.dom.buttonExpand&&(this.dom.buttonExpand.style.visibility=this.error==undefined?"visible":"hidden");var S="treegrid-item";this.selected||this.dataTransfer.dragging?S+=" treegrid-item-selected":this.dataTransfer.dragover?S+=" treegrid-item-dragover":this.dataTransfer.dragbefore&&(S+=" treegrid-item-dragbefore"),this.dirty&&(S+=" treegrid-item-dirty"),r.className=S}else links.dnd.removeDraggable(this.dom.frame),links.dnd.removeDroppable(this.dom.frame),this.dom.frame&&this.dom.frame.parentNode&&this.dom.frame.parentNode.removeChild(this.dom.frame),this.dom.frame&&(this.dom={})},links.TreeGrid.Item.prototype._repaintGrid=function(){this.grid&&this.grid.repaint()},links.TreeGrid.Item.prototype._repaintLoading=function(){if(this.isVisible()&&this.loading&&(!this.fields||this.error||this.dirty)){var e=this.dom.loadingIcon;e||(e=document.createElement("DIV"),e.className="treegrid-loading-icon",e.style.position="absolute",e.title="loading...",this.getContainer().appendChild(e),this.dom.loadingIcon=e),e.style.top=this.getAbsTop()+"px",e.style.left=this.getAbsLeft()+"px"}else this.dom.loadingIcon&&(this.dom.loadingIcon.parentNode.removeChild(this.dom.loadingIcon),delete this.dom.loadingIcon);if(this.isVisible()&&this.loading&&!this.fields&&!this.error){var t=this.dom.loadingText;t||(t=document.createElement("DIV"),t.style.position="absolute",t.appendChild(document.createTextNode("loading...")),t.className="treegrid-loading",this.getContainer().appendChild(t),this.dom.loadingText=t),t.style.top=this.getAbsTop()+"px",t.style.left=this.getAbsLeft()+this.options.indentationWidth+"px",t.style.height=this.height+"px"}else this.dom.loadingText&&(this.dom.loadingText.parentNode.removeChild(this.dom.loadingText),delete this.dom.loadingText)},links.TreeGrid.Item.prototype._repaintError=function(){if(this.isVisible()&&this.error&&!this.fields){var e=this.dom.error;e||(e=document.createElement("DIV"),e.style.position="absolute",e.appendChild(document.createTextNode("Error: "+links.TreeGrid.Grid._errorToString(this.error))),e.className="treegrid-error",this.getContainer().appendChild(e),this.dom.error=e),e.style.top=this.getAbsTop()+"px",e.style.left=this.getAbsLeft()+this.options.indentationWidth+"px"}else this.dom.error&&(this.dom.error.parentNode.removeChild(this.dom.error),delete this.dom.error);if(this.isVisible()&&this.error&&!this.loading){var t=this.dom.errorIcon;t||(t=document.createElement("DIV"),t.className="treegrid-error-icon",t.style.position="absolute",t.title=this.error,this.getContainer().appendChild(t),this.dom.errorIcon=t);var n=this.getAbsLeft();t.style.top=Math.max(this.getAbsTop(),0)+"px",t.style.left=n+"px"}else this.dom.errorIcon&&(this.dom.errorIcon.parentNode.removeChild(this.dom.errorIcon),this.dom.errorIcon=undefined)},links.TreeGrid.DropArea=function(e){e&&(this.dataConnector=e.dataConnector||undefined,this.item=e.item||undefined,this.top=e.top||0,this.height=e.height||6),this.dragover=!1,this.dom={}},links.TreeGrid.DropArea.prototype=new links.TreeGrid.Node,links.TreeGrid.DropArea.prototype.reflow=function(){this.width=this.getVisibleWindow().width-this.getAbsLeft()},links.TreeGrid.DropArea.prototype.repaint=function(){if(this.isVisible()){var e=this.dom.dropArea;if(!e){var t=this.getContainer();e=document.createElement("DIV"),e.style.position="absolute",e.style.left="0px",e.style.top="0px",e.style.height=this.height+"px",t.appendChild(e),this.dom.dropArea=e;var n=this.dataConnector?this.dataConnector.getOptions().dataTransfer:undefined;if(n){var r=this;this.dropEffect=n.dropEffect,links.TreeGrid.addEventListener(e,"dragover",function(e){return r.onDragOver(e)}),links.TreeGrid.addEventListener(e,"dragenter",function(e){return r.onDragEnter(e)}),links.TreeGrid.addEventListener(e,"dragleave",function(e){return r.onDragLeave(e)}),links.TreeGrid.addEventListener(e,"drop",function(e){return r.onDrop(e)})}}e.className=this.dragover?"treegrid-droparea":"",e.style.top=this.getAbsTop()+"px",e.style.left=this.getAbsLeft()+"px",e.style.width=this.width-2+"px"}else this.dom.dropArea&&(this.dom.dropArea.parentNode.removeChild(this.dom.dropArea),delete this.dom.dropArea)},links.TreeGrid.DropArea.prototype.onDragOver=function(e){return this.dragover=!0,e.dataTransfer.allowedEffect="none",e.dataTransfer.dropEffect=this.dropEffect||"none",this.repaint(),links.TreeGrid.preventDefault(e),!1},links.TreeGrid.DropArea.prototype.onDragEnter=function(e){return this.dragover=!0,this.repaint(),e.dataTransfer.allowedEffect="none",e.dataTransfer.dropEffect=this.dataConnector?"move":"none",!1},links.TreeGrid.DropArea.prototype.onDragLeave=function(e){return this.dragover=!1,this.repaint(),!1},links.TreeGrid.DropArea.prototype.onDrop=function(e){var t=JSON.parse(e.dataTransfer.getData("text"));this.dragover=!1,this.repaint();if(this.dataConnector){var n=this,r=function(){n.parent.onResize()},i=r,s=[t.item],o=this.item.data;this.dataConnector.insertItemsBefore(s,o,r,i)}else console.log("dropped but do nothing",e.dataTransfer.dropEffect);links.TreeGrid.preventDefault(e)},links.TreeGrid.Grid._errorToString=function(e){if(typeof e=="string")return e;if(e instanceof Object){if(e.message&&typeof e.message=="string")return e.message;if(e.error&&typeof e.error=="string")return e.error;if(JSON)return JSON.stringify(e)}return String(e)},links.TreeGrid.VerticalScroll=function(e,t,n,r){this.container=e,this.dom={},this.height=0,this.min=0,this.max=0,this.value=0,this.eventParams={},this.onChangeHandlers=[],this.setInterval(t,n),this.set(r)},links.TreeGrid.VerticalScroll.prototype.redraw=function(){var e=this.dom.background;e||(e=document.createElement("div"),e.className="treegrid-verticalscroll-background",e.style.width="100%",e.style.height="100%",this.container.appendChild(e),this.dom.background=e);var t=this.dom.bar;if(!t){t=document.createElement("div"),t.className="treegrid-verticalscroll-bar",t.style.position="absolute",t.style.left="20%",t.style.width="60%",t.style.right="20%",t.style.top="0px",t.style.height="0px",this.container.appendChild(t);var n=this,r=this.eventParams;r._onMouseDown=function(e){n._onMouseDown(e)},links.TreeGrid.addEventListener(t,"mousedown",r._onMouseDown),this.dom.bar=t}var i=this.max-this.min;if(i>0){var s=this.height,o=2,u=Math.max(s*s/(i+s),20),a=this.value*(s-u-2*o)/i;t.style.height=u+"px",t.style.top=a+"px",t.style.display=""}else t.style.display="none"},links.TreeGrid.VerticalScroll.prototype.checkResize=function(){var e=this.reflow();return e&&this.redraw(),e},links.TreeGrid.VerticalScroll.prototype.reflow=function(){var e=!1;return this.height=this.dom.background.clientHeight,e},links.TreeGrid.VerticalScroll.prototype.setInterval=function(e,t){this.min=e||0,this.max=t||0,this.max<this.min&&(this.max=this.min),this.set(this.value)},links.TreeGrid.VerticalScroll.prototype.set=function(e){this.value=e||this.min,this.value<this.min&&(this.value=this.min),this.value>this.max&&(this.value=this.max),this.redraw()},links.TreeGrid.VerticalScroll.prototype.increase=function(e){var t=this.get();t+=e,this.set(t)},links.TreeGrid.VerticalScroll.prototype.get=function(){return this.value},links.TreeGrid.VerticalScroll.prototype._onMouseDown=function(e){var t=this.eventParams;e=e||window.event,t.startMouseX=e.clientX,t.startMouseY=e.clientY,t.startValue=this.value;var n=this;t._onMouseMove||(t._onMouseMove=function(e){n._onMouseMove(e)},links.TreeGrid.addEventListener(document,"mousemove",t._onMouseMove)),t._onMouseUp||(t._onMouseUp=function(e){n._onMouseUp(e)},links.TreeGrid.addEventListener(document,"mouseup",t._onMouseUp)),links.TreeGrid.preventDefault(e),links.TreeGrid.stopPropagation(e)},links.TreeGrid.VerticalScroll.prototype._onMouseMove=function(e){var t=this.eventParams;e=e||window.event;var n=e.clientX,r=e.clientY,i=n-t.startMouseX,s=r-t.startMouseY,o=this.max-this.min,u=s/this.height*(o+this.height);this.set(t.startValue+u),this._callbackOnChangeHandlers(),links.TreeGrid.preventDefault(e),links.TreeGrid.stopPropagation(e)},links.TreeGrid.VerticalScroll.prototype._onMouseUp=function(e){var t=this.eventParams,n=this;t._onMouseMove&&(links.TreeGrid.removeEventListener(document,"mousemove",t._onMouseMove),t._onMouseMove=undefined),t.onMouseUp||(links.TreeGrid.removeEventListener(document,"mouseup",t._onMouseUp),t._onMouseUp=undefined),links.TreeGrid.preventDefault(e),links.TreeGrid.stopPropagation(e)},links.TreeGrid.VerticalScroll.prototype.addOnChangeHandler=function(e){this.removeOnChangeHandler(e),this.onChangeHandlers.push(e)},links.TreeGrid.VerticalScroll.prototype.removeOnChangeHandler=function(e){var t=this.onChangeHandlers.indexOf(e);this.onChangeHandlers.splice(t,1)},links.TreeGrid.VerticalScroll.prototype._callbackOnChangeHandlers=function(){var e=this.onChangeHandlers,t=this.value;for(var n=0,r=e.length;n<r;n++)e[n](t)},links.DataConnector=function(e){this.options=e||{},this.eventListeners=[]},links.DataConnector.prototype.trigger=function(e,t){links.events.trigger(this,e,t),google&&google.visualization&&google.visualization.events&&google.visualization.events.trigger(this,e,t);var n=this.eventListeners;for(var r=0,i=n.length;r<i;r++){var s=n[r];s(e,t)}},links.DataConnector.prototype.getChanges=function(e,t,n,r,i){throw"Error: method getChanges is not implemented"},links.DataConnector.prototype.getItems=function(e,t,n,r){r("Error: method getItems is not implemented")},links.DataConnector.prototype.updateItems=function(e,t,n){n("Error: method updateItems is not implemented")},links.DataConnector.prototype.appendItems=function(e,t,n){n("Error: method appendItems is not implemented")},links.DataConnector.prototype.insertItemsBefore=function(e,t,n,r){r("Error: method insertItemsBefore is not implemented")},links.DataConnector.prototype.moveItems=function(e,t,n,r){r("Error: method moveItems is not implemented")},links.DataConnector.prototype.removeItems=function(e,t,n){n("Error: method removeItems is not implemented")},links.DataConnector.prototype.linkItems=function(e,t,n,r){r("Error: method linkItems is not implemented")},links.DataConnector.prototype._onEvent=function(e,t){this.trigger(e,t),this.onEvent(e,t)},links.DataConnector.prototype.onEvent=function(e,t){},links.DataConnector.prototype.setFilters=function(e){errback("Error: method setFilters is not implemented")},links.DataConnector.prototype.addEventListener=function(e){var t=this.eventListeners.indexOf(e);t==-1&&this.eventListeners.push(e)},links.DataConnector.prototype.removeEventListener=function(e){var t=this.eventListeners.indexOf(e);t!=-1&&this.eventListeners.splice(t,1)},links.DataConnector.prototype.setOptions=function(e){this.options=e||{}},links.DataConnector.prototype.getOptions=function(){return this.options},links.DataTable=function(e,t){this.data=e||[],this.setOptions(t),this.filteredData=this.data},links.DataTable.prototype=new links.DataConnector,links.DataTable.prototype.getItems=function(e,t,n,r){var i=[],s=this.filteredData,o=s.length;for(var u=e,a=Math.min(e+t,o);u<a;u++)i.push(s[u]);n({totalItems:s.length,items:i})},links.DataTable.prototype.updateItems=function(e,t,n){var r=e.length,i=this.data;for(var s=0;s<r;s++){var o=e[s],u=i.indexOf(o);if(u==-1){n("Cannot find item");return}i[u]=o}this.updateFilters(),t({totalItems:this.filteredData.length,items:e}),this.trigger("change",undefined)},links.DataTable.prototype.appendItems=function(e,t,n){var r=e.length;for(var i=0;i<r;i++)this.data.push(e[i]);this.updateFilters(),t({totalItems:this.filteredData.length,items:e}),this.trigger("change",undefined)},links.DataTable.prototype.insertItemsBefore=function(e,t,n,r){var i=this.data,s=i.indexOf(t);if(s==-1){r("Cannot find item");return}var o=e.length;for(var u=0;u<o;u++)i.splice(s+u,0,e[u]);this.updateFilters(),n({totalItems:this.filteredData.length,items:e}),this.trigger("change",undefined)},links.DataTable.prototype.moveItems=function(e,t,n,r){var i=this.data.indexOf(t);if(i==-1){r("Cannot find item");return}var s=e.length,o=[];for(var u=0;u<s;u++){var a=this.data.indexOf(e[u]);if(a==-1){r("Cannot find item");return}o[u]=a}for(var u=0;u<s;u++)this.data.splice(o[u],1),this.data.splice(i,0,e[u]);this.updateFilters(),n({totalItems:this.filteredData.length,items:e}),this.trigger("change",undefined)},links.DataTable.prototype.removeItems=function(e,t,n){var r=e.length;for(var i=0;i<r;i++){var s=this.data.indexOf(e[i]);if(s==-1){n("Cannot find item");return}this.data.splice(s,1)}this.updateFilters(),t({totalItems:this.filteredData.length,items:e}),this.trigger("change",undefined)},links.DataTable.prototype.getChanges=function(e,t,n,r,i){var s=[],o=this.filteredData,u=o.length;for(var a=0;a<t;a++){var f=n[a];f!=o[e+a]&&s.push(f)}r({totalItems:this.filteredData.length,items:s})},links.DataTable.prototype.update=function(){this.updateFilters(),this.trigger("change",undefined)},links.DataTable.prototype.onEvent=function(e,t){},links.DataTable.prototype.updateFilters=function(){this.filters?this.setFilters(this.filters):this.filteredData=this.data},links.DataTable.prototype.setFilters=function(e){var t=this.data,n=[];this.filteredData=n,this.filters=e;for(var r=0,i=t.length;r<i;r++){var s=t[r],o=!0;for(var u=0,a=e.length;u<a;u++){var f=e[u];if(f.field){var l=s[f.field];f.value&&l!=f.value&&(o=!1),f.startValue&&l<f.startValue&&(o=!1),f.endValue&&l>f.endValue&&(o=!1),f.values&&f.values.indexOf(l)==-1&&(o=!1)}}o&&n.push(s)}var c=[];for(var u=0,a=e.length;u<a;u++){var f=e[u];if(f.field&&f.order){var h=f.order.toUpperCase();if(h!="ASC"&&h!="DESC")throw'Unknown order "'+h+'". '+'Available values: "ASC", "DESC".';c.push({field:f.field,direction:h=="ASC"?1:-1})}}var p=c.length;p&&n.sort(function(e,t){for(var n=0;n<p;n++){var r=c[n],i=r.field,s=r.direction;if(e[i]!=t[i])return e[i]>t[i]?s:-s;if(n==p-1)return 0}})},links.CouchConnector=function(e){this.url=e,this.data=[],this.filter=undefined,this.updateSeq=undefined,this.blockSize=16,this.totalItems=this.blockSize},links.CouchConnector.prototype=new links.DataConnector,links.CouchConnector.prototype.getItems=function(e,t,n,r){function f(e,t){var n=[];for(var r=e,i=e+t;r<i;r++){var o=s[r];n.push(o?o.value:undefined)}return n}var i=this,s=this.data,o=!0;for(var u=e,a=e+t;u<a;u++)if(s[u]==undefined){o=!1;break}if(o){var l=!1;l&&(this.data=[],s=this.data,o=!1)}if(!o){var c=e%this.blockSize,h=e-c,p=(t+c)%this.blockSize,d=t+c-p+(p!=0?this.blockSize:0);while(s[h]&&d>0)h++,d--;while(s[h+d-1]&&d>0)d--;var v=undefined,m=h-1;while(m>0&&s[m]==undefined)m--;s[m]&&(v=s[m].key);var g=this.url.indexOf("?")==-1?"?":"&",y;v?y=this.url+g+"skip="+(h-m)+"&limit="+d+"&startkey="+escape(JSON.stringify(v)):(y=this.url+g+"skip="+h+"&limit="+d,this.filter&&(this.filter.value!=undefined&&(y+="&key="+escape(JSON.stringify(this.filter.value))),this.filter.startValue!=undefined&&(y+="&startkey="+escape(JSON.stringify(this.filter.startValue))),this.filter.endValue!=undefined&&(y+="&endkey="+escape(JSON.stringify(this.filter.endValue))))),links.getJSONP(y,function(o){if(o.error){r(o);return}var u=o.rows,a=[];for(var l=0,c=u.length;l<c;l++)s[l+h]=u[l];i.totalItems=Math.min(i.data.length+i.blockSize,o.total_rows);var a=f(e,t);n({totalItems:i.totalItems,items:a})},r)}else{var b=f(e,t);n({totalItems:i.totalItems,items:b})}},links.CouchConnector.prototype._getUpdateSeq=function(e,t){var n=this.url.indexOf("_view");if(n==-1){t("Error: cannot get information on this view, url is no view");return}var r=this.url.substring(0,n)+"_info";links.getJSONP(r,function(n){if(data.error){t(data);return}var r=n.view_index.update_seq;e(r)},t)},links.CouchConnector.prototype.getChanges=function(e,t,n,r,i){var s=[];return r({totalItems:this.totalItems||10,items:s}),s},links.CouchConnector.prototype.setFilters=function(e){if(e.length>1)throw"CouchConnector can currently only handle one filter";e.length>0&&(this.filter=e[0])},links.getJSONP=function(e,t,n){var r="callback"+Math.round(Math.random()*1e10),i=document.createElement("script"),s=e.indexOf("?")==-1?"?":"&";i.src=e+s+"callback="+r,i.onerror=function(e){document.body.removeChild(i),delete window[r],n&&n()},i.type="text/javascript",window[r]=function(e){document.body.removeChild(i),delete window[r],t&&t(e)},document.body.appendChild(i)},links.TreeGrid.Frame.prototype.onDragStart=function(e){var t=[];for(var n=0;n<this.selection.length;n++){var r=this.selection[n],i=r.parent,s=i?i.dataConnector:undefined,o=s?s.options:undefined,u=o?o.dataTransfer:undefined,a=u?u.allowedEffect:undefined;a!=undefined&&a.toLowerCase()!="none"&&t.push(r)}if(t.length>0){var f=this.dom.dragImage;if(f){var l=t.length;f.innerHTML=l+" item"+(l!=1?"s":"")}return e.dataTransfer.setData("items",t),!0}return!1},links.TreeGrid.Frame.prototype.onDragEnd=function(e){var t=e.dataTransfer.dropEffect;if(t=="move"){var n=this,r=e.dataTransfer.getData("items"),i=r.length,s=function(){i--,i==0&&(n.unselect(),n.onResize())},o=s;for(var u=0;u<r.length;u++){var a=r[u];a.parent._removeItem(a),a.parent.dataConnector.removeItems([a.data],s,o)}}this.repaint()},links.TreeGrid.Frame.prototype.onMouseDown=function(e){e=e||window.event;var t=this.eventParams,n=e.which?e.which==1:e.button==1;if(!n&&!t.touchDown)return;var r=links.TreeGrid.getTarget(e);if(r.treeGridType&&r.treeGridType=="expand")r.grid.onExpand(),links.TreeGrid.stopPropagation(e);else if(r.treeGridType&&r.treeGridType=="action")r.item.onEvent(r.event),links.TreeGrid.stopPropagation(e);else{var i=links.TreeGrid.getItemFromTarget(r);if(i){var s=e.ctrlKey,o=e.shiftKey;this.select(i,s,o)}else this.unselect()}links.TreeGrid.preventDefault(e)},links.TreeGrid.Frame.prototype.select=function(e,t,n){var r=!1;if(n){var i=this.selection.pop(),s=e;i&&i.parent!=s.parent&&(i.unselect(),i.repaint(),i=undefined),i||(i=s);while(this.selection.length){var o=this.selection.pop();o.unselect(),o.repaint()}var u=i.parent,a=u.items.indexOf(i),f=i==s?a:u.items.indexOf(s);if(f>=a){var l=a;while(l<=f){var e=u.items[l];e.select(),e.repaint(),this.selection.unshift(e),l++}}else{var l=a;while(l>=f){var e=u.items[l];e.select(),e.repaint(),this.selection.unshift(e),l--}}}else if(t){var l=this.selection.indexOf(e);l==-1?(e.select(),e.repaint(),this.selection.push(e)):(e.unselect(),e.repaint(),this.selection.splice(l,1))}else if(!e.selected){while(this.selection.length){var o=this.selection.pop();o.unselect(),o.repaint()}e.select(),e.repaint(),this.selection.push(e)}this.trigger("select",{items:this.getSelection()})},links.TreeGrid.Frame.prototype.unselect=function(e){var t=this.selection;for(var n=0,r=t.length;n<r;n++)t[n].unselect(),t[n].repaint();this.selection=[],e==undefined&&(e=!0),e&&this.trigger("select",{items:[]})},links.TreeGrid.Frame.prototype.getSelection=function(){var e=this.selection,t=[];for(var n=0,r=e.length;n<r;n++)t.push(e[n].data);return t},links.TreeGrid.Frame.prototype.onTouchStart=function(e){var t=this.eventParams,n=this;if(t.touchDown)return;t.startClientY=e.targetTouches[0].clientY,t.currentClientY=t.startClientY,t.previousClientY=t.startClientY,t.startScrollValue=this.verticalScroll.get(),t.touchDown=!0,t.onTouchMove||(t.onTouchMove=function(e){n.onTouchMove(e)},links.TreeGrid.addEventListener(document,"touchmove",t.onTouchMove)),t.onTouchEnd||(t.onTouchEnd=function(e){n.onTouchEnd(e)},links.TreeGrid.addEventListener(document,"touchend",t.onTouchEnd))},links.TreeGrid.Frame.prototype.onTouchMove=function(e){var t=this.eventParams,n=e.targetTouches[0].clientY,r=n-t.startClientY;this.verticalScroll.set(t.startScrollValue-r),this.onResize(),t.previousClientY=t.currentClientY,t.currentClientY=n,this.trigger("rangechange",undefined),links.TreeGrid.preventDefault(e)},links.TreeGrid.Frame.prototype.onTouchEnd=function(e){var t=this.eventParams,n=this;t.touchDown=!1;var r=t.currentClientY-t.startClientY,i=t.currentClientY-t.previousClientY,s=function(){t.touchDown||(n.verticalScroll.set(t.startScrollValue-r),n.onRangeChange(),r+=i,i*=.8,Math.abs(i)>1&&setTimeout(s,50))};s(),this.trigger("rangechanged",undefined),t.onTouchMove&&(links.TreeGrid.removeEventListener(document,"touchmove",t.onTouchMove),delete t.onTouchMove),t.onTouchEnd&&(links.TreeGrid.removeEventListener(document,"touchend",t.onTouchEnd),delete t.onTouchEnd),links.TreeGrid.preventDefault(e)},links.TreeGrid.Frame.prototype.onMouseWheel=function(e){e||(e=window.event);var t=0;e.wheelDelta?t=e.wheelDelta/120:e.detail&&(t=-e.detail/3),t&&(this.verticalScroll.increase(-t*50),this.onRangeChange(),this.trigger("rangechanged",undefined)),links.TreeGrid.preventDefault(e)},links.TreeGrid.prototype.trigger=function(e,t){links.events.trigger(this,e,t),google&&google.visualization&&google.visualization.events&&google.visualization.events.trigger(this,e,t)},links.dnd=function(){function l(){return n!=undefined}function c(t,n){var r={element:t};n&&links.TreeGrid.extend(r,n),e.push(r);var i=function(e){e=e||window.event;var t=e.which?e.which==1:e.button==1;if(!t)return;u=function(e){l()||v(e,r),m(e),S(e)},b(document,"mousemove",u),a=function(e){l()&&g(e),u&&(w(document,"mousemove",u),u=undefined),a&&(w(document,"mouseup",a),a=undefined),S(e)},b(document,"mouseup",a),S(e)};b(t,"mousedown",i),r.mouseDown=i}function h(e,n){var r={element:e,mouseOver:!1};n&&links.TreeGrid.extend(r,n),r.dropEffect||(r.dropEffect="link"),t.push(r)}function p(t){var n=0;while(n<e.length){var r=e[n];r.element==t?(w(r.element,"mousedown",r.mouseDown),e.splice(n,1)):n++}}function d(e){var n=0;while(n<t.length)t[n].element==e?t.splice(n,1):n++}function v(e,t){if(n)return;n=t;var u=!0;if(n.dragStart){var a={};o={dataTransfer:{dragArea:n.element,dropArea:undefined,data:a,getData:function(e){return a[e]},setData:function(e,t){a[e]=t},clearData:function(e){delete a[e]}},clientX:e.clientX,clientY:e.clientY};var l=n.dragStart(o);u=l!==!1}if(!u){n=undefined;return}var c=undefined;r=document.createElement("div"),r.style.position="absolute",typeof n.dragImage=="string"?(r.innerHTML=n.dragImage,i=-n.dragImageOffsetX||0,s=-n.dragImageOffsetY||0):n.dragImage?(r.appendChild(n.dragImage),i=-n.dragImageOffsetX||0,s=-n.dragImageOffsetY||0):(c=n.element.cloneNode(!0),i=(e.clientX||0)-x(n.element),s=(e.clientY||0)-T(n.element),c.style.left="0px",c.style.top="0px",c.style.opacity="0.7",c.style.filter="alpha(opacity=70)",r.appendChild(c)),document.body.appendChild(r),f==undefined&&(f=document.body.style.cursor),document.body.style.cursor="move"}function m(e){if(!r)return;r&&(r.style.left=e.clientX-i+"px",r.style.top=e.clientY-s+"px"),o.clientX=e.clientX,o.clientY=e.clientY;var u=e.clientX-i,a=e.clientY-s,f=r.clientWidth||n.element.clientWidth,l=r.clientHeight||n.element.clientHeight,c=u+f/2,h=a+l/2,p=undefined;for(var d=0;d<t.length;d++){var v=t[d],u=x(v.element),a=T(v.element),f=v.element.clientWidth,l=v.element.clientHeight;c>u&&c<u+f&&h>a&&h<a+l&&!p&&y(n.effectAllowed,v.dropEffect)?(p=v,v.mouseOver||(v.dragEnter&&(o.dataTransfer.dropArea=v,o.dataTransfer.dropEffect=undefined,v.dragEnter(o)),v.mouseOver=!0)):v.mouseOver&&(v.dragLeave&&(o.dataTransfer.dropArea=v,o.dataTransfer.dropEffect=undefined,v.dragLeave(o)),v.mouseOver=!1)}p?(o.dataTransfer.dropArea=p.element,o.dataTransfer.dropEffect=y(n.effectAllowed,p.dropEffect),p.dragOver&&p.dragOver(o)):(o.dataTransfer.dropArea=undefined,o.dataTransfer.dropEffect=undefined),n.drag&&n.drag(o)}function g(e){r&&r.parentNode&&r.parentNode.removeChild(r),r=undefined,document.body.style.cursor=f||"",f=undefined;var i=undefined;for(var s=0;s<t.length;s++){var u=t[s];u.mouseOver&&(u.dragLeave&&u.dragLeave(o),u.mouseOver=!1,i||(i=u))}i?(o.dataTransfer.dropArea=i.element,o.dataTransfer.dropEffect=y(n.effectAllowed,i.dropEffect),o.dataTransfer.dropEffect&&i.drop&&i.drop(o)):(o.dataTransfer.dropArea=undefined,o.dataTransfer.dropEffect=undefined),n.dragEnd&&n.dragEnd(o),n=undefined,o={}}function y(e,t){return!t||t=="none"?undefined:!e||e.toLowerCase()=="all"?t:e.toLowerCase().indexOf(t.toLowerCase())!=-1?t:undefined}function b(e,t,n,r){e.addEventListener?(r===undefined&&(r=!1),t==="mousewheel"&&navigator.userAgent.indexOf("Firefox")>=0&&(t="DOMMouseScroll"),e.addEventListener(t,n,r)):e.attachEvent("on"+t,n)}function w(e,t,n,r){e.removeEventListener?(r===undefined&&(r=!1),t==="mousewheel"&&navigator.userAgent.indexOf("Firefox")>=0&&(t="DOMMouseScroll"),e.removeEventListener(t,n,r)):e.detachEvent("on"+t,n)}function E(e){e||(e=window.event),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function S(e){e||(e=window.event),e.preventDefault?e.preventDefault():e.returnValue=!1}function x(e){var t=0;while(e!=null)t+=e.offsetLeft,e=e.offsetParent;return t}function T(e){var t=0;while(e!=null)t+=e.offsetTop,e=e.offsetParent;return t}var e=[],t=[],n=undefined,r=undefined,i=0,s=0,o={},u=undefined,a=undefined,f=undefined;return{makeDraggable:c,makeDroppable:h,removeDraggable:p,removeDroppable:d}}(),links.events=links.events||{listeners:[],indexOf:function(e){var t=this.listeners;for(var n=0,r=this.listeners.length;n<r;n++){var i=t[n];if(i&&i.object==e)return n}return-1},addListener:function(e,t,n){var r=this.indexOf(e),i=this.listeners[r];i||(i={object:e,events:{}},this.listeners.push(i));var s=i.events[t];s||(s=[],i.events[t]=s),s.indexOf(n)==-1&&s.push(n)},removeListener:function(e,t,n){var r=this.indexOf(e),i=this.listeners[r];if(i){var s=i.events[t];if(s){var o=s.indexOf(n);o!=-1&&s.splice(o,1),s.length==0&&delete i.events[t]}var u=0,a=i.events;for(var f in a)a.hasOwnProperty(f)&&u++;u==0&&delete this.listeners[r]}},removeAllListeners:function(){this.listeners=[]},trigger:function(e,t,n){var r=this.indexOf(e),i=this.listeners[r];if(i){var s=i.events[t];if(s)for(var o=0,u=s.length;o<u;o++)s[o](n)}}},links.TreeGrid.addEventListener=function(e,t,n,r){e.addEventListener?(r===undefined&&(r=!1),t==="mousewheel"&&navigator.userAgent.indexOf("Firefox")>=0&&(t="DOMMouseScroll"),e.addEventListener(t,n,r)):e.attachEvent("on"+t,n)},links.TreeGrid.removeEventListener=function(e,t,n,r){e.removeEventListener?(r===undefined&&(r=!1),t==="mousewheel"&&navigator.userAgent.indexOf("Firefox")>=0&&(t="DOMMouseScroll"),e.removeEventListener(t,n,r)):e.detachEvent("on"+t,n)},links.TreeGrid.getTarget=function(e){e||(e=window.event);var t;return e.target?t=e.target:e.srcElement&&(t=e.srcElement),t.nodeType!==undefined&&t.nodeType==3&&(t=t.parentNode),t},links.TreeGrid.getItemFromTarget=function(e){var t=e;while(t){if(t.treeGridType=="item"&&t.item)return t.item;t=t.parentElement}return undefined},links.TreeGrid.stopPropagation=function(e){e||(e=window.event),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0},links.TreeGrid.preventDefault=function(e){e||(e=window.event),e.preventDefault?e.preventDefault():e.returnValue=!1};