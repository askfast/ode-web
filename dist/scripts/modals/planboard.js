define(["services/services"],function(e){e.factory("Planboard",["$rootScope","$resource","$q","$filter","$config","Log","StandBy","Store",function(e,t,n,r,i,s,o,u){var a=t(),f=function(){var t=new Date,n=e.app.config.planboard.duration;return{start:Math.floor(new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0)/1e3),middle:Math.floor(new Date(t.getFullYear(),t.getMonth(),t.getDate()+n/2,0,0,0)/1e3),end:Math.floor(new Date(t.getFullYear(),t.getMonth(),t.getDate()+n,0,0,0)/1e3)}}(),l=function(e){var t=function(e){var t;_.each(["start","end"],function(n){_.isUndefined(e[n])||(t=Math.floor(e[n]*1e3),e[n]={_stamp:e[n],stamp:t,"short":r("date")(t,"short"),fullDate:r("date")(t,"fullDate")})});if(e.hasOwnProperty("wish")&&e.hasOwnProperty("diff")){var n=e.wish+e.diff,i=function(){var t;return n<e.wish?t="Less":n>e.wish?t="More":t="Even",t}();_.assign(e,{current:n,state:i})}};return _.isArray(e)?_.each(e,function(e){t(e)}):_.each(e,function(e){_.each(e,function(e){t(e)})}),e};return a.prototype.availability=function(e){var t=n.defer(),r={second:e,start:f.start,end:f.end};try{o._("availability",r).then(function(n){l(n),u("planboard").save("availability."+e,n),t.resolve(n)})}catch(i){s.error("Something went wrong with getting the availability call for:",e,i)}return t.promise},a.prototype.availabilities=function(){var t=n.defer(),r=[],i={},a=u("network").get("unique");e.missioned(a.length);try{_.each(a,function(t){r.push(o._("availability",{second:t.uuid,start:f.start,end:f.end}).then(function(n){e.ticked(),l(n),u("planboard").save("member."+t.uuid,n),i[t.uuid]=n}))}),n.all(r).then(function(){u("planboard").save("availabilities",i),t.resolve(i)}.bind(i))}catch(c){s.error("Something went wrong with getting member availabilities call:",c)}return t.promise},a.prototype.current=function(e){var t=u("planboard").get("member."+e),n;if(_.isUndefined(t[0]))n={text:"Empty planning."};else{var r=Date.now();n=_.assign(t[0],{current:t[0].start.stamp<=r&&t[0].end.stamp>=r})}return n},a.prototype.split=function(e){var t={today:_.filter(e,function(e){return e.end.stamp<f.middle}),tomorrow:[]}},a.prototype.cluster=function(e){var t=n.defer();try{o._("cluster",{second:e,start:f.start,end:f.end}).then(function(n){l(n),u("planboard").save("cluster."+e,n),t.resolve(n)})}catch(r){s.error("Something went wrong with getting clusters call for group:",e,r)}return t.promise},a.prototype.clusters=function(){var t=n.defer(),r=[],i={},a=u("network").get("groups");e.missioned(a.length);try{_.each(a,function(t){r.push(o._("cluster",{second:t.uuid,start:f.start,end:f.end}).then(function(n){e.ticked(),l(n),u("planboard").save("cluster."+t.uuid,n),i[t.uuid]=n}))}),n.all(r).then(function(){u("planboard").save("clusters",i),t.resolve(i)}.bind(i))}catch(c){s.error("Something went wrong with getting group clusters call:",c)}return t.promise},new a}])});