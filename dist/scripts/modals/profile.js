define(["services/services","config"],function(e,t){e.factory("Profile",["$rootScope","$resource","$q","Groups","Slots","MD5","Store",function(e,n,r,i,s,o,u){var a=n(t.host+"/node/:id/:section",{},{get:{method:"GET",params:{id:"",section:"resource"}},save:{method:"PUT",params:{section:"resource"}},remove:{method:"DELETE",params:{},isArray:!0},role:{method:"PUT",params:{section:"role"},isArray:!0},membership:{method:"PUT",params:{id:"",section:"membership"},isArray:!0}}),f=n(t.host+"/register",{direct:"true",module:"default"},{profile:{method:"GET",params:{uuid:"",pass:"",name:"",phone:""},isArray:!0}}),l=n(t.host+"/user_exists",{},{check:{method:"GET",params:{username:""}}}),c=n(t.host+"/node/:id/pincode_exists",{},{check:{method:"GET",params:{}}}),h=n(t.host+"/resources",{},{get:{method:"GET",params:{}},save:{method:"POST",params:{},isArray:!0}});return a.prototype.register=function(t){var n=r.defer(),s=t.username.toLowerCase();return f.profile({uuid:s,pass:o(t.password),name:String(t.firstName+" "+t.lastName),phone:t.PhoneAddress||""},function(o){a.prototype.role(s,t.role.id).then(function(u){a.prototype.save(s,{firstName:t.firstName,lastName:t.lastName,EmailAddress:t.EmailAddress,PostAddress:t.PostAddress,PostZip:t.PostZip,PostCity:t.PostCity}).then(function(a){var f=[];_.each(t.groups,function(e){f.push(i.addMember({id:s,group:e}))}),r.all(f).then(function(t){n.resolve({registered:e.StandBy.config.profile.smartAlarm?o[0]:o,roled:u,resourced:a,grouped:t})})})})},function(e){n.resolve({error:e})}),n.promise},a.prototype.userExists=function(e){var t=r.defer();return(e!=""||e.length>0)&&l.check({username:e},function(){t.resolve(!0)},function(){t.resolve(!1)}),t.promise},a.prototype.pincodeExists=function(e,t){var n=r.defer();return(t!=""||t.length>0)&&c.check({id:e,pincode:t},function(){n.resolve(!0)},function(){n.resolve(!1)}),n.promise},a.prototype.role=function(e,t){var n=r.defer();return a.role({id:e},t,function(e){n.resolve(e)},function(e){n.resolve({error:e})}),n.promise},a.prototype.changePassword=function(e){var t=r.defer();return h.save(null,{askPass:o(e.new1)},function(e){t.resolve(e)},function(e){t.resolve({error:e})}),t.promise},a.prototype.membership=function(e,t){var n=r.defer();return a.membership({id:e},t,function(e){n.resolve(e)},function(e){n.resolve({error:e})}),n.promise},a.prototype.get=function(t,n){var i=r.defer();return a.get({id:t},function(r){r.role=r.role||r.role==0?r.role:3,t==e.StandBy.resources.uuid&&(e.StandBy.resources=r),n&&u("user").save("resources",r),i.resolve({resources:r})}),i.promise},a.prototype.getWithSlots=function(e,t,n){var i=r.defer();return a.prototype.get(e,t).then(function(t){s.user({user:e,start:n.start,end:n.end}).then(function(e){i.resolve(angular.extend(t,{slots:e,synced:(new Date).getTime(),periods:{start:n.start*1e3,end:n.end*1e3}}))})}),i.promise},a.prototype.getSlots=function(e,t){var n=r.defer();return s.user({user:e,start:t.start/1e3,end:t.end/1e3}).then(function(e){n.resolve({slots:e,synced:(new Date).getTime(),periods:{start:t.start,end:t.end}})}),n.promise},a.prototype.local=function(){return u("user").get("resources")},a.prototype.save=function(e,t){var n=r.defer();return t.firstName!=undefined&&t.lastName!=undefined&&(t.name=t.firstName+" "+t.lastName),a.save({id:e},t,function(e){n.resolve(e)},function(e){n.resolve({error:e})}),n.promise},a.prototype.remove=function(e){var t=r.defer();return a.remove({id:e},function(e){t.resolve(e)},function(e){t.resolve({error:e})}),t.promise},new a}])});